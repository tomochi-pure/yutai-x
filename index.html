<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÑ™ÂæÖ„ÇØ„É≠„Çπ„Åß‰∏ñÁïå„ÇíÊïë„ÅÜÁ≥ª„Ç≤„Éº„É†</title>
    <!-- Twemoji CDN (Êõ¥Êñ∞Áâà) -->
    <script src="https://cdn.jsdelivr.net/npm/twemoji@latest/dist/twemoji.min.js"></script>

    <!-- ========== „Éñ„É≠„ÉÉ„ÇØ1 ÂßãÁÇπ ========== -->

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            min-height: 100vh;
        }

        /* ========== „Çø„Ç§„Éà„É´ÁîªÈù¢ ========== */
        #title-screen {
            display: block;
            min-height: 100vh;
            background-color: #f5f5f5;
        }

        .main-container {
            padding: 15px;
            max-width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
        }

        .login-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
        }

        .game-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            text-align: center;
        }

        .form-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            box-sizing: border-box;
        }

        .form-row {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .form-row:last-child {
            border-bottom: none;
        }

        .form-label {
            width: 90px;
            min-width: 90px;
            font-size: 15px;
            color: #333;
            font-weight: 500;
            white-space: nowrap;
            margin-right: 8px;
        }

        .form-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            margin-right: 8px;
            background: #f5f5f5;
            color: #666;
            min-width: 0;
            box-sizing: border-box;
        }

        .save-icon {
            font-size: 18px;
        }

        .start-btn {
            width: 100%;
            background: #4caf50;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .start-btn::after {
            content: '‚ñ∂';
            font-size: 16px;
        }

        /* „Éû„Ç∑„É•„Éû„É≠„É™„É≥„ÇØ */
        .marshmallow-link {
            background: white;
            border: 2px solid #e91e63;
            color: #e91e63;
            padding: 15px;
            border-radius: 10px;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
            text-align: center;
            box-sizing: border-box;
        }

        .marshmallow-link:hover {
            background: #fce4ec;
        }

        /* ÂêçÂâçÂÖ•Âäõ„Éà„Ç∞„É´Ê©üËÉΩ */
        .toggle-icon {
            cursor: pointer;
            user-select: none;
        }

        .toggle-icon:hover {
            transform: scale(1.1);
        }

        /* ÊÉÖÂ†±„Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */
        .info-tab-navigation {
            display: flex;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px 8px 0 0;
            margin-top: 20px;
        }

        .info-tab-button {
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: bold;
        }

        .info-tab-button.active {
            color: #2196f3;
            border-bottom-color: #2196f3;
            background: #f8f9fa;
        }

        .info-tab-button:hover {
            background: #f0f0f0;
        }

        /* ÊÉÖÂ†±„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ */
        .info-tab-content-container {
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            min-height: 400px;
        }

        .info-tab-content {
            display: none;
            padding: 20px;
        }

        .info-tab-content.active {
            display: block;
        }

        /* noteÂüã„ÇÅËæº„ÅøË™øÊï¥ */
        .note-container {
            margin-top: 0;
        }

        .note-container iframe {
            width: 100%;
            border-radius: 8px;
        }

        /* „É©„É≥„Ç≠„É≥„Ç∞Ë°®Á§∫ */
        .ranking-container {
            text-align: center;
        }

        .ranking-title {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ranking-item {
            display: grid;
            grid-template-columns: 60px 1fr 100px;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
        }

        .ranking-item.rank-1 {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            font-weight: bold;
            color: #333;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }

        .rank {
            font-weight: bold;
            color: #666;
        }

        .rank-1 .rank {
            color: #333;
        }

        .player-name {
            text-align: left;
            font-weight: 500;
        }

        .score {
            text-align: right;
            font-weight: bold;
            color: #4caf50;
        }

        .rank-1 .score {
            color: #333;
        }

        /* ========== „É°„Ç§„É≥„Ç≤„Éº„É†ÁîªÈù¢ ========== */
        #game-screen {
            display: none;
            min-height: 100vh;
            background-color: #f0f0f0;
            padding: 0;
            box-sizing: border-box;
        }

        .game-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f0f0f0;
        }

        /* ‰∏äÈÉ®„Éò„ÉÉ„ÉÄ„Éº */
        .game-header {
            background: #f0f0f0;
            padding: 10px 15px;
            display: grid;
            grid-template-columns: 2fr 3fr;
            gap: 10px;
            align-items: center;
            color: #333;
            font-weight: bold;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
        }

        .username-display {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .user-id-display {
            font-size: 12px;
            color: #666;
            font-weight: normal;
        }

        .header-right {
            display: grid;
            grid-template-rows: 1fr 1fr 1fr;
            grid-template-columns: 1fr;
            font-size: 11px;
            line-height: 1.3;
            gap: 2px;
        }

        .header-row-1 {
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        .header-row-2,
        .header-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            align-items: center;
        }

        .cash-amount,
        .premium-coin,
        .rice-amount,
        .favo-amount,
        .follower-amount {
            color: #333;
            font-weight: bold;
            text-align: right;
        }

        /* „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */
        .tab-navigation {
            display: flex;
            background: white;
            border-bottom: 1px solid #ddd;
        }

        .tab-button {
            flex: 1;
            padding: 10px 5px;
            border: none;
            background: white;
            color: #666;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-button.active {
            background: #87ceeb;
            color: white;
            font-weight: bold;
        }

        .tab-button:hover:not(.active) {
            background: #f0f0f0;
        }

        /* „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ */
        #tab-content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .tab-content {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .tab-content.active {
            display: flex;
        }

        /* Ê†™Ê≥®Êñá„Çø„ÉñÂ∞ÇÁî®„Çπ„Çø„Ç§„É´ */
        .server-hp-container {
            background: white;
            padding: 8px 15px;
            border-bottom: 1px solid #ddd;
        }

        .server-hp-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .server-hp-bar {
            width: 100%;
            height: 15px;
            background: #e0e0e0;
            border-radius: 7px;
            overflow: hidden;
            position: relative;
        }

        .server-hp-fill {
            height: 100%;
            transition: width 0.3s ease, background 0.3s ease;
        }

        .server-hp-fill.high {
            background: linear-gradient(90deg, #4caf50, #8bc34a);
        }

        .server-hp-fill.medium {
            background: linear-gradient(90deg, #ff9800, #ffc107);
        }

        .server-hp-fill.low {
            background: linear-gradient(90deg, #f44336, #e57373);
        }

        .main-game-area {
            flex: 1;
            background: white;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .center-area {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }

        .main-order-btn {
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 20px 40px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            z-index: 1000;
            position: relative;
        }

        .main-order-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        /* „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÊºîÂá∫ */
        .result-popup {
            position: absolute;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            pointer-events: none;
            z-index: 999;
            width: 200px !important;
            min-width: 200px !important;
            max-width: 200px !important;
            text-align: center;
            line-height: 1.3;
            opacity: 1;
            overflow: hidden;
            white-space: normal;
            animation: fadeOut ease-out forwards;
        }

        .result-popup.success {
            background: white;
            color: #2196f3;
            border: 2px solid #87ceeb;
        }

        .result-popup.failure {
            background: white;
            color: #e74c3c;
            border: 2px solid #e74c3c;
        }

        @keyframes fadeOut {
            0% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        .credit-margin-container {
            background: white;
            padding: 8px 15px;
            border-bottom: 1px solid #ddd;
        }

        .credit-margin-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .credit-margin-bar {
            width: 100%;
            height: 15px;
            background: #e0e0e0;
            border-radius: 7px;
            overflow: hidden;
            position: relative;
        }

        .credit-margin-fill {
            height: 100%;
            transition: width 0.3s ease, background 0.3s ease;
        }

        .credit-margin-fill.positive {
            background: linear-gradient(90deg, #87ceeb, #5dade2);
        }

        .credit-margin-fill.warning {
            background: linear-gradient(90deg, #f1c40f, #f39c12);
        }

        .credit-margin-fill.orange {
            background: linear-gradient(90deg, #e67e22, #d35400);
        }

        .credit-margin-fill.negative {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }

        .credit-margin-fill.danger {
            background: linear-gradient(90deg, #8b0000, #660000);
        }

        .credit-margin-fill.critical {
            background: linear-gradient(90deg, #2c3e50, #1a252f);
        }

        .bottom-tab-controls {
            display: grid;
            grid-template-columns: 1fr 2fr 2fr;
            gap: 8px;
            padding: 10px 15px;
            background: white;
            border-top: 1px solid #ddd;
        }

        .bottom-tab-btn {
            padding: 12px 8px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            line-height: 1.1;
            transition: all 0.2s ease;
        }

        .bottom-tab-btn.bot-adjust {
            background: white;
            color: #ff9800;
            border: 2px solid #ff9800;
        }

        .bottom-tab-btn.order-list {
            background: white;
            color: #2196f3;
            border: 2px solid #2196f3;
        }

        .bottom-tab-btn.active {
            opacity: 0.8;
            transform: translateY(1px);
        }

        .bot-toggle-btn {
            padding: 8px 6px;
            border: none;
            border-radius: 6px;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            line-height: 1;
            background: #e74c3c;
            color: white;
            transition: all 0.2s ease;
        }

        .bot-toggle-btn.active {
            background: #4caf50;
        }

        .unified-display-area {
            padding: 10px 15px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
            font-size: 12px;
        }

        .display-content {
            display: none;
        }

        .display-content.active {
            display: block;
        }

        .performance-display {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            font-size: 11px;
        }

        .order-list-layout {
            display: grid;
            grid-template-columns: 4fr 1fr;
            gap: 10px;
            align-items: center;
        }

        .status-display {
            display: grid;
            grid-template-rows: auto auto;
            gap: 8px;
        }

        .status-row-top {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .status-row-bottom {
            display: grid;
            grid-template-columns: 1fr;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #333;
        }

        .status-label {
            color: #666;
        }

        .status-value {
            font-weight: bold;
        }

        .gacha-area {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gacha-btn-unified {
            background: #ff5722;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px 16px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            width: 100%;
            transition: background 0.3s ease;
        }

        .gacha-btn-unified.disabled {
            background: #cccccc !important;
            cursor: not-allowed !important;
        }

        .gacha-btn-unified.yellow {
            background: #ffc107 !important;
            color: #333;
        }

        .gacha-btn-unified.apology {
            background: #87ceeb !important;
            color: white;
        }

        .gacha-btn-unified.pink {
            background: #F78FA7 !important;
            color: white;
            animation: glow-pulse 1s ease-in-out infinite alternate;
        }

        @keyframes glow-pulse {
            from {
                box-shadow: 0 2px 8px rgba(247, 143, 167, 0.4);
            }

            to {
                box-shadow: 0 4px 16px rgba(247, 143, 167, 0.8);
            }
        }

        .main-order-btn.disabled {
            background: #cccccc !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
        }

        /* „Ç¨„ÉÅ„É£ÁµêÊûú„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó */
        .gacha-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .gacha-result-popup {
            background: white;
            border-radius: 15px;
            padding: 20px;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            animation: luxuryAppear 0.6s ease forwards;
            position: relative;
        }

        @keyframes luxuryAppear {
            0% {
                opacity: 0;
                transform: scale(0.5) rotate(-5deg);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.1) rotate(2deg);
            }

            100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        .gacha-result-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: white;
            background: #87ceeb;
            margin: -20px -20px 15px -20px;
            padding: 15px 20px;
            border-radius: 15px 15px 0 0;
            position: relative;
            overflow: hidden;
        }

        .gacha-result-title::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
            animation: sparkle 2s linear infinite;
        }

        .gacha-result-section {
            margin-bottom: 12px;
        }

        .gacha-rarity-header {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .rarity-a {
            color: #ff6b35;
        }

        .rarity-b {
            color: #4ecdc4;
        }

        .rarity-c {
            color: #95a5a6;
        }

        .gacha-item-list {
            margin-left: 15px;
            font-size: 13px;
            line-height: 1.4;
        }

        .gacha-item {
            color: #555;
            margin-bottom: 3px;
        }

        .gacha-close-hint {
            text-align: center;
            font-size: 11px;
            color: #999;
            margin-top: 15px;
            border-top: 1px solid #f0f0f0;
            padding-top: 10px;
        }

        @keyframes sparkle {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* „Ç§„É≥„Éô„É≥„Éà„É™Ë°®Á§∫„Ç®„É™„Ç¢ */
        .inventory-display {
            padding: 8px 15px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            font-size: 11px;
            color: #666;
        }

        .inventory-label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }

        .inventory-list {
            line-height: 1.4;
            color: #777;
        }

        .perf-item {
            text-align: center;
        }

        .perf-icon {
            font-size: 16px;
            margin-bottom: 2px;
            display: block;
        }

        .perf-label {
            color: #666;
            margin-bottom: 2px;
        }

        .perf-value {
            font-weight: bold;
            color: #333;
        }

        .debug-controls {
            padding: 10px 15px;
            background: #f8f9fa;
            border-top: 2px solid #e74c3c;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .debug-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            color: #333;
            font-size: 11px;
            cursor: pointer;
            font-weight: bold;
        }

        .debug-btn:hover {
            background: #f0f0f0;
        }

        .debug-btn.increase {
            border-color: #e74c3c;
            color: #e74c3c;
        }

        .debug-btn.decrease {
            border-color: #27ae60;
            color: #27ae60;
        }

        .debug-btn.reset {
            border-color: #3498db;
            color: #3498db;
        }

        /* „Éü„ÉÉ„Ç∑„Éß„É≥„Çø„ÉñÂ∞ÇÁî®„Çπ„Çø„Ç§„É´ */
        .mission-tab-content {
            padding: 15px;
            background: #f0f0f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .mission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .mission-title {
            font-size: 15px;
            font-weight: normal;
            color: #666;
        }

        .refresh-btn {
            background: #87ceeb;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .refresh-btn:hover {
            background: #5dade2;
        }

        .mission-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .mission-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mission-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .mission-content {
            color: #333;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 10px;
            white-space: pre-line;
        }

        .mission-stats {
            display: flex;
            gap: 15px;
            color: #666;
            font-size: 12px;
        }

        .mission-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .loading-message {
            text-align: center;
            color: #666;
            font-size: 14px;
            padding: 20px;
        }

        .error-message {
            text-align: center;
            color: #e74c3c;
            font-size: 14px;
            padding: 20px;
        }

        /* „Éü„ÉÉ„Ç∑„Éß„É≥4Áä∂ÊÖã„ÅÆ„Çπ„Çø„Ç§„É´ */
        .mission-state-unaccepted {
            background: white;
        }

        .mission-state-progress {
            background: #e3f2fd;
        }

        .mission-state-complete {
            background: #fff3e0;
            animation: glow-pulse 2s ease-in-out infinite alternate;
        }

        @keyframes glow-pulse {
            from {
                box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
            }

            to {
                box-shadow: 0 4px 16px rgba(255, 152, 0, 0.6);
            }
        }

        .mission-state-claimed {
            background: #f5f5f5;
            opacity: 0.7;
        }

        /* „Éü„ÉÉ„Ç∑„Éß„É≥Ë©≥Á¥∞„É¨„Ç§„Ç¢„Ç¶„Éà */
        .mission-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin: 10px 0;
            font-size: 12px;
        }

        .mission-requirement {
            color: #666;
            font-weight: 500;
        }

        .mission-reward {
            color: #FF9800;
            font-weight: bold;
        }

        .mission-requirement {
            color: #4caf50;
            font-weight: bold;
        }

        /* „Éü„ÉÉ„Ç∑„Éß„É≥„Ç¢„ÇØ„Ç∑„Éß„É≥ */
        .mission-actions {
            display: grid;
            grid-template-columns: 2fr 3fr;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .mission-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mission-btn-accept {
            background: #4caf50;
            color: white;
        }

        .mission-btn-accept:hover {
            background: #45a049;
        }

        .mission-btn-claim {
            background: #ff9800;
            color: white;
        }

        .mission-btn-claim:hover {
            background: #f57c00;
        }

        .mission-btn-disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }

        .mission-time {
            background: #87ceeb;
            color: white;
            text-align: center;
            font-size: 11px;
            font-weight: 500;
            border-radius: 6px;
            padding: 8px 12px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mission-difficulty {
            color: #ff9800;
            margin-left: 5px;
        }

        /* „Éü„ÉÉ„Ç∑„Éß„É≥ÂÜÖ„Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */
        .mission-tab-navigation {
            display: flex;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px 8px 0 0;
            margin-bottom: 0;
        }

        .mission-tab-button {
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: bold;
        }

        .mission-tab-button.active {
            color: #2196f3;
            border-bottom-color: #2196f3;
            background: #f8f9fa;
        }

        .mission-tab-button:hover {
            background: #f0f0f0;
        }

        .mission-tab-content-container {
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 15px;
        }

        /* TwemojiÁµµÊñáÂ≠ó„Çµ„Ç§„Ç∫Ë™øÊï¥ */
        img.emoji {
            height: 1.2em;
            width: 1.2em;
            vertical-align: -0.1em;
        }

        /* PCË°®Á§∫ÂØæÂøú */
        @media (min-width: 768px) {
            body {
                display: flex;
                justify-content: center;
                background: #ddd;
                margin: 0;
                padding: 0;
                gap: 20px;
                align-items: flex-start;
            }

            #title-screen,
            #game-screen {
                max-width: 375px;
                width: 375px;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
                min-height: 100vh;
            }
        }

        /* ========== Ê†™‰∏ªÂÑ™ÂæÖÁã¨Á´ã„Éú„Çø„É≥Â∞ÇÁî®CSSÔºàËøΩÂä†Ôºâ ========== */
        .upgrade-button-area {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .upgrade-button {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .upgrade-button.orange {
            background: white;
            color: #ff9800;
            border-color: #ff9800;
        }

        .upgrade-button.orange:hover {
            background: #fff3e0;
        }

        .upgrade-button.orange.active {
            background: #ff9800;
            color: white;
        }

        .upgrade-button.blue {
            background: white;
            color: #87ceeb;
            border-color: #87ceeb;
        }

        .upgrade-button.blue:hover {
            background: #f0f8ff;
        }

        .upgrade-button.blue.active {
            background: #87ceeb;
            color: white;
        }

        .upgrade-content-container {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            min-height: 400px;
            padding: 0px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .upgrade-content {
            display: none;
        }

        .upgrade-content.active {
            display: block;
        }

        /* ========== „Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„ÉâUIÂ∞ÇÁî®CSS========== */
        /* ‰∏äÈÉ®Ë©≥Á¥∞„Ç´„Éº„Éâ */
        .upgrade-detail-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
            margin-bottom: 10px;
        }

        .upgrade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .upgrade-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upgrade-level {
            background: #87ceeb;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .upgrade-description {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 10px;
            height: 45px;
            overflow: hidden;
        }

        .upgrade-effect {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #87ceeb;
        }

        .upgrade-effect-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .upgrade-effect-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .upgrade-cost-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .upgrade-cost {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
        }

        .cost-value {
            font-weight: bold;
            color: #ff9800;
        }

        .upgrade-action-button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upgrade-action-button:hover {
            background: #45a049;
        }

        .upgrade-action-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        /* ‰∏ãÈÉ®ÈÅ∏Êäû„Ç∞„É™„ÉÉ„Éâ„ÄÅpadding‰∏ã„ÅÆ‰ΩôÁôΩÊ≥®ÊÑè„Å≠ */
        .upgrade-grid-container {
            background: white;
            border-radius: 10px;
            padding: 10px 10px 30px 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .grid-title {
            font-size: 14px;
            font-weight: bold;
            color: #666;
            margin-bottom: 8px;
            text-align: center;
        }

        .upgrade-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: repeat(4, 1fr);
            gap: 6px;
            height: 280px;
        }

        .upgrade-item {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
        }

        .upgrade-item:hover {
            border-color: #87ceeb;
            background: #f0f8ff;
        }

        .upgrade-item.selected {
            border-color: #87ceeb;
            background: #e3f2fd;
            box-shadow: 0 2px 8px rgba(135, 206, 235, 0.3);
        }

        .upgrade-icon-level {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 4px;
        }

        .upgrade-icon {
            font-size: 18px;
        }

        .upgrade-item-level {
            font-size: 9px;
            color: #666;
            font-weight: bold;
        }

        .upgrade-name {
            font-size: 10px;
            font-weight: bold;
            color: #333;
            line-height: 1.2;
            margin-bottom: 2px;
        }

        .upgrade-max-level {
            font-size: 8px;
            color: #999;
            font-weight: normal;
        }


        /* „Çµ„É≥„Éó„É´Ë°®Á§∫Áî®ÔºàÂæå„ÅßÂâäÈô§‰∫àÂÆöÔºâ */
        .content-sample {
            text-align: center;
            padding: 50px 20px;
            color: #666;
            font-size: 16px;
            line-height: 1.6;
        }

        .content-sample h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .content-sample p {
            margin-bottom: 10px;
        }

        /* ========== Ê±éÁî®„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Ç∑„Çπ„ÉÜ„É† CSSÔºàËøΩÂä†Ôºâ ========== */
        /* Âü∫Êú¨„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÔºàÊó¢Â≠ò„ÅÆ„Ç¨„ÉÅ„É£Áî®„ÇíÊµÅÁî®Ôºâ */
        .universal-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .universal-popup {
            background: white;
            border-radius: 15px;
            padding: 20px;
            width: 300px;
            max-width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            animation: luxuryAppear 0.6s ease forwards;
            position: relative;
            text-align: center;
        }

        .universal-popup-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: white;
            margin: -20px -20px 15px -20px;
            padding: 15px 20px;
            border-radius: 15px 15px 0 0;
            position: relative;
            overflow: hidden;
        }

        .universal-popup-title::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
            animation: sparkle 2s linear infinite;
        }

        .universal-popup-content {
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            margin-bottom: 15px;
        }

        .universal-popup-close-hint {
            text-align: center;
            font-size: 11px;
            color: #999;
            margin-top: 15px;
            border-top: 1px solid #f0f0f0;
            padding-top: 10px;
        }

        /* Ëâ≤„Éê„É™„Ç®„Éº„Ç∑„Éß„É≥ */
        .popup-gacha .universal-popup-title {
            background: #87ceeb;
            /* Ê∞¥Ëâ≤ - „Ç¨„ÉÅ„É£Áî® */
        }

        .popup-success .universal-popup-title {
            background: #4caf50;
            /* Á∑ëËâ≤ - „Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„ÉâÁî® */
        }

        .popup-error .universal-popup-title {
            background: #e74c3c;
            /* Ëµ§Ëâ≤ - „Ç®„É©„ÉºÁî® */
        }

        .popup-warning .universal-popup-title {
            background: #ff9800;
            /* „Ç™„É¨„É≥„Ç∏Ëâ≤ - „Éü„ÉÉ„Ç∑„Éß„É≥Áî® */
        }

        /* ========== „Ç¢„Ç§„ÉÜ„É†‰∏ÄË¶ß„Çø„ÉñÂ∞ÇÁî®CSSÔºàËøΩÂä†Ôºâ ========== */
        /* Ë©≥Á¥∞„Ç´„Éº„Éâ */
        .item-detail-card {
            background: white;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 0;
        }

        .item-detail-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .item-detail-emoji {
            font-size: 40px;
            min-width: 50px;
            text-align: center;
            animation: heartbeat 0.8s ease-in-out infinite;
        }

        .item-detail-emoji.glow-s {
            animation: rainbow 1s linear infinite, heartbeat 1.5s ease-in-out infinite;
        }

        .item-detail-info {
            flex: 1;
        }

        .item-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .item-detail-name {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .item-detail-rarity {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }

        .item-detail-value {
            font-size: 14px;
            color: #27ae60;
            font-weight: bold;
        }

        .item-detail-count {
            font-size: 14px;
            color: #666;
            font-weight: bold;
        }

        .item-detail-memo {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
            color: #555;
            line-height: 1.3;
            border-left: 3px solid #87ceeb;
        }

        /* „Ç¢„Ç§„ÉÜ„É†‰∏ÄË¶ß„ÅÆ„Éï„Ç£„É´„Çø */
        .filter-container {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            overflow-x: auto;
        }

        .filter-tabs {
            display: flex;
            gap: 4px;
            width: 100%;
        }

        .filter-tab {
            flex: 1;
            padding: 8px 4px;
            border: 2px solid #87ceeb;
            border-radius: 8px;
            background: white;
            color: #87ceeb;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .filter-tab.active {
            background: #87ceeb;
            color: white;
        }

        /* „Ç¢„Ç§„ÉÜ„É†„Ç∞„É™„ÉÉ„Éâ */
        .item-grid-container {
            background: white;
            padding: 15px;
            min-height: 400px;
        }

        .grid-title {
            font-size: 14px;
            font-weight: bold;
            color: #666;
            margin-bottom: 10px;
        }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
        }

        .grid-item {
            aspect-ratio: 1;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            position: relative;
        }

        /* „Ç¢„Ç§„ÉÜ„É†Áî®„É¨„Ç¢„É™„ÉÜ„Ç£Ëâ≤ÔºàÊó¢Â≠ò„ÅÆupgradeÁî®„Å®Âå∫Âà•Ôºâ */
        .item-detail-rarity.rarity-s,
        .grid-item.rarity-s {
            background: #FBB8CA;
            border-color: #FBB8CA;
            color: #333;
        }

        .item-detail-rarity.rarity-a,
        .grid-item.rarity-a {
            background: #FFE0B3;
            border-color: #FFE0B3;
            color: #333;
        }

        .item-detail-rarity.rarity-b,
        .grid-item.rarity-b {
            background: #CCE5FF;
            border-color: #CCE5FF;
            color: #333;
        }

        .item-detail-rarity.rarity-c,
        .grid-item.rarity-c {
            background: white;
            border-color: #e0e0e0;
            color: #666;
        }

        /* C„É©„É≥„ÇØ„Éê„ÉÉ„Ç∏Áî®Ë™øÊï¥ */
        .item-detail-rarity.rarity-c {
            background: #e0e0e0;
            color: #666;
        }

        .grid-item.selected {
            border-color: #333333 !important;
            border-width: 3px;
        }

        .grid-item-emoji {
            font-size: 16px;
            margin-bottom: 2px;
        }

        .grid-item-count {
            font-size: 10px;
            font-weight: bold;
        }

        .grid-item.not-owned {
            background: #e0e0e0 !important;
            border-color: #e0e0e0 !important;
            color: #999 !important;
        }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes rainbow {
            0% {
                filter: hue-rotate(0deg);
            }

            100% {
                filter: hue-rotate(360deg);
            }
        }

        @keyframes heartbeat {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        /* ========== „Éü„ÉÉ„Ç∑„Éß„É≥„Ç´„Éº„Éâ„ÅÆÁµ±‰∏Ä„É¨„Ç§„Ç¢„Ç¶„ÉàÁî®CSSÔºàËøΩÂä†Ôºâ ========== */
        /* „Ç≥„É≥„Éë„ÇØ„Éà„Éò„ÉÉ„ÉÄ„Éº */
        .mission-card-header-compact {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            padding: 0 2px;
        }

        /* „Ç¢„Éê„Çø„ÉºÔºàÂõ∫ÂÆöÂπÖÔºâ */
        .mission-avatar-small {
            font-size: 20px;
            min-width: 26px;
            width: 26px;
            text-align: center;
            flex-shrink: 0;
        }

        /* ÂêçÂâçÔºàÊú¨Êñá„Çµ„Ç§„Ç∫„Å´Ë™øÊï¥Ôºâ */
        .mission-name-small {
            font-weight: bold;
            color: #333;
            font-size: 14px;
            flex-shrink: 0;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* „Éè„É≥„Éâ„É´ */
        .mission-handle-small {
            color: #666;
            font-size: 14px;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
        }

        /* Èõ£ÊòìÂ∫¶Ôºà‰∏≠Â§ÆÊèÉ„ÅàÔºâ */
        .mission-difficulty-small {
            font-size: 14px;
            flex-shrink: 0;
            min-width: 50px;
            text-align: center;
        }

        /* Êóß„Éò„ÉÉ„ÉÄ„Éº„ÇíÁÑ°ÂäπÂåñÔºàÂøµ„ÅÆ„Åü„ÇÅÔºâ */
        .mission-card-header {
            display: none !important;
        }

        /* ÁµµÊñáÂ≠ó„Çµ„Ç§„Ç∫Áµ±‰∏ÄË™øÊï¥ */
        .mission-avatar-small img.emoji {
            height: 20px;
            /* 18px ‚Üí 20px */
            width: 20px;
        }
    </style>
</head>

<!-- ========== „Éñ„É≠„ÉÉ„ÇØ1 ÁµÇÁÇπ ========== -->

<!-- ========== „Éñ„É≠„ÉÉ„ÇØ2 ÂßãÁÇπ ========== -->

<body>
    <!-- ========== „Çø„Ç§„Éà„É´ÁîªÈù¢ ========== -->
    <div id="title-screen">
        <div class="main-container">
            <div class="login-header">
                <div class="game-title">Yutai-X simulation</div>
            </div>

            <div class="form-container">
                <div class="form-row">
                    <div class="form-label">„Éê„Éº„Ç∏„Éß„É≥</div>
                    <input type="text" class="form-input" value="Beta Edition ver0.20" disabled>
                    <span class="save-icon">‚úÖ</span>
                </div>

                <div class="form-row">
                    <div class="form-label">„É¶„Éº„Ç∂„ÉºID</div>
                    <input type="text" class="form-input" value="tomochi-fun" disabled>
                    <span class="save-icon">üíæ</span>
                </div>

                <div class="form-row">
                    <div class="form-label">„ÅäÂêçÂâç</div>
                    <input type="text" class="form-input" id="name-input" placeholder="„ÅäÂêçÂâçÔºà‰ªªÊÑèÔºâ" maxlength="10">
                    <span class="save-icon toggle-icon" id="name-toggle">üìù</span>
                </div>

                <button class="start-btn" id="start-button">„Ç≤„Éº„É†ÈñãÂßã</button>
            </div>

            <div class="marshmallow-link" id="marshmallow-link">
                ü©∑ÈñãÁô∫ËÄÖ„Å´ÊÑõ„ÅÆ„Éû„Ç∑„É•„Éû„É≠„ÇíË¥à„Çãü©∑
            </div>

            <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
            <div class="info-tab-navigation">
                <button class="info-tab-button active" data-info-tab="news">„ÅäÁü•„Çâ„ÅõüìÑ</button>
                <button class="info-tab-button" data-info-tab="ranking">„É©„É≥„Ç≠„É≥„Ç∞üëë</button>
            </div>

            <!-- „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
            <div class="info-tab-content-container">
                <!-- „ÅäÁü•„Çâ„Åõ„Çø„Éñ -->
                <div class="info-tab-content active" id="info-tab-news">
                    <!-- noteÂüã„ÇÅËæº„Åø -->
                    <div class="note-container">
                        <iframe class="note-embed" src="https://note.com/embed/notes/n824e5412f6bf"
                            style="border: 0; display: block; max-width: 100%; width: 100%; padding: 0px; margin: 10px 0px; position: static; visibility: visible;"
                            height="400"></iframe>
                    </div>
                </div>

                <!-- „É©„É≥„Ç≠„É≥„Ç∞„Çø„Éñ -->
                <div class="info-tab-content" id="info-tab-ranking">
                    <div class="ranking-container">
                        <h3 class="ranking-title">üèÜ ÂÖ®ÂõΩ„É©„É≥„Ç≠„É≥„Ç∞</h3>
                        <div class="ranking-list">
                            <div class="ranking-item rank-1">
                                <span class="rank">1‰Ωç</span>
                                <span class="player-name">„ÅÇ„Å™„Åü</span>
                                <span class="score">1,250,000,000ÂÜÜ</span>
                            </div>
                            <div class="ranking-item">
                                <span class="rank">2‰Ωç</span>
                                <span class="player-name">ÂÑ™ÂæÖ„Éû„Çπ„Çø„Éº</span>
                                <span class="score">980,000,000ÂÜÜ</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== „É°„Ç§„É≥„Ç≤„Éº„É†ÁîªÈù¢ ========== -->
    <div id="game-screen">
        <div class="game-container">
            <!-- ‰∏äÈÉ®„Éò„ÉÉ„ÉÄ„Éº -->
            <div class="game-header">
                <div class="header-left">
                    <div class="username-display" id="header-username">„Å®„ÇÇ„Å°„ÅÉ„Åï„Çì</div>
                    <div class="user-id-display" id="header-userid">tomochi-fun</div>
                </div>
                <div class="header-right">
                    <div class="header-row-1">
                        <div class="cash-amount">
                            ÁèæÈáëüí¥<span id="header-cash">10,000,000</span>ÂÜÜ
                        </div>
                    </div>
                    <div class="header-row-2">
                        <div class="rice-amount">
                            „ÅäÁ±≥üçô<span id="header-rice">0</span>kg
                        </div>
                        <div class="premium-coin">
                            PTCü™ô<span id="header-premium">450</span>Êûö
                        </div>
                    </div>
                    <div class="header-row-3">
                        <div class="favo-amount">
                            „ÅØ„ÅÅ„Å®üíï<span id="header-favo">0</span>‰ª∂
                        </div>
                        <div class="follower-amount">
                            Ë≠∞Ê±∫Ê®©üìú<span id="header-voting">0</span>ÂÄã
                        </div>
                    </div>
                </div>
            </div>

            <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
            <nav class="tab-navigation">
                <button class="tab-button active" data-tab="stocks">Ê†™Ê≥®Êñá</button>
                <button class="tab-button" data-tab="bot">Ê†™‰∏ªÂÑ™ÂæÖ</button>
                <button class="tab-button" data-tab="mission">SNS</button>
                <button class="tab-button" data-tab="yuutai">ÂÆüÁ∏æ</button>
                <button class="tab-button" data-tab="settings">Ë®≠ÂÆö</button>
            </nav>

            <!-- „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ -->
            <div id="tab-content-area">
                <!-- Ê†™Ê≥®Êñá„Çø„Éñ„ÅÆÂÜÖÂÆπ -->
                <div id="stocks-content" class="tab-content active">
                    <!-- „Çµ„Éº„Éê„ÉºHP„Éê„Éº -->
                    <div class="server-hp-container">
                        <div class="server-hp-label">„Çµ„Éº„Éê„ÉºHP</div>
                        <div class="server-hp-bar">
                            <div class="server-hp-fill" id="server-hp-fill"></div>
                        </div>
                    </div>

                    <!-- „É°„Ç§„É≥„Ç≤„Éº„É†„Ç®„É™„Ç¢ -->
                    <div class="main-game-area">
                        <!-- ‰∏≠Â§Æ„Ç®„É™„Ç¢ÔºàÊ≥®Êñá„Éú„Çø„É≥ + „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ôºâ -->
                        <div class="center-area" id="center-area">
                            <button class="main-order-btn" id="main-order-button">Ê≥®ÊñáÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç</button>
                        </div>
                    </div>

                    <!-- ‰ø°Áî®Âª∫„Å¶‰ΩôÂäõ„Éê„Éº -->
                    <div class="credit-margin-container">
                        <div class="credit-margin-label" id="credit-margin-label">‰ø°Áî®Âª∫„Å¶‰ΩôÂäõÔºö100%</div>
                        <div class="credit-margin-bar">
                            <div class="credit-margin-fill" id="credit-margin-fill"></div>
                        </div>
                    </div>

                    <!-- ‰∏ãÈÉ®„Çø„Éñ„Éú„Çø„É≥„Ç®„É™„Ç¢ -->
                    <div class="bottom-tab-controls">
                        <button class="bot-toggle-btn" id="bot-toggle">
                            BOT<br>OFF
                        </button>
                        <button class="bottom-tab-btn bot-adjust" id="bot-adjust-tab">
                            BOTË™øÊï¥
                        </button>
                        <button class="bottom-tab-btn order-list active" id="order-list-tab">
                            Ê≥®ÊñáÁ¥ÑÂÆö‰∏ÄË¶ß
                        </button>
                    </div>

                    <!-- Áµ±ÂêàË°®Á§∫„Ç®„É™„Ç¢ -->
                    <div class="unified-display-area">
                        <!-- BOTË™øÊï¥ÊôÇ„ÅÆ„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊåáÊ®ô -->
                        <div class="display-content" id="bot-adjust-content">
                            <div class="performance-display">
                                <div class="perf-item">
                                    <span class="perf-icon">‚ö°</span>
                                    <div class="perf-label">Cps</div>
                                    <div class="perf-value" id="perf-cps">34Âõû/Áßí</div>
                                </div>
                                <div class="perf-item">
                                    <span class="perf-icon">üéØ</span>
                                    <div class="perf-label">„Ç≤„ÉÉ„ÉàÁéá</div>
                                    <div class="perf-value" id="perf-get-rate">3.4ÂÄç</div>
                                </div>
                                <div class="perf-item">
                                    <span class="perf-icon">üöõ</span>
                                    <div class="perf-label">Á©çËºâÁéá</div>
                                    <div class="perf-value" id="perf-load-rate">430%</div>
                                </div>
                                <div class="perf-item">
                                    <span class="perf-icon">üî•</span>
                                    <div class="perf-label">ÂßîË®óÁéá</div>
                                    <div class="perf-value" id="perf-fire-rate">24%</div>
                                </div>
                            </div>
                        </div>

                        <!-- Ê≥®ÊñáÁ¥ÑÂÆö‰∏ÄË¶ßÊôÇ„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ + ÁèæÂºï„Åç„Éú„Çø„É≥ -->
                        <div class="display-content active" id="order-list-content">
                            <div class="order-list-layout">
                                <div class="status-display">
                                    <!-- ‰∏äÊÆµÔºö2Âàó -->
                                    <div class="status-row-top">
                                        <div class="status-item">
                                            <span class="status-label">Ê≥®Êñá‰ª∂Êï∞</span>
                                            <span class="status-value" id="status-orders">0‰ª∂</span>
                                        </div>
                                        <div class="status-item">
                                            <span class="status-label">Á∑è„Ç¢„ÇØ„Çª„ÇπÊï∞</span>
                                            <span class="status-value" id="status-credit-margin">0Âõû</span>
                                        </div>
                                    </div>
                                    <!-- ‰∏ãÊÆµÔºö1Âàó -->
                                    <div class="status-row-bottom">
                                        <div class="status-item">
                                            <span class="status-label">Âª∫ÁéâÈáëÈ°ç</span>
                                            <span class="status-value" id="status-position">0ÂÜÜ</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="gacha-area">
                                    <button class="gacha-btn-unified" id="gacha-button">
                                        ÁèæÂºï„Åç
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- „Éá„Éê„ÉÉ„Ç∞„Éú„Çø„É≥„Ç®„É™„Ç¢ -->
                    <div class="debug-controls">
                        <button class="debug-btn increase" id="debug-increase">Âª∫Áéâ+1000‰∏á</button>
                        <button class="debug-btn decrease" id="debug-decrease">Âª∫Áéâ-1000‰∏á</button>
                        <button class="debug-btn reset" id="debug-reset">„É™„Çª„ÉÉ„Éà</button>
                        <button class="debug-btn increase" id="debug-voting">Ë≠∞Ê±∫Ê®©+100ÂÄã</button>
                        <button class="debug-btn increase" id="debug-orders">Ê≥®Êñá‰ª∂Êï∞+10</button>
                    </div>

                </div>

                <!-- Ê†™‰∏ªÂÑ™ÂæÖ„Çø„Éñ„ÅÆÂÜÖÂÆπ -->
                <div id="bot-content" class="tab-content">
                    <div class="mission-tab-content">
                        <!-- Ê†™‰∏ªÂÑ™ÂæÖÁã¨Á´ã„Éú„Çø„É≥„Ç®„É™„Ç¢ -->
                        <div class="upgrade-button-area">
                            <button class="upgrade-button orange active" data-upgrade-content="use">ÂÑ™ÂæÖ„Çí‰Ωø„ÅÜ</button>
                            <button class="upgrade-button blue" data-upgrade-content="list">Ê†™‰∏ªÂÑ™ÂæÖ‰∏ÄË¶ß</button>
                        </div>

                        <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ -->
                        <div class="upgrade-content-container">
                            <!-- ÂÑ™ÂæÖ„Çí‰Ωø„ÅÜ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
                            <div class="upgrade-content active" id="upgrade-content-use">
                                <!-- ‰∏äÈÉ®Ë©≥Á¥∞„Ç´„Éº„Éâ -->
                                <div class="upgrade-detail-card">
                                    <div class="upgrade-header">
                                        <div class="upgrade-title">
                                            <span id="detail-icon">üéç</span>
                                            <span id="detail-name">BOTÂº∑Âåñ</span>
                                        </div>
                                        <div class="upgrade-level" id="detail-level">Lv.2 (ÊúÄÂ§ßÔºö5)</div>
                                    </div>

                                    <div class="upgrade-description" id="detail-description">
                                        BOT„ÅÆ„ÇØ„É™„ÉÉ„ÇØÈÄüÂ∫¶„ÅåÂêë‰∏ä„Åó„Åæ„Åô„ÄÇÂäπÁéáÁöÑ„Å™Âú®Â∫´Á¢∫‰øù„ÅåÂèØËÉΩ„Å´„Å™„Çä„Åæ„Åô„ÄÇ
                                    </div>

                                    <div class="upgrade-effect">
                                        <div class="upgrade-effect-label">ÂäπÊûú</div>
                                        <div class="upgrade-effect-value" id="detail-effect">2Âõû/Áßí ‚Üí 3Âõû/Áßí</div>
                                    </div>

                                    <div class="upgrade-cost-area">
                                        <div class="upgrade-cost">
                                            ÂøÖË¶Å„Ç≥„Çπ„Éà: <span class="cost-value" id="detail-cost">250</span> PTCü™ô
                                        </div>
                                        <button class="upgrade-action-button" id="upgrade-action-btn">„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ</button>
                                    </div>
                                </div>

                                <!-- ‰∏ãÈÉ®ÈÅ∏Êäû„Ç∞„É™„ÉÉ„Éâ -->
                                <div class="upgrade-grid-container">
                                    <div class="grid-title">„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ‰∏ÄË¶ß</div>
                                    <div class="upgrade-grid">
                                        <!-- 1Ë°åÁõÆ -->
                                        <div class="upgrade-item selected" data-upgrade="bot_speed">
                                            <div class="upgrade-icon-level">
                                                <div class="upgrade-icon">üéç</div>
                                                <div class="upgrade-item-level">Lv.2</div>
                                            </div>
                                            <div class="upgrade-name">BOTÂº∑Âåñ</div>
                                            <div class="upgrade-max-level">ÊúÄÂ§ßÔºö5</div>
                                        </div>

                                        <div class="upgrade-item" data-upgrade="bot_get_rate">
                                            <div class="upgrade-icon-level">
                                                <div class="upgrade-icon">üèµÔ∏è</div>
                                                <div class="upgrade-item-level">Lv.1</div>
                                            </div>
                                            <div class="upgrade-name">BOTÁç≤ÂæóÁéá</div>
                                            <div class="upgrade-max-level">ÊúÄÂ§ßÔºö5</div>
                                        </div>

                                        <div class="upgrade-item" data-upgrade="bot_damage">
                                            <div class="upgrade-icon-level">
                                                <div class="upgrade-icon">üéÑ</div>
                                                <div class="upgrade-item-level">Lv.0</div>
                                            </div>
                                            <div class="upgrade-name">BOT„ÉÄ„É°„Éº„Ç∏ËªΩÊ∏õ</div>
                                            <div class="upgrade-max-level">ÊúÄÂ§ßÔºö5</div>
                                        </div>

                                        <!-- 2Ë°åÁõÆ -->
                                        <div class="upgrade-item" data-upgrade="heart_boost">
                                            <div class="upgrade-icon-level">
                                                <div class="upgrade-icon">üê¶Ô∏è</div>
                                                <div class="upgrade-item-level">Lv.0</div>
                                            </div>
                                            <div class="upgrade-name">„ÅØ„ÅÅ„Å®„Ç¢„ÉÉ„Éó</div>
                                            <div class="upgrade-max-level">ÊúÄÂ§ßÔºö5</div>
                                        </div>

                                        <div class="upgrade-item" data-upgrade="gacha_multi">
                                            <div class="upgrade-icon-level">
                                                <div class="upgrade-icon">üè†Ô∏è</div>
                                                <div class="upgrade-item-level">Lv.0</div>
                                            </div>
                                            <div class="upgrade-name">„Ç¨„ÉÅ„É£ÂÄçÂåñ</div>
                                            <div class="upgrade-max-level">ÊúÄÂ§ßÔºö5</div>
                                        </div>

                                        <div class="upgrade-item" data-upgrade="credit_margin">
                                            <div class="upgrade-icon-level">
                                                <div class="upgrade-icon">üèß</div>
                                                <div class="upgrade-item-level">Lv.0</div>
                                            </div>
                                            <div class="upgrade-name">‰ø°Áî®‰ΩôÂäõ</div>
                                            <div class="upgrade-max-level">ÊúÄÂ§ßÔºö5</div>
                                        </div>

                                        <!-- 3Ë°åÁõÆ -->
                                        <div class="upgrade-item" data-upgrade="sato_career">
                                            <div class="upgrade-icon-level">
                                                <div class="upgrade-icon">üë®‚Äçüíº</div>
                                                <div class="upgrade-item-level">Lv.1</div>
                                            </div>
                                            <div class="upgrade-name">‰ΩêËó§ÊòáÈÄ≤</div>
                                            <div class="upgrade-max-level">ÊúÄÂ§ßÔºö5</div>
                                        </div>

                                        <div class="upgrade-item" data-upgrade="puzzle_pro">
                                            <div class="upgrade-icon-level">
                                                <div class="upgrade-icon">üß©</div>
                                                <div class="upgrade-item-level">Lv.0</div>
                                            </div>
                                            <div class="upgrade-name">„Éë„Ç∫„É´„Éó„É≠</div>
                                            <div class="upgrade-max-level">ÊúÄÂ§ßÔºö5</div>
                                        </div>

                                        <div class="upgrade-item" data-upgrade="loud_voice">
                                            <div class="upgrade-icon-level">
                                                <div class="upgrade-icon">üì¢</div>
                                                <div class="upgrade-item-level">Lv.0</div>
                                            </div>
                                            <div class="upgrade-name">„ÇØ„ÇΩ„Éá„Ç´„Éú„Ç§„Çπ</div>
                                            <div class="upgrade-max-level">ÊúÄÂ§ßÔºö5</div>
                                        </div>

                                        <!-- 4Ë°åÁõÆ -->
                                        <div class="upgrade-item" data-upgrade="god_finger">
                                            <div class="upgrade-icon-level">
                                                <div class="upgrade-icon">üñï</div>
                                                <div class="upgrade-item-level">Lv.0</div>
                                            </div>
                                            <div class="upgrade-name">Á•û„ÅÆ‰∏≠Êåá</div>
                                            <div class="upgrade-max-level">ÊúÄÂ§ßÔºö5</div>
                                        </div>

                                        <div class="upgrade-item" data-upgrade="rollover_avoid">
                                            <div class="upgrade-icon-level">
                                                <div class="upgrade-icon">üöõ</div>
                                                <div class="upgrade-item-level">Lv.0</div>
                                            </div>
                                            <div class="upgrade-name">Ê®™Ëª¢ÂõûÈÅø</div>
                                            <div class="upgrade-max-level">ÊúÄÂ§ßÔºö5</div>
                                        </div>

                                        <div class="upgrade-item" data-upgrade="god_thumb">
                                            <div class="upgrade-icon-level">
                                                <div class="upgrade-icon">üëç</div>
                                                <div class="upgrade-item-level">Lv.0</div>
                                            </div>
                                            <div class="upgrade-name">Á•û„ÅÆË¶™Êåá</div>
                                            <div class="upgrade-max-level">ÊúÄÂ§ßÔºö5</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Ê†™‰∏ªÂÑ™ÂæÖ‰∏ÄË¶ß„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
                            <div class="upgrade-content" id="upgrade-content-list">
                                <!-- ‰∏äÈÉ®ÔºöË©≥Á¥∞„Ç´„Éº„Éâ -->
                                <div class="item-detail-card">
                                    <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
                                </div>

                                <!-- ‰∏≠ÈÉ®Ôºö„Éï„Ç£„É´„Çø -->
                                <div class="filter-container">
                                    <div class="filter-tabs">
                                        <div class="filter-tab active">ÂÖ®„Å¶</div>
                                        <div class="filter-tab">QUO</div>
                                        <div class="filter-tab">ÂÑ™ÂæÖ</div>
                                        <div class="filter-tab">È£üÁ≥ß</div>
                                        <div class="filter-tab">ÈõëÂìÅ</div>
                                        <div class="filter-tab">Ë≤¥ÈáçÂìÅ</div>
                                    </div>
                                </div>

                                <!-- ‰∏ãÈÉ®Ôºö„Ç¢„Ç§„ÉÜ„É†„Ç∞„É™„ÉÉ„Éâ -->
                                <div class="item-grid-container">
                                    <div class="grid-title">ÊâÄÊåÅ„Ç¢„Ç§„ÉÜ„É†‰∏ÄË¶ß</div>
                                    <div class="item-grid" id="item-grid">
                                        <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- „Éü„ÉÉ„Ç∑„Éß„É≥„Çø„Éñ„ÅÆÂÜÖÂÆπ -->
                <div id="mission-content" class="tab-content">
                    <div class="mission-tab-content">
                        <!-- „Éü„ÉÉ„Ç∑„Éß„É≥ÂÜÖ„Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
                        <div class="mission-tab-navigation">
                            <button class="mission-tab-button active" data-mission-tab="recommend">„Ç™„Çπ„Çπ„É°</button>
                            <button class="mission-tab-button" data-mission-tab="character">„Éï„Ç©„É≠„Éº‰∏≠</button>
                        </div>

                        <!-- „Éü„ÉÉ„Ç∑„Éß„É≥ÂÜÖ„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
                        <div class="mission-tab-content-container">
                            <div class="mission-header">
                                <div class="mission-title">„ÅÑ„Åæ„Å©„ÅÜ„Åó„Å¶„ÇãÔºü</div>
                                <button class="refresh-btn" id="mission-refresh">Êõ¥Êñ∞</button>
                            </div>
                            <div class="mission-list" id="mission-list">
                                <div class="loading-message">„Éü„ÉÉ„Ç∑„Éß„É≥„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÂÆüÁ∏æ„Çø„Éñ„ÅÆÂÜÖÂÆπ -->
                <div id="yuutai-content" class="tab-content">
                    <div class="mission-tab-content">
                        ÂÆüÁ∏æ„Çø„Éñ - Ê∫ñÂÇô‰∏≠
                    </div>
                </div>

                <!-- Ë®≠ÂÆö„Çø„Éñ„ÅÆÂÜÖÂÆπ -->
                <div id="settings-content" class="tab-content">
                    <div class="mission-tab-content">
                        Ë®≠ÂÆö„Çø„Éñ - Ê∫ñÂÇô‰∏≠
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== „Éñ„É≠„ÉÉ„ÇØ2 ÁµÇÁÇπ ========== -->

    <!-- ========== „Éñ„É≠„ÉÉ„ÇØ3 ÂßãÁÇπ ========== -->

    <script>
        // ========== „Ç≤„Éº„É†Áä∂ÊÖãÁÆ°ÁêÜ ==========
        const gameState = {
            currentScreen: 'title',
            userName: '„Å®„ÇÇ„Å°„ÅÉ„Åï„Çì',
            userId: 'tomochi-fun',
            cash: 10000000,
            premiumCoin: 450000,
            rice: 0,           // „ÅäÁ±≥„Ç∑„Çπ„ÉÜ„É†
            favo: 0,           // Êñ∞Ë¶èËøΩÂä†: „ÅØ„ÅÅ„Å®„Ç∑„Çπ„ÉÜ„É†
            voting: 0,        // Ë≠∞Ê±∫Ê®©„ÅÆ‰øùÊúâÈáè
            botEnabled: false,    // botËµ∑ÂãïÁä∂ÊÖã
            botInterval: null,    // „Çø„Ç§„Éû„ÉºÁÆ°ÁêÜÁî®
            botSpeed: 1000,        // 1ÁßíÈñìÈöî
            totalClicks: 0,
            stamina: 4,
            inventory: {}      // „Ç§„É≥„Éô„É≥„Éà„É™ÂàùÊúüÂåñ
        };

        const debugState = {
            orders: 0,
            positionAmount: 0,
            initialPositionAmount: 0,
            stock: 0,
            cps: 34,
            getRate: 3.4,
            loadRate: 430,
            fireRate: 24,
            serverHP: 20,
            maxServerHP: 20,
            clickDamage: 1,
            isServerDown: false,
            isPreGacha: false,
            isRollover: false,  // Ê®™Ëª¢
            clicksSinceLastGacha: 0  // ÂâçÂõû„Ç¨„ÉÅ„É£„Åã„Çâ„ÅÆ„ÇØ„É™„ÉÉ„ÇØÊï∞
        };

        // ========== „Éü„ÉÉ„Ç∑„Éß„É≥„Ç∑„Çπ„ÉÜ„É† ==========
        let missionData = null;
        let tweetsData = null;      // tweets.json
        let missionsData = null;    // missions.json
        let normalizedMissions = []; // Ê≠£Ë¶èÂåñÊ∏à„Åø„Éü„ÉÉ„Ç∑„Éß„É≥‰∏ÄË¶ß
        let currentActiveTab = 'recommend'; // ÁèæÂú®„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çø„Éñ
        let upgradeJsonData = null;
        let upgradeProgress = {„ÄÄ„ÄÄ // ÈÄ≤ÊçóÁÆ°ÁêÜÔºà„É°„É¢„É™„ÅÆ„Åø„ÄÅ„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÅØÂæåÂõû„ÅóÔºâ
            bot_speed: 2  // ÁèæÂú®„É¨„Éô„É´
        };

        // ========== SystemTimerÊúÄÈÅ©ÂåñÁâà ==========
        const SystemTimer = {
            timer: null,
            shouldUpdateMissionUI: false,
            shouldFullRefresh: false,

            start() {
                if (this.timer) return; // ÈáçË§áÈò≤Ê≠¢

                this.timer = setInterval(() => {
                    this.updateServer();
                    this.updateMissions();
                    this.updateUI();
                }, 1000);

                console.log('„Ç∑„Çπ„ÉÜ„É†„Çø„Ç§„Éû„ÉºÈñãÂßã');
            },

            stop() {
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                    console.log('„Ç∑„Çπ„ÉÜ„É†„Çø„Ç§„Éû„ÉºÂÅúÊ≠¢');
                }
            },

            updateServer() {
                // „Çµ„Éº„Éê„ÉºHPÂõûÂæ©Âá¶ÁêÜ
                if (debugState.serverHP < debugState.maxServerHP) {
                    debugState.serverHP += 1;
                    checkServerDown();
                }
            },

            updateMissions() {
                // ÂÖ®„Éü„ÉÉ„Ç∑„Éß„É≥ÈÄ≤Ë°åÊõ¥Êñ∞
                let hasTimeUpdates = false;
                let hasCompletions = false;

                for (const missionId in missionStates) {
                    const state = missionStates[missionId];
                    if (state.state === 'progress' && state.remainingTime > 0) {
                        state.remainingTime--;
                        hasTimeUpdates = true;

                        if (state.remainingTime <= 0) {
                            // „Éü„ÉÉ„Ç∑„Éß„É≥ÂÆå‰∫Ü
                            state.state = 'complete';
                            state.remainingTime = 0;
                            hasCompletions = true;
                            console.log(`„Éü„ÉÉ„Ç∑„Éß„É≥ÂÆå‰∫Ü: ${missionId} ‚Üí completeÁä∂ÊÖã„Å´Â§âÊõ¥`);
                        }
                    }
                }

                // ÂÆå‰∫ÜÁä∂ÊÖãÂ§âÂåñ„Åå„ÅÇ„Å£„ÅüÂ†¥Âêà„ÅØÂÖ®‰ΩìÊõ¥Êñ∞
                if (hasCompletions) {
                    this.shouldFullRefresh = true;
                    console.log('ÂÆå‰∫ÜÊ§úÂá∫ - ÂÖ®‰ΩìÊõ¥Êñ∞‰∫àÁ¥Ñ');
                }
                // ÊôÇÈñìÂ§âÂåñ„ÅÆ„Åø„ÅÆÂ†¥Âêà„ÅØÈÉ®ÂàÜÊõ¥Êñ∞
                else if (hasTimeUpdates) {
                    this.shouldUpdateMissionUI = true;
                }
            },

            updateUI() {
                // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çø„Éñ„ÅÆUIÊõ¥Êñ∞
                updateDisplay(); // Êó¢Â≠ò„ÅÆ„Éò„ÉÉ„ÉÄ„ÉºÊõ¥Êñ∞

                // ÁèæÂú®„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çø„Éñ„Åå mission „ÅÆÂ†¥Âêà„ÅÆ„ÅøÂá¶ÁêÜ
                const activeTabButton = document.querySelector('.tab-button.active');
                if (activeTabButton && activeTabButton.dataset.tab === 'mission') {

                    if (this.shouldFullRefresh) {
                        // ÂÖ®‰ΩìÊõ¥Êñ∞ÔºàÂÆå‰∫ÜÊôÇÔºâ
                        console.log('ÂÖ®‰ΩìÊõ¥Êñ∞ÂÆüË°å');
                        displayCurrentTabMissions();
                        this.shouldFullRefresh = false;

                    } else if (this.shouldUpdateMissionUI) {
                        // ÈÉ®ÂàÜÊõ¥Êñ∞ÔºàÊôÇÈñìË°®Á§∫„ÅÆ„ÅøÔºâ
                        updateMissionTimeDisplays();
                        this.shouldUpdateMissionUI = false;
                    }
                }
            }
        };
        // ========== ÈÉ®ÂàÜÊõ¥Êñ∞Èñ¢Êï∞ÔºàËøΩÂä†Ôºâ ==========

        function updateMissionTimeDisplays() {
            // ÈÄ≤Ë°å‰∏≠„Éü„ÉÉ„Ç∑„Éß„É≥„ÅÆÊôÇÈñìË°®Á§∫„ÅÆ„Åø„ÇíÊõ¥Êñ∞
            for (const missionId in missionStates) {
                const state = missionStates[missionId];
                if (state.state === 'progress') {
                    const missionCard = document.querySelector(`[data-mission-id="${missionId}"]`);
                    if (missionCard) {
                        const timeElement = missionCard.querySelector('.mission-time');
                        if (timeElement) {
                            timeElement.textContent = `ÊÆã„ÇäÊôÇÈñìÔºö${state.remainingTime}Áßí`;
                            console.log(`ÊôÇÈñìÊõ¥Êñ∞: ${missionId} ‚Üí ${state.remainingTime}Áßí`);
                        }
                    }
                }
            }
        }

        // ========== Áµ±‰∏Ä„Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ„Ç∑„Çπ„ÉÜ„É† ==========
        const MissionNormalizer = {
            // fromCharacterÈñ¢Êï∞„ÅØÊó¢Â≠ò„ÅÆ„Åæ„Åæ
            fromCharacter(mission, characters, difficulties) {
                const char = characters[mission.char];
                const diff = difficulties[mission.difficulty];

                // Âü∫Êú¨Â†±ÈÖ¨ + ÂÄãÂà•„É¨„Ç¢„Ç¢„Ç§„ÉÜ„É†
                const rewards = { ...mission.rewards };
                if (mission.specialRewards) {
                    // specialRewards„Çí„Éû„Éº„Ç∏
                    Object.keys(mission.specialRewards).forEach(key => {
                        if (key === 'items') {
                            rewards.items = [
                                ...(rewards.items || []),
                                ...mission.specialRewards.items
                            ];
                        } else {
                            rewards[key] = (rewards[key] || 0) + mission.specialRewards[key];
                        }
                    });
                }

                return {
                    id: mission.id,
                    title: char.name,
                    content: mission.content,
                    duration: diff.duration,
                    requirements: mission.requirements,
                    rewards: rewards,
                    type: 'character',
                    metadata: {
                        character: char,
                        difficulty: diff.stars,
                        chapterTitle: `${char.name}„ÅÆ„Éü„ÉÉ„Ç∑„Éß„É≥`
                    }
                };
            },

            // fromStoryÈñ¢Êï∞‰øÆÊ≠£Áâà
            fromStory(chapter, story) {
                return {
                    id: chapter.id,
                    title: story.title,
                    content: chapter.content,
                    duration: chapter.duration,
                    requirements: chapter.requirements,
                    rewards: chapter.rewards,
                    type: 'story',
                    metadata: {
                        storyId: story.storyId,
                        storyTitle: story.title,
                        storyIcon: story.icon,  // ‚Üê ËøΩÂä†
                        chapterNumber: chapter.chapterNumber,
                        chapterTitle: chapter.title,
                        totalChapters: story.totalChapters,
                        unlockConditions: chapter.unlockConditions,
                        difficulty: `Á¨¨${chapter.chapterNumber}Ë©±`
                    }
                };
            }
        };

        const BotTimer = {
            timer: null,

            start() {
                if (this.timer) this.stop(); // Êó¢Â≠ò„ÇíÂÅúÊ≠¢

                this.timer = setInterval(() => {
                    if (gameState.botEnabled) {
                        handleOrderClick(true); // Êó¢Â≠ò„ÅÆÈñ¢Êï∞
                    }
                }, gameState.botSpeed);

                console.log(`BOT„Çø„Ç§„Éû„ÉºÈñãÂßã: ${gameState.botSpeed}msÈñìÈöî`);
            },

            stop() {
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                    console.log('BOT„Çø„Ç§„Éû„ÉºÂÅúÊ≠¢');
                }
            },

            restart() {
                console.log('BOT„Çø„Ç§„Éû„ÉºÂÜçËµ∑Âãï');
                this.stop();
                this.start();
            }
        };

        const GameTimerManager = {
            isInitialized: false,

            init() {
                if (this.isInitialized) return;

                console.log('„Ç≤„Éº„É†„Çø„Ç§„Éû„Éº„Éû„Éç„Éº„Ç∏„É£„ÉºÂàùÊúüÂåñ');
                SystemTimer.start();
                this.isInitialized = true;
            },

            startBot() {
                console.log('BOTÈñãÂßã');
                gameState.botEnabled = true;
                BotTimer.start();
            },

            stopBot() {
                console.log('BOTÂÅúÊ≠¢');
                gameState.botEnabled = false;
                BotTimer.stop();
            },

            updateBotSpeed(newSpeed) {
                console.log(`BOTÈÄüÂ∫¶Â§âÊõ¥: ${gameState.botSpeed}ms ‚Üí ${newSpeed}ms`);
                gameState.botSpeed = newSpeed;

                if (gameState.botEnabled) {
                    BotTimer.restart();
                }
            },

            destroy() {
                console.log('ÂÖ®„Çø„Ç§„Éû„ÉºÂÅúÊ≠¢');
                SystemTimer.stop();
                BotTimer.stop();
                this.isInitialized = false;
            }
        };

        // ========== „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çø„ÉñË°®Á§∫Êõ¥Êñ∞‰øÆÊ≠£ ==========

        function updateActiveTabDisplay() {
            // ÁèæÂú®„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çø„Éñ„ÅÆ„ÅøÊõ¥Êñ∞
            const activeTabButton = document.querySelector('.tab-button.active, .mission-tab-button.active');
            if (!activeTabButton) return;

            const tabName = activeTabButton.dataset.tab || activeTabButton.dataset.missionTab;

            // „Éü„ÉÉ„Ç∑„Éß„É≥„Çø„Éñ„ÅÆÂ†¥Âêà„ÅØÂÜÖÈÉ®„Çø„Éñ„ÇÇ„ÉÅ„Çß„ÉÉ„ÇØ
            if (tabName === 'mission') {
                updateActiveMissionTab();
            }
            // ‰ªñ„ÅÆ„Çø„Éñ„ÅØÂæå„ÅßÂÆüË£Ö
        }

        function updateActiveMissionTab() {
            // „Éü„ÉÉ„Ç∑„Éß„É≥ÂÜÖ„Çø„Éñ„ÅÆÊõ¥Êñ∞
            if (normalizedMissions.length > 0) {
                // ÈÄ≤Ë°å‰∏≠„ÅÆ„Éü„ÉÉ„Ç∑„Éß„É≥„ÅÆÊôÇÈñì„ÇíÊõ¥Êñ∞Ôºà1Áßí„Åî„Å®Ôºâ
                let needsUpdate = false;

                for (const missionId in missionStates) {
                    const state = missionStates[missionId];
                    if (state.state === 'progress') {
                        needsUpdate = true;
                        break;
                    }
                }

                // ÈÄ≤Ë°å‰∏≠„Éü„ÉÉ„Ç∑„Éß„É≥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøUIÊõ¥Êñ∞
                if (needsUpdate) {
                    displayCurrentTabMissions();
                }
            }
        }


        let currentMissionTab = 'recommend';
        let missionStates = {}; // „Éü„ÉÉ„Ç∑„Éß„É≥Áä∂ÊÖãÁÆ°ÁêÜ

        // ========== „Ç¢„Ç§„ÉÜ„É†„Ç∑„Çπ„ÉÜ„É† ==========
        let itemData = null; // items.json„Åã„ÇâË™≠„ÅøËæº„Çì„Å†„Éá„Éº„Çø

        // ========== „Ç¨„ÉÅ„É£„Ç∑„Çπ„ÉÜ„É† ==========
        let gachaData = null; // gacha.json„Åã„ÇâË™≠„ÅøËæº„Çì„Å†„Éá„Éº„Çø

        // ========== Twemoji Â§âÊèõ„Ç∑„Çπ„ÉÜ„É† ==========
        function convertEmojis(element = document.body) {
            if (typeof twemoji !== 'undefined') {
                twemoji.parse(element, {
                    folder: 'svg',
                    ext: '.svg',
                    base: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/'
                });
            }
        }

        // ========== „Ç¢„Ç§„ÉÜ„É†Ê§úÁ¥¢„Éò„É´„Éë„ÉºÈñ¢Êï∞ ==========
        function findItemById(itemId) {
            if (!itemData || !itemData.items) return null;
            return itemData.items.find(item => item.id === itemId);
        }

        // ========== „Ç¢„Ç§„ÉÜ„É†„Éá„Éº„ÇøË™≠„ÅøËæº„Åø ==========
        async function loadItems() {
            const response = await fetch('./items.json');
            itemData = await response.json();
            console.log('„Ç¢„Ç§„ÉÜ„É†„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', itemData);
        }

        // ========== „Ç¨„ÉÅ„É£„Éá„Éº„ÇøË™≠„ÅøËæº„Åø ==========
        async function loadGacha() {
            const response = await fetch('./gacha.json');
            gachaData = await response.json();
            console.log('„Ç¨„ÉÅ„É£„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', gachaData);
        }

        // ========== „Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø ==========
        async function loadUpgrades() {
            try {
                const response = await fetch('./upgrade.json');
                if (!response.ok) {
                    throw new Error(`„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü (${response.status})`);
                }

                const data = await response.json();
                upgradeJsonData = data;
                console.log('„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', upgradeJsonData);
                return true;
            } catch (error) {
                console.error('„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
                return false;
            }
        }

        // ========== ÂàùÊúüÂåñ ==========
        async function init() {
            setupEventListeners();

            // Twemoji ÂàùÊúüÂåñÔºà„Ç∑„É≥„Éó„É´ÁâàÔºâ
            if (typeof twemoji !== 'undefined') {
                // ÂàùÊúüÂ§âÊèõ
                convertEmojis();
                console.log('TwemojiÂàùÊúüÂåñÂÆå‰∫Ü');

                // MutationObserver „ÅßÂãïÁöÑË¶ÅÁ¥†Áõ£Ë¶ñ
                const emojiObserver = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                convertEmojis(node);
                            }
                        });
                    });
                });

                // Áõ£Ë¶ñÈñãÂßã
                emojiObserver.observe(document.body, {
                    childList: true,
                    subtree: true
                });
                console.log('ÁµµÊñáÂ≠óËá™ÂãïÂ§âÊèõ„Ç∑„Çπ„ÉÜ„É†ÈñãÂßã');
            } else {
                console.warn('Twemoji„É©„Ç§„Éñ„É©„É™„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
            }

            // ÂøÖË¶Å„Å™„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„ÇÄ
            await loadItems();
            await loadGacha();
            await loadUpgrades();

            // „Ç≤„Éº„É†ÂàùÊúüÂåñ
            updateDisplay();
            await loadAllMissionData();
            GameTimerManager.init(); // Êñ∞„Çø„Ç§„Éû„Éº„Ç∑„Çπ„ÉÜ„É†„ÅßÂàùÊúüÂåñ
            initUpgradeButtons(); // „Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„Çø„Éñ
            initUpgradeSystem();  // „Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„Ç∑„Çπ„ÉÜ„É†
            initItemList();       // „Ç¢„Ç§„ÉÜ„É†‰∏ÄË¶ß„Ç∑„Çπ„ÉÜ„É†
        }

        function setupEventListeners() {
            const startButton = document.getElementById('start-button');
            const mainOrderButton = document.getElementById('main-order-button');
            const nameToggle = document.getElementById('name-toggle');
            const nameInput = document.getElementById('name-input');
            const marshmallowLink = document.getElementById('marshmallow-link');
            const botToggle = document.getElementById('bot-toggle');

            // „Éá„Éê„ÉÉ„Ç∞„Éú„Çø„É≥
            const debugIncrease = document.getElementById('debug-increase');
            const debugDecrease = document.getElementById('debug-decrease');
            const debugReset = document.getElementById('debug-reset');
            const debugVoting = document.getElementById('debug-voting');
            const debugOrders = document.getElementById('debug-orders');

            if (startButton) {
                startButton.addEventListener('click', handleGameStart);
            }

            if (mainOrderButton) {
                mainOrderButton.addEventListener('click', function () {
                    handleOrderClick(); // ÂºïÊï∞„Å™„Åó = false
                });
            }

            if (nameToggle && nameInput) {
                nameToggle.addEventListener('click', toggleNameInput);
            }

            if (marshmallowLink) {
                marshmallowLink.addEventListener('click', function () {
                    window.open('https://marshmallow-qa.com/hdl55x2xyxkuz0q?t=OGltiZ&utm_medium=url_text&utm_source=promotion', '_blank');
                });
            }

            if (botToggle) {
                botToggle.addEventListener('click', function () {
                    toggleBot();
                    botToggle.innerHTML = gameState.botEnabled ? 'BOT<br>ON' : 'BOT<br>OFF';
                    botToggle.className = gameState.botEnabled ? 'bot-toggle-btn active' : 'bot-toggle-btn';
                });
            }

            // „Éá„Éê„ÉÉ„Ç∞„Éú„Çø„É≥„Ç§„Éô„É≥„Éà
            if (debugIncrease) {
                debugIncrease.addEventListener('click', function () {
                    debugState.positionAmount += 10000000;
                    if (debugState.positionAmount < 0) {
                        debugState.positionAmount = 0;
                    }
                    updateDisplay();
                });
            }

            if (debugDecrease) {
                debugDecrease.addEventListener('click', function () {
                    debugState.positionAmount -= 10000000;
                    if (debugState.positionAmount < 0) {
                        debugState.positionAmount = 0;
                    }
                    updateDisplay();
                });
            }

            if (debugReset) {
                debugReset.addEventListener('click', function () {
                    debugState.positionAmount = debugState.initialPositionAmount;
                    debugState.serverHP = debugState.maxServerHP;
                    debugState.isServerDown = false;
                    debugState.isPreGacha = false;
                    gameState.inventory = {}; // „Ç§„É≥„Éô„É≥„Éà„É™„ÇÇ„É™„Çª„ÉÉ„Éà
                    gameState.rice = 0;       // „ÅäÁ±≥„ÇÇ„É™„Çª„ÉÉ„Éà
                    gameState.favo = 0;       // „ÅØ„ÅÅ„Å®„ÇÇ„É™„Çª„ÉÉ„Éà
                    gameState.voting = 0;   // „Éï„Ç©„É≠„ÉØ„Éº„ÇÇ„É™„Çª„ÉÉ„Éà
                    updateServerDownUI();
                    updateDisplay();
                });
            }// debugReset „ÅÆÂá¶ÁêÜ„ÅÆÂæå„Å´ËøΩÂä†
            if (debugVoting) {
                debugVoting.addEventListener('click', function () {
                    gameState.voting += 100;
                    updateDisplay();
                });
            }
            if (debugOrders) {
                debugOrders.addEventListener('click', function () {
                    debugState.orders += 10;
                    debugState.positionAmount += 3000000; // 30‰∏áÂÜÜ√ó10 = 300‰∏áÂÜÜ
                    updateDisplay();
                });
            }


            // ÊÉÖÂ†±„Çø„ÉñÂàá„ÇäÊõø„Åà
            document.querySelectorAll('.info-tab-button').forEach(button => {
                button.addEventListener('click', function () {
                    const tabName = this.dataset.infoTab;
                    switchInfoTab(tabName);
                });
            });

            // „Ç≤„Éº„É†„Çø„ÉñÂàá„ÇäÊõø„Åà
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function () {
                    switchGameTab(this);
                });
            });

            // ‰∏ãÈÉ®„Çø„ÉñÂàá„ÇäÊõø„Åà
            document.querySelectorAll('.bottom-tab-btn').forEach(button => {
                button.addEventListener('click', function () {
                    switchBottomTab(this);
                });
            });

            // „Éü„ÉÉ„Ç∑„Éß„É≥Êõ¥Êñ∞„Éú„Çø„É≥
            const missionRefresh = document.getElementById('mission-refresh');
            if (missionRefresh) {
                missionRefresh.addEventListener('click', refreshMissions);
            }

            // ÁèæÂºï„Åç/Ë¨ùÁΩ™„Éú„Çø„É≥
            const gachaButton = document.getElementById('gacha-button');
            if (gachaButton) {
                gachaButton.addEventListener('click', function () {
                    if (debugState.isServerDown) {
                        handleApologyClick();
                    } else if (debugState.isPreGacha) {
                        // „Ç¨„ÉÅ„É£Áô∫ÁÅ´Âá¶ÁêÜ
                        console.log('ÁèæÊ∏°„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ - „Ç¨„ÉÅ„É£Áô∫ÁÅ´ÈñãÂßã');
                        executeGacha();
                    } else if (debugState.orders > 0) {
                        // preÁèæÊ∏°„É¢„Éº„Éâ„Å´ÁßªË°å
                        console.log('ÁèæÂºï„Åç„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ - preÁèæÊ∏°„É¢„Éº„ÉâÈñãÂßã');
                        enterPreGachaMode();
                    }
                });
            }

            // „Ç§„Éô„É≥„ÉàÂßîË≠≤„Å´„Çà„Çã„Éü„ÉÉ„Ç∑„Éß„É≥Èñ¢ÈÄ£„Ç§„Éô„É≥„ÉàÂá¶ÁêÜ
            document.addEventListener('click', function (event) {
                // „Éü„ÉÉ„Ç∑„Éß„É≥ÂÜÖ„Çø„ÉñÂàá„ÇäÊõø„Åà
                if (event.target.classList.contains('mission-tab-button')) {
                    const tabName = event.target.dataset.missionTab;
                    switchMissionTab(tabName);
                }

                // „Éü„ÉÉ„Ç∑„Éß„É≥„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
                if (event.target.classList.contains('mission-btn')) {
                    const missionCard = event.target.closest('.mission-card');
                    if (missionCard) {
                        const missionId = missionCard.dataset.missionId;
                        const action = event.target.textContent;
                        handleMissionAction(missionId, action);
                    }
                }
            });
        }

        // ========== „ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜÊ©üËÉΩ ==========
        function handleOrderClick(isBot = false) {
            // „Çµ„Éº„Éê„Éº„ÉÄ„Ç¶„É≥‰∏≠„Åæ„Åü„ÅØpreÁèæÊ∏°‰∏≠„ÅØ„ÇØ„É™„ÉÉ„ÇØÁÑ°Âäπ
            if (debugState.isServerDown || debugState.isPreGacha) return;

            // Á∑è„ÇØ„É™„ÉÉ„ÇØÊï∞„ÇíÂøÖ„ÅöÂ¢óÂä†
            gameState.totalClicks++;

            // ÁèæÂºï„Åç„Åæ„Åß„ÅÆ„ÇØ„É™„ÉÉ„ÇØÊï∞„Çí„Ç´„Ç¶„É≥„Éà
            debugState.clicksSinceLastGacha++;

            // „ÉÄ„É°„Éº„Ç∏Ë®àÁÆóÔºàÂü∫Êú¨ÂÄ§ÔºöÊâãÂãï1„ÄÅBOT2Ôºâ
            let damage = isBot ? 2 : 1;

            if (isBot) {
                // üéÑBOT„ÉÄ„É°„Éº„Ç∏ËªΩÊ∏õ (1„É¨„Éô„É´„ÅÇ„Åü„Çä16%ËªΩÊ∏õ„ÄÅÊúÄÂ§ß80%)
                const damageReduction = Math.min((upgradeProgress.bot_damage || 0) * 0.16, 0.8);
                damage *= (1 - damageReduction);
            } else {
                // üëçÁ•û„ÅÆË¶™Êåá (1„É¨„Éô„É´„ÅÇ„Åü„Çä16%ËªΩÊ∏õ„ÄÅÊúÄÂ§ß80%)
                const handDamageReduction = Math.min((upgradeProgress.god_thumb || 0) * 0.16, 0.8);
                damage *= (1 - handDamageReduction);
            }

            // ÊàêÂäüÁéáË®àÁÆóÔºàÂü∫Êú¨ÂÄ§ÔºöÊâãÂãï25%„ÄÅBOT10%Ôºâ
            let successRate = isBot ? 0.1 : 0.25;

            if (isBot) {
                // üèµÔ∏èBOTÁç≤ÂæóÁéáÂêë‰∏ä (1„É¨„Éô„É´„ÅÇ„Åü„Çä10%Âêë‰∏ä„ÄÅ10%‚Üí60%)
                successRate += (upgradeProgress.bot_get_rate || 0) * 0.1;
            } else {
                // üñïÁ•û„ÅÆ‰∏≠Êåá (1„É¨„Éô„É´„ÅÇ„Åü„Çä13%Âêë‰∏ä„ÄÅ25%‚Üí90%)
                successRate += (upgradeProgress.god_finger || 0) * 0.13;
            }

            // „Éá„Éê„ÉÉ„Ç∞Áî®„É≠„Ç∞
            console.log(`${isBot ? 'BOT' : 'ÊâãÂãï'}„ÇØ„É™„ÉÉ„ÇØ - „ÉÄ„É°„Éº„Ç∏:${damage.toFixed(1)}, ÊàêÂäüÁéá:${(successRate * 100).toFixed(1)}%`);

            // „Çµ„Éº„Éê„ÉºHPÊ∏õÂ∞ëÂá¶ÁêÜ
            debugState.serverHP -= damage;
            if (debugState.serverHP < 0) debugState.serverHP = 0;

            // „Çµ„Éº„Éê„Éº„ÉÄ„Ç¶„É≥„ÉÅ„Çß„ÉÉ„ÇØ
            checkServerDown();

            // ÂΩì„Åü„ÇäÂà§ÂÆö
            const isHit = Math.random() < successRate;

            if (isHit) {
                // ÂΩì„Åü„ÇäÂá¶ÁêÜ
                debugState.orders++;
                debugState.positionAmount += 300000; // 30‰∏áÂÜÜÂ¢óÂä†
                showResultPopup(true);
            } else {
                // Â§ñ„ÇåÂá¶ÁêÜ
                showResultPopup(false);
            }

            // Ë°®Á§∫„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞
            updateDisplay();
        }

        function showResultPopup(isSuccess) {
            const centerArea = document.getElementById('center-area');
            if (!centerArea) return;

            // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË¶ÅÁ¥†„Çí‰ΩúÊàê
            const popup = document.createElement('div');
            popup.className = `result-popup ${isSuccess ? 'success' : 'failure'}`;

            // „É°„ÉÉ„Çª„Éº„Ç∏Ë®≠ÂÆö
            if (isSuccess) {
                popup.textContent = 'Êñ∞Ë¶èÂ£≤„ÇäÊ≥®Êñá„ÇíÂèó„Åë‰ªò„Åë„Åæ„Åó„Åü';
                popup.style.animationDuration = '2s'; // ÊàêÂäüÊôÇ2Áßí
            } else {
                popup.textContent = '„ÅîÊ≥®ÊñáÊï∞Èáè„Åå„ÄÅ‰∏ÄËà¨‰ø°Áî®Â£≤Âª∫ÂèØËÉΩÊï∞Èáè„ÇíË∂ÖÈÅé„Åó„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅÂèó‰ªò„Åë„Åß„Åç„Åæ„Åõ„Çì„ÄÇ';
                popup.style.animationDuration = '0.5s'; // Â§±ÊïóÊôÇ0.5Áßí
            }

            // ‰∏ÄÊôÇÁöÑ„Å´ÁîªÈù¢Â§ñ„Å´ÈÖçÁΩÆ„Åó„Å¶„Çµ„Ç§„Ç∫„ÇíÂèñÂæó
            popup.style.visibility = 'hidden';
            popup.style.position = 'absolute';
            centerArea.appendChild(popup);

            // „É©„É≥„ÉÄ„É†‰ΩçÁΩÆ„ÇíË®≠ÂÆöÔºàcenter-areaÂÜÖ„Éª‰∏≠ÂøÉÁÇπÂü∫Ê∫ñÔºâ
            const areaRect = centerArea.getBoundingClientRect();
            const popupRect = popup.getBoundingClientRect();

            const randomX = Math.random() * areaRect.width;
            const randomY = Math.random() * areaRect.height;

            // ‰∏≠ÂøÉÁÇπÂü∫Ê∫ñ„ÅßÂ∫ßÊ®ôË®≠ÂÆö
            const centerX = randomX - (popupRect.width / 2);
            const centerY = randomY - (popupRect.height / 2);

            popup.style.left = centerX + 'px';
            popup.style.top = centerY + 'px';
            popup.style.visibility = 'visible';

            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁµÇ‰∫ÜÂæå„Å´ÂâäÈô§
            const duration = isSuccess ? 2000 : 500; // ÊàêÂäü2Áßí„ÉªÂ§±Êïó0.5Áßí
            setTimeout(() => {
                if (popup.parentNode) {
                    popup.parentNode.removeChild(popup);
                }
            }, duration);
        }

        // ========== „Çµ„Éº„Éê„Éº„ÉÄ„Ç¶„É≥Âá¶ÁêÜ ==========
        function checkServerDown() {
            const wasDown = debugState.isServerDown;
            const shouldBeDown = (debugState.serverHP === 0);
            const shouldRecover = (debugState.serverHP === debugState.maxServerHP);

            if (!wasDown && shouldBeDown) {
                enterServerDownMode();
            } else if (wasDown && shouldRecover) {
                exitServerDownMode();
            }
        }

        function enterServerDownMode() {
            debugState.isServerDown = true;
            debugState.orders = 0;
            debugState.positionAmount = 0;
            updateServerDownUI();
            // „Çµ„Éº„Éê„ÉºÂÄíÂ£ä„Ç®„É©„Éº„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫
            showErrorPopup("üî•„Çµ„Éº„Éê„ÉºÂÄíÂ£äüî•", "ÂÖ®„Å¶„ÅÆÂú®Â∫´„ÇíÂ§±„ÅÑ„Åæ„Åó„Åü„ÄÇ<br>Ë¨ùÁΩ™„Éú„Çø„É≥„ÅßÂæ©Êóß„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");

        }

        function exitServerDownMode() {
            debugState.isServerDown = false;
            updateServerDownUI();
        }

        function updateServerDownUI() {
            const orderButton = document.getElementById('main-order-button');
            const gachaButton = document.getElementById('gacha-button');
            const hpLabel = document.querySelector('.server-hp-label');

            if (debugState.isServerDown) {
                // „Çµ„Éº„Éê„Éº„ÉÄ„Ç¶„É≥Áä∂ÊÖã„ÅÆUI
                if (orderButton) {
                    orderButton.classList.add('disabled');
                    orderButton.style.background = '#cccccc';
                    orderButton.style.cursor = 'not-allowed';
                }

                if (gachaButton) {
                    gachaButton.textContent = 'Ë¨ùÁΩ™';
                    gachaButton.style.background = '#87ceeb';
                    gachaButton.classList.add('apology');
                }

                if (hpLabel) {
                    hpLabel.textContent = '„Çµ„Éº„Éê„Éº„ÅØÂøúÁ≠î„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÁèæÂú®Âæ©Êóß‰∏≠„Åß„Åô„ÄÇ';
                }
            } else if (debugState.isPreGacha) {
                // preÁèæÊ∏°Áä∂ÊÖã„ÅÆUI
                if (orderButton) {
                    orderButton.classList.add('disabled');
                    orderButton.style.background = '#cccccc';
                    orderButton.style.cursor = 'not-allowed';
                }
                // „Ç¨„ÉÅ„É£„Éú„Çø„É≥„ÅØupdateGachaButtonState()„ÅßÂá¶ÁêÜ
            } else {
                // ÈÄöÂ∏∏Áä∂ÊÖã„ÅÆUI
                if (orderButton) {
                    orderButton.classList.remove('disabled');
                    orderButton.style.background = '#4caf50';
                    orderButton.style.cursor = 'pointer';
                }

                if (gachaButton) {
                    gachaButton.style.background = '#ff5722';
                    gachaButton.classList.remove('apology');
                }

                if (hpLabel) {
                    hpLabel.textContent = '„Çµ„Éº„Éê„ÉºHP';
                }
            }
        }

        function handleApologyClick() {
            if (debugState.isServerDown) {
                debugState.serverHP += 5;
                if (debugState.serverHP > debugState.maxServerHP) {
                    debugState.serverHP = debugState.maxServerHP;
                }
                checkServerDown();
                updateDisplay();
            }
        }

        // ========== „Éü„ÉÉ„Ç∑„Éß„É≥Ê©üËÉΩ ==========

        async function loadAllMissionData() {
            console.log('ÂÖ®„Éü„ÉÉ„Ç∑„Éß„É≥„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÈñãÂßã');

            try {
                // tweets.json Ë™≠„ÅøËæº„Åø
                await loadTweetsData();

                // missions.json Ë™≠„ÅøËæº„Åø
                await loadMissionsData();

                // Ê≠£Ë¶èÂåñÂá¶ÁêÜ
                normalizeMissions();

                // ÂàùÊúüË°®Á§∫Ôºà„Çπ„Éà„Éº„É™„Éº„Çø„Éñ„Çí„Éá„Éï„Ç©„É´„ÉàÔºâ
                currentActiveTab = 'story';
                displayCurrentTabMissions();

                console.log('ÂÖ®„Éü„ÉÉ„Ç∑„Éß„É≥„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');

            } catch (error) {
                console.error('„Éü„ÉÉ„Ç∑„Éß„É≥„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                showMissionError('„Éü„ÉÉ„Ç∑„Éß„É≥„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        // ========== „Çø„ÉñË°®Á§∫„É≠„Ç∏„ÉÉ„ÇØ‰øÆÊ≠£ ==========
        function displayCurrentTabMissions() {
            console.log(`ÁèæÂú®„ÅÆ„Çø„ÉñË°®Á§∫: ${currentActiveTab}`);

            if (currentActiveTab === 'character') {
                displayCharacterTab();
            } else if (currentActiveTab === 'story') {
                displayStoryTab();
            } else {
                // „Éá„Éï„Ç©„É´„Éà„ÅØ„Çπ„Éà„Éº„É™„Éº„Çø„Éñ
                currentActiveTab = 'story';
                displayStoryTab();
            }
        }

        function displayCharacterTab() {
            console.log('„Éï„Ç©„É≠„Éº‰∏≠„Çø„ÉñË°®Á§∫');

            // „Ç≠„É£„É©„ÇØ„Çø„Éº„Éü„ÉÉ„Ç∑„Éß„É≥„ÇíÂèñÂæó
            const characterMissions = normalizedMissions.filter(m => m.type === 'character');

            // ÈÄ≤Ë°å‰∏≠„ÉªÂÆå‰∫Ü„ÉªÂèóÂèñÊ∏à„Åø„ÅÆ„Éü„ÉÉ„Ç∑„Éß„É≥„Çí‰øùÊåÅÔºàÂÖ®„Å¶Ë°®Á§∫Á∂ôÁ∂öÔºâ
            const activeMissions = [];
            for (const missionId in missionStates) {
                const state = missionStates[missionId].state;
                if (state === 'progress' || state === 'complete' || state === 'claimed') {
                    const mission = characterMissions.find(m => m.id === missionId);
                    if (mission) {
                        activeMissions.push(mission);
                    }
                }
            }

            console.log(`„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éü„ÉÉ„Ç∑„Éß„É≥: ${activeMissions.length}ÂÄã (ÈÄ≤Ë°å‰∏≠„ÉªÂÆå‰∫Ü„ÉªÂèóÂèñÊ∏à„Åø)`);

            // ÂøÖË¶Å„Å™Êñ∞Ë¶è„Éü„ÉÉ„Ç∑„Éß„É≥Êï∞„ÇíË®àÁÆóÔºà3ÂÄã„Åã„Çâ‰øùÊåÅÂàÜ„ÇíÂºï„ÅèÔºâ
            const neededCount = 3 - activeMissions.length;

            if (neededCount > 0) {
                // Êú™ÈÅ∏Êäû„ÅÆ„Éü„ÉÉ„Ç∑„Éß„É≥„Åã„ÇâÊäΩÈÅ∏
                const availableMissions = characterMissions.filter(mission =>
                    !missionStates[mission.id]
                );

                const newMissions = getRandomMissions(availableMissions, neededCount);
                console.log(`Êñ∞Ë¶è„Éü„ÉÉ„Ç∑„Éß„É≥ËøΩÂä†: ${newMissions.length}ÂÄã`);

                // ÂÖ®„Éü„ÉÉ„Ç∑„Éß„É≥„ÇíÁµêÂêà
                const allMissions = [...activeMissions, ...newMissions];
                displayMissions(allMissions);
            } else {
                // Êó¢„Å´„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éü„ÉÉ„Ç∑„Éß„É≥„Åå3ÂÄã‰ª•‰∏ä„ÅÇ„ÇãÂ†¥Âêà
                displayMissions(activeMissions.slice(0, 3));
            }
        }

        // ========== „Çπ„Éà„Éº„É™„Éº„Çø„ÉñË°®Á§∫‰øÆÊ≠£ ==========

        function displayStoryTab() {
            console.log('„Ç™„Çπ„Çπ„É°„Çø„ÉñË°®Á§∫');

            // „Çπ„Éà„Éº„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥„ÇíÂèñÂæó
            const storyMissions = normalizedMissions.filter(m => m.type === 'story');
            console.log(`„Çπ„Éà„Éº„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥Êï∞: ${storyMissions.length}`);

            if (storyMissions.length === 0) {
                console.log('„Çπ„Éà„Éº„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                const missionList = document.getElementById('mission-list');
                if (missionList) {
                    missionList.innerHTML = '<div class="error-message">„Çπ„Éà„Éº„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>';
                }
                return;
            }

            // ÂêÑ„Çπ„Éà„Éº„É™„Éº„Åã„ÇâÊ¨°„Å´ÈÄ≤Ë°åÂèØËÉΩ„Å™„ÉÅ„É£„Éó„Çø„Éº„ÇíÂèñÂæó
            const availableChapters = [];

            if (missionsData && missionsData.stories) {
                console.log(`Âà©Áî®ÂèØËÉΩ„Çπ„Éà„Éº„É™„ÉºÊï∞: ${missionsData.stories.length}`);

                missionsData.stories.forEach(story => {
                    const nextChapter = getNextAvailableChapter(story.storyId, storyMissions);
                    if (nextChapter) {
                        availableChapters.push(nextChapter);
                        console.log(`ËøΩÂä†„Åï„Çå„Åü„ÉÅ„É£„Éó„Çø„Éº: ${nextChapter.id}`);
                    } else {
                        console.log(`${story.storyId}: Âà©Áî®ÂèØËÉΩ„Å™„ÉÅ„É£„Éó„Çø„Éº„Å™„Åó`);
                    }
                });
            }

            // ÊúÄÂ§ß3ÂÄã„Åæ„ÅßË°®Á§∫
            const displayChapters = availableChapters.slice(0, 3);
            console.log(`Ë°®Á§∫„ÉÅ„É£„Éó„Çø„ÉºÊï∞: ${displayChapters.length}`);

            displayMissions(displayChapters);
        }

        function getNextAvailableChapter(storyId, storyMissions) {
            // „Åù„ÅÆ„Çπ„Éà„Éº„É™„Éº„ÅÆ„Éü„ÉÉ„Ç∑„Éß„É≥„ÇíÂèñÂæó
            const storyChapters = storyMissions.filter(m => m.metadata.storyId === storyId);

            // ÂÆå‰∫ÜÊ∏à„Åø„ÉÅ„É£„Éó„Çø„ÉºÊï∞„ÇíË®àÁÆó
            const completedCount = storyChapters.filter(chapter => {
                const state = missionStates[chapter.id];
                return state && state.state === 'claimed';
            }).length;

            // Ê¨°„ÅÆ„ÉÅ„É£„Éó„Çø„ÉºÁï™Âè∑
            const nextChapterNum = completedCount + 1;

            // Ë©≤ÂΩì„Åô„Çã„ÉÅ„É£„Éó„Çø„Éº„ÇíËøî„Åô
            return storyChapters.find(chapter =>
                chapter.metadata.chapterNumber === nextChapterNum
            );
        }

        // ========== „Éü„ÉÉ„Ç∑„Éß„É≥Ë°®Á§∫Èñ¢Êï∞ ==========

        function displayMissions(missions) {
            const missionList = document.getElementById('mission-list');
            if (!missionList) {
                console.error('mission-listË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            if (missions.length === 0) {
                missionList.innerHTML = '<div class="loading-message">Ë°®Á§∫ÂèØËÉΩ„Å™„Éü„ÉÉ„Ç∑„Éß„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            console.log(`„Éü„ÉÉ„Ç∑„Éß„É≥Ë°®Á§∫: ${missions.length}ÂÄã`);

            const missionHTML = missions.map(mission => {
                const state = missionStates[mission.id] || { state: 'unaccepted', timerId: null, remainingTime: 0 };
                const stateInfo = getMissionStateInfo(mission.id, state);
                return createUnifiedMissionCard(mission, stateInfo);
            }).join('');

            missionList.innerHTML = missionHTML;

            // TwemojiÂ§âÊèõ
            if (typeof convertEmojis === 'function') {
                convertEmojis(missionList);
            }
        }


        async function loadTweetsData() {
            console.log('tweets.json Ë™≠„ÅøËæº„Åø‰∏≠...');
            const response = await fetch('./tweets.json');
            if (!response.ok) {
                throw new Error(`tweets.jsonË™≠„ÅøËæº„ÅøÂ§±Êïó (${response.status})`);
            }
            tweetsData = await response.json();
            console.log('tweets.json Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', tweetsData);
        }

        async function loadMissionsData() {
            console.log('missions.json Ë™≠„ÅøËæº„Åø‰∏≠...');
            const response = await fetch('./missions.json');
            if (!response.ok) {
                throw new Error(`missions.jsonË™≠„ÅøËæº„ÅøÂ§±Êïó (${response.status})`);
            }
            missionsData = await response.json();
            console.log('missions.json Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', missionsData);
        }

        function normalizeMissions() {
            console.log('„Éü„ÉÉ„Ç∑„Éß„É≥Ê≠£Ë¶èÂåñÈñãÂßã');
            normalizedMissions = [];

            // tweets.json „ÅÆ„Ç≠„É£„É©„ÇØ„Çø„Éº„Éü„ÉÉ„Ç∑„Éß„É≥Ê≠£Ë¶èÂåñ
            if (tweetsData && tweetsData.missions) {
                tweetsData.missions.forEach(mission => {
                    const normalized = MissionNormalizer.fromCharacter(
                        mission,
                        tweetsData.characters,
                        tweetsData.difficulties
                    );
                    normalizedMissions.push(normalized);
                });
            }

            // missions.json „ÅÆ„Çπ„Éà„Éº„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥Ê≠£Ë¶èÂåñ
            if (missionsData && missionsData.stories) {
                missionsData.stories.forEach(story => {
                    story.chapters.forEach(chapter => {
                        const normalized = MissionNormalizer.fromStory(chapter, story);
                        normalizedMissions.push(normalized);
                    });
                });
            }

            console.log(`Ê≠£Ë¶èÂåñÂÆå‰∫Ü: ${normalizedMissions.length}ÂÄã„ÅÆ„Éü„ÉÉ„Ç∑„Éß„É≥`);
        }

        function showMissionError(message) {
            const missionList = document.getElementById('mission-list');
            if (missionList) {
                missionList.innerHTML = `<div class="error-message">${message}</div>`;
            }
        }

        // ========== Êõ¥Êñ∞„Éú„Çø„É≥‰øÆÊ≠£ ==========

        function refreshMissions() {
            console.log('„Éü„ÉÉ„Ç∑„Éß„É≥Êõ¥Êñ∞„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ');

            if (currentActiveTab === 'character') {
                refreshCharacterMissions();
            } else if (currentActiveTab === 'story') {
                refreshStoryMissions();
            }
        }

        function refreshCharacterMissions() {
            console.log('„Ç≠„É£„É©„ÇØ„Çø„Éº„Éü„ÉÉ„Ç∑„Éß„É≥Êõ¥Êñ∞');

            if (!tweetsData || !tweetsData.missions) {
                console.error('tweetsData„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            // Êú™ÂèóË´æ + ÂèóÂèñÊ∏à„ÅøÁä∂ÊÖã„ÅÆ„Éü„ÉÉ„Ç∑„Éß„É≥ID„ÇíÂèñÂæóÔºàÈÄ≤Ë°å‰∏≠„ÉªÂÆå‰∫Ü„ÅØ‰øùË≠∑Ôºâ
            const replaceableMissions = [];
            for (const missionId in missionStates) {
                const state = missionStates[missionId].state;
                if (state === 'unaccepted' || state === 'claimed') {
                    replaceableMissions.push(missionId);
                }
            }

            console.log(`„É™„Éï„É¨„ÉÉ„Ç∑„É•ÂØæË±°: ${replaceableMissions.length}ÂÄã (ÈÄ≤Ë°å‰∏≠„ÉªÂÆå‰∫Ü„ÅØ‰øùË≠∑)`);

            // Êú™ÂèóË´æ + ÂèóÂèñÊ∏à„Åø„Éü„ÉÉ„Ç∑„Éß„É≥„ÅÆÁä∂ÊÖã„Çí„ÇØ„É™„Ç¢
            replaceableMissions.forEach(missionId => {
                delete missionStates[missionId];
            });

            // „Éü„ÉÉ„Ç∑„Éß„É≥„ÇíÂÜçË°®Á§∫
            displayCharacterTab();
        }

        function refreshStoryMissions() {
            console.log('„Çπ„Éà„Éº„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥Êõ¥Êñ∞');

            // „Çπ„Éà„Éº„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥„ÅØÊõ¥Êñ∞„ÅÆÊ¶ÇÂøµ„Åå„Å™„ÅÑ„ÅÆ„Åß„ÄÅÂÜçË°®Á§∫„ÅÆ„Åø
            displayStoryTab();
        }

        // ========== „Çø„ÉñÂàá„ÇäÊõø„Åà‰øÆÊ≠£ ==========
        function switchMissionTab(tabName) {
            console.log(`„Éü„ÉÉ„Ç∑„Éß„É≥„Çø„ÉñÂàá„ÇäÊõø„Åà: ${tabName}`);

            // „Çø„ÉñÂêç„ÇícurrentActiveTab„Å´ÂØæÂøú„Åï„Åõ„Çã
            if (tabName === 'recommend') {
                currentActiveTab = 'story';
            } else if (tabName === 'character') {
                currentActiveTab = 'character';
            }

            // „Çø„Éñ„Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖãÂàá„ÇäÊõø„Åà
            document.querySelectorAll('.mission-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeButton = document.querySelector(`[data-mission-tab="${tabName}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }

            // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
            displayCurrentTabMissions();
        }

        function getRandomMissions(missions, count) {
            // ÈÖçÂàó„Çí„Ç∑„É£„ÉÉ„Éï„É´
            const shuffled = [...missions].sort(() => Math.random() - 0.5);
            // ÊåáÂÆöÊï∞„Å†„ÅëÂèñÂæóÔºàÈÖçÂàó„ÅÆÈï∑„Åï„ÇíË∂Ö„Åà„Å™„ÅÑÔºâ
            return shuffled.slice(0, Math.min(count, shuffled.length));
        }

        // ========== „Éü„ÉÉ„Ç∑„Éß„É≥Áä∂ÊÖãÊÉÖÂ†±ÂèñÂæóÈñ¢Êï∞ÔºàËøΩÂä†Ôºâ ==========

        function getMissionStateInfo(missionId, state) {
            console.log(`Áä∂ÊÖãÊÉÖÂ†±ÂèñÂæó: ${missionId}, state: ${state.state}, remainingTime: ${state.remainingTime}`);

            const stateInfo = {
                id: missionId,
                state: state.state,
                bgClass: `mission-state-${state.state}`
            };

            switch (state.state) {
                case 'unaccepted':
                    stateInfo.buttonText = 'ÂèóË´æ';
                    stateInfo.buttonClass = 'mission-btn-accept';

                    // Ê≠£Ë¶èÂåñÊ∏à„Åø„Éü„ÉÉ„Ç∑„Éß„É≥„Åã„ÇâÊôÇÈñì„ÇíÂèñÂæó
                    const mission = normalizedMissions.find(m => m.id === missionId);
                    if (mission) {
                        stateInfo.timeText = `ÂøÖË¶ÅÊôÇÈñìÔºö${mission.duration}Áßí`;
                    } else {
                        stateInfo.timeText = 'ÂøÖË¶ÅÊôÇÈñìÔºö‰∏çÊòé';
                    }
                    break;

                case 'progress':
                    stateInfo.buttonText = 'ÂèóË´æ‰∏≠';
                    stateInfo.buttonClass = 'mission-btn-disabled';
                    stateInfo.timeText = `ÊÆã„ÇäÊôÇÈñìÔºö${state.remainingTime}Áßí`;
                    break;

                case 'complete':
                    stateInfo.buttonText = 'Â†±ÈÖ¨ÂèóÂèñ';
                    stateInfo.buttonClass = 'mission-btn-claim';
                    stateInfo.timeText = 'ÂÆå‰∫Ü';
                    break;

                case 'claimed':
                    stateInfo.buttonText = 'ÂèóÂèñÊ∏à';
                    stateInfo.buttonClass = 'mission-btn-disabled';
                    stateInfo.timeText = 'ÂèóÂèñÊ∏à';
                    break;

                default:
                    stateInfo.buttonText = '‰∏çÊòé';
                    stateInfo.buttonClass = 'mission-btn-disabled';
                    stateInfo.timeText = '‰∏çÊòé';
                    break;
            }

            console.log(`Áä∂ÊÖãÊÉÖÂ†±ÁµêÊûú: ${stateInfo.buttonText}, ${stateInfo.timeText}`);
            return stateInfo;
        }

        // ========== Áµ±‰∏Ä„Éü„ÉÉ„Ç∑„Éß„É≥„Ç´„Éº„Éâ‰ΩúÊàê ==========
        function createUnifiedMissionCard(mission, stateInfo) {
            // „Ç¢„Éê„Çø„Éº/„Ç¢„Ç§„Ç≥„É≥„ÅÆÊ±∫ÂÆö
            let avatar, userName, handle, difficulty;

            if (mission.type === 'character') {
                avatar = mission.metadata.character.icon;
                userName = mission.metadata.character.name;
                handle = mission.metadata.character.handle;
                difficulty = mission.metadata.difficulty;  // ‚≠ê‚≠ê
            } else if (mission.type === 'story') {
                avatar = mission.metadata.storyIcon || 'üìñ';  // ‚Üê „Çπ„Éà„Éº„É™„ÉºÂà•ÁµµÊñáÂ≠ó
                userName = mission.title;
                handle = mission.metadata.chapterTitle;    // Á´†„Çø„Ç§„Éà„É´
                difficulty = `Á¨¨${mission.metadata.chapterNumber}Ë©±`;  // Á¨¨2Ë©±
            }

            // Á¥†Êùê‰∏çË∂≥„ÉÅ„Çß„ÉÉ„ÇØ
            const canAfford = checkRequirements(mission.requirements);
            const isDisabled = !canAfford && stateInfo.state === 'unaccepted';

            // „Éú„Çø„É≥„ÇØ„É©„Çπ„ÅÆË™øÊï¥
            let buttonClass = stateInfo.buttonClass;
            let buttonDisabled = stateInfo.buttonClass === 'mission-btn-disabled';

            if (isDisabled) {
                buttonClass = 'mission-btn-disabled';
                buttonDisabled = true;
            }

            return `
        <div class="mission-card ${stateInfo.bgClass}" data-mission-id="${stateInfo.id}">
            <div class="mission-card-header-compact">
                <div class="mission-avatar-small">${avatar}</div>
                <div class="mission-name-small">${userName}</div>
                <div class="mission-handle-small">${handle}</div>
                <div class="mission-difficulty-small">${difficulty}</div>
            </div>
            <div class="mission-content">${mission.content}</div>
            <div class="mission-details">
                <div class="mission-requirement">ÈÅîÊàêÊù°‰ª∂Ôºö${formatRequirements(mission.requirements)}</div>
                <div class="mission-reward">Â†±„ÄÄ„ÄÄÈÖ¨Ôºö${formatRewards(mission.rewards)}</div>
            </div>
            <div class="mission-actions">
                <button class="mission-btn ${buttonClass}" ${buttonDisabled ? 'disabled' : ''}>${stateInfo.buttonText}</button>
                <div class="mission-time">${stateInfo.timeText}</div>
            </div>
        </div>
    `;
        }
        // ========== Á¥†Êùê„ÉÅ„Çß„ÉÉ„ÇØÈñ¢Êï∞ÔºàËøΩÂä†Ôºâ ==========

        function checkRequirements(requirements) {
            if (!requirements || Object.keys(requirements).length === 0) {
                return true; // Êù°‰ª∂„Å™„Åó„ÅÆÂ†¥Âêà„ÅØOK
            }

            // ÂøÖË¶ÅÁ¥†Êùê„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØÔºàÊ∂àË≤ª„ÅØ„Åó„Å™„ÅÑÔºâ
            if (requirements.cash && gameState.cash < requirements.cash) {
                return false;
            }
            if (requirements.premium && gameState.premiumCoin < requirements.premium) {
                return false;
            }
            if (requirements.rice && gameState.rice < requirements.rice) {
                return false;
            }
            if (requirements.items) {
                for (const item of requirements.items) {
                    const owned = gameState.inventory[item.id] || 0;
                    if (owned < item.amount) {
                        return false;
                    }
                }
            }

            return true;
        }

        function formatRequirements(requirements) {
            if (!requirements || Object.keys(requirements).length === 0) {
                return '„Å™„Åó';
            }

            const parts = [];
            if (requirements.cash) parts.push(`ÁèæÈáë${(requirements.cash / 10000).toFixed(0)}‰∏áÂÜÜ`);
            if (requirements.premium) parts.push(`PTC${requirements.premium}Êûö`);
            if (requirements.rice) parts.push(`„ÅäÁ±≥${requirements.rice}kg`);
            if (requirements.items) {
                requirements.items.forEach(item => {
                    const itemData = findItemById(item.id);
                    if (itemData) {
                        parts.push(`${itemData.name}${item.amount}${getItemUnit(item.id)}`);
                    }
                });
            }

            return parts.join('„ÄÅ');
        }

        function formatRewards(rewards) {
            const parts = [];
            if (rewards.favo) parts.push(`„ÅØ„ÅÅ„Å®${rewards.favo}‰ª∂`);
            if (rewards.cash) parts.push(`ÁèæÈáë${(rewards.cash / 10000).toFixed(0)}‰∏áÂÜÜ`);
            if (rewards.premium) parts.push(`PTC${rewards.premium}Êûö`);
            if (rewards.rice) parts.push(`„ÅäÁ±≥${rewards.rice}kg`);
            if (rewards.items) {
                rewards.items.forEach(item => {
                    const itemData = findItemById(item.id);
                    if (itemData) {
                        parts.push(`${itemData.name}${item.amount}${getItemUnit(item.id)}`);
                    }
                });
            }

            return parts.join('„ÄÅ');
        }

        // ========== „Éü„ÉÉ„Ç∑„Éß„É≥„Ç¢„ÇØ„Ç∑„Éß„É≥Âá¶ÁêÜ‰øÆÊ≠£ ==========

        function handleMissionAction(missionId, action) {
            console.log(`„Éü„ÉÉ„Ç∑„Éß„É≥„Ç¢„ÇØ„Ç∑„Éß„É≥: ${missionId}, ${action}`);

            const state = missionStates[missionId] || { state: 'unaccepted', timerId: null, remainingTime: 0 };

            switch (action) {
                case 'ÂèóË´æ':
                    acceptMission(missionId);
                    break;
                case 'Â†±ÈÖ¨ÂèóÂèñ':
                    claimMissionReward(missionId);
                    break;
            }
        }

        // ========== „Éü„ÉÉ„Ç∑„Éß„É≥ÂèóË´æÂá¶ÁêÜ‰øÆÊ≠£ ==========

        function acceptMission(missionId) {
            console.log(`„Éü„ÉÉ„Ç∑„Éß„É≥ÂèóË´æ: ${missionId}`);

            // Ê≠£Ë¶èÂåñÊ∏à„Åø„Éü„ÉÉ„Ç∑„Éß„É≥„ÇíÂèñÂæó
            const mission = normalizedMissions.find(m => m.id === missionId);
            if (!mission) {
                console.error(`„Éü„ÉÉ„Ç∑„Éß„É≥Ë¶ã„Å§„Åã„Çâ„Åö: ${missionId}`);
                return;
            }

            // ÂøÖË¶ÅÁ¥†Êùê„Çí„ÉÅ„Çß„ÉÉ„ÇØ„ÉªÊ∂àË≤ª
            if (!consumeRequirements(mission.requirements)) {
                console.log('ÂøÖË¶ÅÁ¥†Êùê„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô');
                return;
            }

            // „Éü„ÉÉ„Ç∑„Éß„É≥Áä∂ÊÖã„ÇíÈÄ≤Ë°å‰∏≠„Å´Â§âÊõ¥
            missionStates[missionId] = {
                state: 'progress',
                timerId: null,
                remainingTime: mission.duration
            };

            console.log(`„Éü„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã: ${missionId}, ÊâÄË¶ÅÊôÇÈñì: ${mission.duration}Áßí`);

            // „Éò„ÉÉ„ÉÄ„ÉºÊõ¥Êñ∞„ÅÆ„ÅøÔºàÁ¥†ÊùêÊ∂àË≤ªÂèçÊò†Ôºâ
            updateDisplay();

            // Ë©≤ÂΩì„Éü„ÉÉ„Ç∑„Éß„É≥„Ç´„Éº„Éâ„ÅÆ„ÅøÊõ¥Êñ∞
            updateSingleMissionCard(missionId);
        }
        // ========== Âçò‰∏Ä„Éü„ÉÉ„Ç∑„Éß„É≥„Ç´„Éº„ÉâÊõ¥Êñ∞Èñ¢Êï∞ÔºàËøΩÂä†Ôºâ ==========

        function updateSingleMissionCard(missionId) {
            const mission = normalizedMissions.find(m => m.id === missionId);
            if (!mission) return;

            const state = missionStates[missionId] || { state: 'unaccepted', timerId: null, remainingTime: 0 };
            const stateInfo = getMissionStateInfo(missionId, state);

            const missionCard = document.querySelector(`[data-mission-id="${missionId}"]`);
            if (missionCard) {
                // „Ç´„Éº„ÉâÂÖ®‰Ωì„ÇíÊõ¥Êñ∞
                missionCard.outerHTML = createUnifiedMissionCard(mission, stateInfo);

                // TwemojiÂ§âÊèõ
                const newCard = document.querySelector(`[data-mission-id="${missionId}"]`);
                if (newCard && typeof convertEmojis === 'function') {
                    convertEmojis(newCard);
                }

                console.log(`Âçò‰∏Ä„Ç´„Éº„ÉâÊõ¥Êñ∞: ${missionId}`);
            }
        }

        // ========== Â†±ÈÖ¨ÂèóÂèñÂá¶ÁêÜ‰øÆÊ≠£ ==========

        function claimMissionReward(missionId) {
            console.log(`Â†±ÈÖ¨ÂèóÂèñ: ${missionId}`);

            // Ê≠£Ë¶èÂåñÊ∏à„Åø„Éü„ÉÉ„Ç∑„Éß„É≥„ÇíÂèñÂæó
            const mission = normalizedMissions.find(m => m.id === missionId);
            if (!mission) {
                console.error(`„Éü„ÉÉ„Ç∑„Éß„É≥Ë¶ã„Å§„Åã„Çâ„Åö: ${missionId}`);
                return;
            }

            // Â†±ÈÖ¨„Çí‰ªò‰∏é
            giveRewards(mission.rewards);

            // „Éü„ÉÉ„Ç∑„Éß„É≥Áä∂ÊÖã„ÇíÂèóÂèñÊ∏à„Å´Â§âÊõ¥
            missionStates[missionId] = {
                state: 'claimed',
                timerId: null,
                remainingTime: 0
            };

            // „Éü„ÉÉ„Ç∑„Éß„É≥ÂÆå‰∫Ü„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫
            let rewardText = formatRewards(mission.rewards);
            showMissionCompletePopup(
                `${mission.title}„ÅÆ„Éü„ÉÉ„Ç∑„Éß„É≥`,
                rewardText
            );

            // Ë°®Á§∫„ÇíÊõ¥Êñ∞
            updateDisplay();
            displayCurrentTabMissions();
        }

        function consumeRequirements(requirements) {
            if (!requirements || Object.keys(requirements).length === 0) {
                return true; // Êù°‰ª∂„Å™„Åó„ÅÆÂ†¥Âêà„ÅØOK
            }

            // ÂøÖË¶ÅÁ¥†Êùê„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
            if (requirements.cash && gameState.cash < requirements.cash) {
                return false;
            }
            if (requirements.premium && gameState.premiumCoin < requirements.premium) {
                return false;
            }
            if (requirements.rice && gameState.rice < requirements.rice) {
                return false;
            }
            if (requirements.items) {
                for (const item of requirements.items) {
                    const owned = gameState.inventory[item.id] || 0;
                    if (owned < item.amount) {
                        return false;
                    }
                }
            }

            // ÂÆüÈöõ„Å´Ê∂àË≤ª
            if (requirements.cash) gameState.cash -= requirements.cash;
            if (requirements.premium) gameState.premiumCoin -= requirements.premium;
            if (requirements.rice) gameState.rice -= requirements.rice;
            if (requirements.items) {
                for (const item of requirements.items) {
                    gameState.inventory[item.id] -= item.amount;
                    if (gameState.inventory[item.id] <= 0) {
                        delete gameState.inventory[item.id];
                    }
                }
            }

            return true;
        }

        function giveRewards(rewards) {
            if (rewards.favo) gameState.favo += rewards.favo;
            if (rewards.cash) gameState.cash += rewards.cash;
            if (rewards.premium) gameState.premiumCoin += rewards.premium;
            if (rewards.rice) gameState.rice += rewards.rice;
            if (rewards.items) {
                for (const item of rewards.items) {
                    if (!gameState.inventory[item.id]) {
                        gameState.inventory[item.id] = 0;
                    }
                    gameState.inventory[item.id] += item.amount;
                }
            }
        }

        function switchInfoTab(tabName) {
            // „Çø„Éñ„Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖãÂàá„ÇäÊõø„Åà
            document.querySelectorAll('.info-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeTabButton = document.querySelector(`[data-info-tab="${tabName}"]`);
            if (activeTabButton) {
                activeTabButton.classList.add('active');
            }

            // „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
            document.querySelectorAll('.info-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const activeTabContent = document.getElementById(`info-tab-${tabName}`);
            if (activeTabContent) {
                activeTabContent.classList.add('active');
            }
        }

        // ========== „Ç≤„Éº„É†„Çø„ÉñÂàá„ÇäÊõø„Åà‰øÆÊ≠£ ==========
        function switchGameTab(clickedTab) {
            // „Åô„Åπ„Å¶„ÅÆ„Çø„Éñ„Éú„Çø„É≥„Åã„Çâactive„ÇØ„É©„Çπ„ÇíÂâäÈô§
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Çø„Éñ„Å´active„ÇØ„É©„Çπ„ÇíËøΩÂä†
            clickedTab.classList.add('active');

            // „Åô„Åπ„Å¶„ÅÆ„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÈùûË°®Á§∫
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // ÂØæÂøú„Åô„Çã„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíË°®Á§∫
            const tabName = clickedTab.dataset.tab;
            const targetContent = document.getElementById(`${tabName}-content`);
            if (targetContent) {
                targetContent.classList.add('active');

                // „Éü„ÉÉ„Ç∑„Éß„É≥„Çø„Éñ„ÅÆÂ†¥Âêà„ÅØ„Éü„ÉÉ„Ç∑„Éß„É≥„ÇíË™≠„ÅøËæº„Åø
                if (tabName === 'mission') {
                    // Êñ∞„Ç∑„Çπ„ÉÜ„É†„ÅßÂàùÊúüÂåñ
                    if (normalizedMissions.length === 0) {
                        loadAllMissionData();
                    } else {
                        displayCurrentTabMissions();
                    }
                }

                // Ê†™‰∏ªÂÑ™ÂæÖ„Çø„Éñ„ÅÆÂ†¥Âêà„ÅØ„Ç¢„Ç§„ÉÜ„É†‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
                if (tabName === 'bot') {
                    updateItemGrid();
                }
            }
        }

        function switchBottomTab(clickedTab) {
            // „Åô„Åπ„Å¶„ÅÆ„Çø„Éñ„Éú„Çø„É≥„Åã„Çâactive„ÇØ„É©„Çπ„ÇíÂâäÈô§
            document.querySelectorAll('.bottom-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Çø„Éñ„Å´active„ÇØ„É©„Çπ„ÇíËøΩÂä†
            clickedTab.classList.add('active');

            // „Åô„Åπ„Å¶„ÅÆË°®Á§∫„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÈùûË°®Á§∫
            document.querySelectorAll('.display-content').forEach(content => {
                content.classList.remove('active');
            });

            // ÂØæÂøú„Åô„Çã„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíË°®Á§∫
            if (clickedTab.id === 'bot-adjust-tab') {
                document.getElementById('bot-adjust-content').classList.add('active');
            } else if (clickedTab.id === 'order-list-tab') {
                document.getElementById('order-list-content').classList.add('active');
            }
        }

        function handleGameStart() {
            const nameInput = document.getElementById('name-input');
            if (nameInput && nameInput.value.trim()) {
                gameState.userName = nameInput.value.trim();
            }
            showScreen('game');
        }

        function toggleNameInput() {
            const nameInput = document.getElementById('name-input');
            const nameToggle = document.getElementById('name-toggle');

            if (nameInput && nameToggle) {
                if (nameInput.disabled) {
                    // ÁÑ°Âäπ ‚Üí ÊúâÂäπ
                    nameInput.disabled = false;
                    nameInput.style.background = '#fff';
                    nameInput.style.color = '#333';
                    nameToggle.textContent = 'üìù';
                } else {
                    // ÊúâÂäπ ‚Üí ÁÑ°Âäπ
                    nameInput.disabled = true;
                    nameInput.style.background = '#f5f5f5';
                    nameInput.style.color = '#666';
                    nameToggle.textContent = 'üîí';
                }
            }
        }

        function showScreen(screenName) {
            const titleScreen = document.getElementById('title-screen');
            const gameScreen = document.getElementById('game-screen');

            if (titleScreen) titleScreen.style.display = screenName === 'title' ? 'block' : 'none';
            if (gameScreen) gameScreen.style.display = screenName === 'game' ? 'block' : 'none';

            gameState.currentScreen = screenName;

            if (screenName === 'game') {
                updateDisplay();
            }
        }

        function toggleBot() {
            if (gameState.botEnabled) {
                GameTimerManager.stopBot(); // ‰øÆÊ≠£
            } else {
                GameTimerManager.startBot(); // ‰øÆÊ≠£
            }

            // UIÊõ¥Êñ∞ÔºàÊó¢Â≠ò„Ç≥„Éº„ÉâÔºâ
            const botToggle = document.getElementById('bot-toggle');
            if (botToggle) {
                botToggle.innerHTML = gameState.botEnabled ? 'BOT<br>ON' : 'BOT<br>OFF';
                botToggle.className = gameState.botEnabled ? 'bot-toggle-btn active' : 'bot-toggle-btn';
            }
        }

        function updateDisplay() {
            // „Éò„ÉÉ„ÉÄ„ÉºÊõ¥Êñ∞
            document.getElementById('header-username').textContent = gameState.userName;
            document.getElementById('header-userid').textContent = gameState.userId;
            document.getElementById('header-premium').textContent = gameState.premiumCoin.toLocaleString();
            document.getElementById('header-cash').textContent = gameState.cash.toLocaleString();
            document.getElementById('header-rice').textContent = gameState.rice.toLocaleString();
            document.getElementById('header-favo').textContent = gameState.favo.toLocaleString();
            document.getElementById('header-voting').textContent = gameState.voting.toLocaleString();

            // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
            document.getElementById('status-orders').textContent = debugState.orders + '‰ª∂';
            document.getElementById('status-position').textContent = debugState.positionAmount.toLocaleString() + 'ÂÜÜ';
            document.getElementById('status-credit-margin').textContent = debugState.clicksSinceLastGacha + 'Âõû';

            // ‰ø°Áî®Âª∫„Å¶‰ΩôÂäõ„ÅÆ„Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏Êõ¥Êñ∞
            const creditMargin = gameState.cash * 3.3 - debugState.positionAmount;
            const maxPositive = gameState.cash * 3.3;
            const marginPercentage = Math.round((creditMargin / maxPositive) * 100);

            // „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊåáÊ®ôÊõ¥Êñ∞
            document.getElementById('perf-cps').textContent = debugState.cps + 'Âõû/Áßí';
            document.getElementById('perf-get-rate').textContent = debugState.getRate + 'ÂÄç';
            document.getElementById('perf-load-rate').textContent = debugState.loadRate + '%';
            document.getElementById('perf-fire-rate').textContent = debugState.fireRate + '%';

            // ‰ø°Áî®Âª∫„Å¶‰ΩôÂäõ„Éê„ÉºÊõ¥Êñ∞
            updateCreditMarginBar();

            // „Çµ„Éº„Éê„ÉºHP„Éê„ÉºÊõ¥Êñ∞
            updateServerHPBar();

            // „Çµ„Éº„Éê„Éº„ÉÄ„Ç¶„É≥UIÊõ¥Êñ∞
            updateServerDownUI();

            // „Ç¨„ÉÅ„É£„Éú„Çø„É≥Áä∂ÊÖãÊõ¥Êñ∞
            updateGachaButtonState();

            // Ê®™Ëª¢Âà§ÂÆö
            checkRollover();
        }

        function updateGachaButtonState() {
            const gachaButton = document.getElementById('gacha-button');
            if (!gachaButton) return;

            // „Çµ„Éº„Éê„Éº„ÉÄ„Ç¶„É≥‰∏≠„ÅØË¨ùÁΩ™„Éú„Çø„É≥ÂÑ™ÂÖà
            if (debugState.isServerDown) {
                return; // updateServerDownUI()„ÅßÂá¶ÁêÜÊ∏à„Åø
            }

            // preÁèæÊ∏°Áä∂ÊÖã„ÅÆÂ†¥Âêà
            if (debugState.isPreGacha) {
                gachaButton.textContent = 'ÁèæÊ∏°';
                gachaButton.className = 'gacha-btn-unified pink';
                gachaButton.disabled = false;
                return;
            }

            // Ê≥®Êñá‰ª∂Êï∞„Å´Âøú„Åò„ÅüÁä∂ÊÖãÂàá„ÇäÊõø„Åà
            if (debugState.orders === 0) {
                // „Ç∞„É¨„Éº„Ç¢„Ç¶„ÉàÁä∂ÊÖã
                gachaButton.textContent = 'ÁèæÂºï„Åç';
                gachaButton.className = 'gacha-btn-unified disabled';
                gachaButton.disabled = true;
            } else {
                // ÈªÑËâ≤Áä∂ÊÖãÔºàÊ≥®Êñá‰ª∂Êï∞1‰ª•‰∏äÔºâ
                gachaButton.textContent = 'ÁèæÂºï„Åç';
                gachaButton.className = 'gacha-btn-unified yellow';
                gachaButton.disabled = false;
            }
        }

        // ========== „Ç¨„ÉÅ„É£Âá¶ÁêÜÊ©üËÉΩÔºàPhase 2: 4ÊÆµÈöéÊäΩÈÅ∏„Ç®„É≥„Ç∏„É≥Ôºâ ==========

        // „Ç¨„ÉÅ„É£„Çø„Ç§„ÉóÂèñÂæó
        function getGachaType() {
            // ÁèæÂú®„ÅØ"standard"Âõ∫ÂÆö
            return gachaData?.defaultGacha || 'standard';
        }

        // Stage 1: „Ç´„ÉÜ„Ç¥„É™ÊäΩÈÅ∏
        function stage1_rollCategory(gachaType) {
            const gacha = gachaData?.gachaTypes?.[gachaType];
            if (!gacha || !gacha.stage1_categories) {
                console.error('Stage1Ë®≠ÂÆö„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }

            const categories = gacha.stage1_categories;
            const totalWeight = categories.reduce((sum, cat) => sum + cat.weight, 0);
            const random = Math.random() * totalWeight;

            let cumulative = 0;
            for (const category of categories) {
                cumulative += category.weight;
                if (random < cumulative) {
                    console.log(`Stage1: ${category.type} (${category.description})`);
                    return category.type;
                }
            }
        }

        // Stage 2: Êï∞ÈáèÊäΩÈÅ∏ÔºàÁèæÈáë„ÉªPTC„Éª„ÅäÁ±≥Áî®Ôºâ
        function stage2_rollAmount(gachaType, categoryType) {
            const gacha = gachaData?.gachaTypes?.[gachaType];
            if (!gacha || !gacha.stage2_amounts || !gacha.stage2_amounts[categoryType]) {
                console.error('Stage2Ë®≠ÂÆö„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }

            const amounts = gacha.stage2_amounts[categoryType];
            const totalWeight = amounts.reduce((sum, amt) => sum + amt.weight, 0);
            const random = Math.random() * totalWeight;

            let cumulative = 0;
            for (const amount of amounts) {
                cumulative += amount.weight;
                if (random < cumulative) {
                    console.log(`Stage2: ${amount.amount}${categoryType === 'rice' ? 'kg' : 'ÂÜÜ/Êûö'}`);
                    return amount.amount;
                }
            }
        }

        // Stage 3: „É¨„Ç¢„É™„ÉÜ„Ç£ÊäΩÈÅ∏Ôºà„Ç¢„Ç§„ÉÜ„É†Áî®Ôºâ
        function stage3_rollRarity(gachaType) {
            const gacha = gachaData?.gachaTypes?.[gachaType];
            if (!gacha || !gacha.stage3_rarities) {
                console.error('Stage3Ë®≠ÂÆö„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }

            const rarities = gacha.stage3_rarities;
            const totalWeight = rarities.reduce((sum, rar) => sum + rar.weight, 0);
            const random = Math.random() * totalWeight;

            let cumulative = 0;
            for (const rarity of rarities) {
                cumulative += rarity.weight;
                if (random < cumulative) {
                    console.log(`Stage3: „É¨„Ç¢„É™„ÉÜ„Ç£ ${rarity.rarity}`);
                    return rarity.rarity;
                }
            }
        }

        // Stage 4: ÂÖ∑‰ΩìÁöÑ„Å™„Ç¢„Ç§„ÉÜ„É†ÊäΩÈÅ∏ÔºàGIDÂªÉÊ≠¢Ôºâ
        function stage4_rollItem(gachaType, rarity) {
            console.log(`Stage4ÈñãÂßã: ${gachaType}„Ç¨„ÉÅ„É£, ${rarity}„É¨„Ç¢„É™„ÉÜ„Ç£`);

            const rarityItems = itemData.items.filter(item => item.rarity === rarity);
            const gacha = gachaData.gachaTypes[gachaType];
            const overrides = gacha.stage4_item_overrides[rarity];

            console.log(`${rarity}„É¨„Ç¢„É™„ÉÜ„Ç£„Ç¢„Ç§„ÉÜ„É†Êï∞: ${rarityItems.length}`);

            // ÂêÑ„Ç¢„Ç§„ÉÜ„É†„ÅÆÈáç„Åø„ÇíË®≠ÂÆöÔºà„Éá„Éï„Ç©„É´„Éà1Ôºâ
            const itemWeights = {};
            rarityItems.forEach(item => {
                itemWeights[item.id] = 1;
            });

            // „Ç™„Éº„Éê„Éº„É©„Ç§„ÉâÈÅ©Áî®ÔºàitemId„Éô„Éº„Çπ„ÅÆ„ÅøÔºâ
            if (overrides) {
                overrides.forEach(override => {
                    itemWeights[override.itemId] = override.weight;
                    console.log(`Èáç„ÅøË®≠ÂÆö: ${override.itemId} ‚Üí ${override.weight}`);
                });
            }

            // Èáç„Åø‰ªò„ÅçÊäΩÈÅ∏
            const totalWeight = rarityItems.reduce((sum, item) => sum + itemWeights[item.id], 0);
            const random = Math.random() * totalWeight;

            let cumulative = 0;
            for (const item of rarityItems) {
                cumulative += itemWeights[item.id];
                if (random < cumulative) {
                    console.log(`Stage4ÁµêÊûú: ${item.id} (${item.name})`);
                    return item;
                }
            }
        }

        // Êñ∞„Åó„ÅÑrollSingleGachaÈñ¢Êï∞Ôºà4ÊÆµÈöéÊäΩÈÅ∏try-catchÂâäÈô§Ôºâ
        function rollSingleGacha() {
            console.log('=== „Ç¨„ÉÅ„É£ÊäΩÈÅ∏ÈñãÂßã ===');

            const gachaType = getGachaType();
            const category = stage1_rollCategory(gachaType);

            if (category === 'cash' || category === 'premium' || category === 'rice') {
                const amount = stage2_rollAmount(gachaType, category);
                const result = {
                    type: category,
                    amount: amount,
                    name: category === 'cash' ? `ÁèæÈáë${amount.toLocaleString()}ÂÜÜ` :
                        category === 'premium' ? `„Éó„É¨„Éü„Ç¢„É†„Ç≥„Ç§„É≥${amount}Êûö` :
                            `„ÅäÁ±≥${amount}kg`
                };
                console.log('ÊäΩÈÅ∏ÁµêÊûú:', result);
                return result;

            } else if (category === 'item') {
                const rarity = stage3_rollRarity(gachaType);
                const item = stage4_rollItem(gachaType, rarity);
                const result = { ...item, type: 'item' };
                console.log('ÊäΩÈÅ∏ÁµêÊûú:', result);
                return result;
            }
        }

        // „Ç¢„Ç§„ÉÜ„É†ID„Åã„ÇâÂçò‰Ωç„ÇíÂèñÂæó
        function getItemUnit(itemId) {
            if (itemId.startsWith('quo_')) return 'Êûö';     // QUO„Ç´„Éº„Éâ
            if (itemId.startsWith('yutai_')) return 'Êûö';   // ÂÑ™ÂæÖÂà∏
            if (itemId.startsWith('cosm_')) return 'ÂÄã';    // ÂåñÁ≤ßÂìÅ
            return 'ÂÄã'; // „Éá„Éï„Ç©„É´„Éà
        }

        function executeGacha() {
            const gachaCount = debugState.orders;
            const results = [];

            console.log(`„Ç¨„ÉÅ„É£Áô∫ÁÅ´ÈñãÂßã - ${gachaCount}ÂõûÊäΩÈÅ∏`);

            // Ê≥®Êñá‰ª∂Êï∞ÂàÜ„Å†„ÅëÊäΩÈÅ∏
            for (let i = 0; i < gachaCount; i++) {
                const result = rollSingleGacha();
                if (result) {
                    results.push(result);
                    console.log(`${i + 1}ÂõûÁõÆ:`, result.name);
                }
            }

            // ÁµêÊûú„ÇíÂá¶ÁêÜÔºà„Ç¢„Ç§„ÉÜ„É†„Å®ÁèæÈáëÁ≠â„ÇíÂàÜÈõ¢Ôºâ
            processGachaResults(results);

            // „Ç¨„ÉÅ„É£ÁµêÊûú„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫
            showGachaResult(results);

            // Ê≥®Êñá‰ª∂Êï∞„ÉªÂª∫ÁéâÈáëÈ°ç„Çí„É™„Çª„ÉÉ„Éà„ÉªÁä∂ÊÖãÂæ©Â∏∞
            debugState.orders = 0;
            debugState.positionAmount = 0; // Âª∫ÁéâÈáëÈ°ç„ÇÇ„É™„Çª„ÉÉ„Éà
            debugState.clicksSinceLastGacha = 0; // Á∑è„Ç¢„ÇØ„Çª„ÇπÊï∞„É™„Çª„ÉÉ„Éà
            exitPreGachaMode();

            return results;
        }

        // „Ç¨„ÉÅ„É£ÁµêÊûú„ÅÆÂá¶ÁêÜÔºàÊñ∞Ë¶èËøΩÂä†Ôºâ
        function processGachaResults(results) {
            for (const result of results) {
                switch (result.type) {
                    case 'cash':
                        gameState.cash += result.amount;
                        console.log(`ÁèæÈáë +${result.amount}ÂÜÜ (ÂêàË®à: ${gameState.cash}ÂÜÜ)`);
                        break;
                    case 'premium':
                        gameState.premiumCoin += result.amount;
                        console.log(`PTC +${result.amount}Êûö (ÂêàË®à: ${gameState.premiumCoin}Êûö)`);
                        break;
                    case 'rice':
                        gameState.rice += result.amount;
                        console.log(`„ÅäÁ±≥ +${result.amount}kg (ÂêàË®à: ${gameState.rice}kg)`);
                        break;
                    case 'item':
                        // Êó¢Â≠ò„ÅÆ„Ç§„É≥„Éô„É≥„Éà„É™„Ç∑„Çπ„ÉÜ„É†„ÅßÂá¶ÁêÜ
                        if (!gameState.inventory) {
                            gameState.inventory = {};
                        }
                        if (gameState.inventory[result.id]) {
                            gameState.inventory[result.id] += 1;
                        } else {
                            gameState.inventory[result.id] = 1;
                        }
                        console.log(`„Ç¢„Ç§„ÉÜ„É† +${result.name}`);
                        break;
                }
            }

            // Ë°®Á§∫„ÇíÊõ¥Êñ∞
            updateDisplay();
        }

        function showGachaResult(results) {
            // ÁµêÊûú„ÇíÈõÜË®à„Éª„É¨„Ç¢„É™„ÉÜ„Ç£Âà•„ÇΩ„Éº„Éà
            const summary = summarizeGachaResults(results);

            // „Ç™„Éº„Éê„Éº„É¨„Ç§‰ΩúÊàê
            const overlay = document.createElement('div');
            overlay.className = 'gacha-overlay';

            // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó‰ΩúÊàê
            const popup = document.createElement('div');
            popup.className = 'gacha-result-popup';

            // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÂÜÖÂÆπÁîüÊàê
            popup.innerHTML = createGachaResultHTML(summary);

            overlay.appendChild(popup);
            document.body.appendChild(overlay);

            // „ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„ÇãÔºàÊâãÂãï„ÅÆ„ÅøÔºâ
            overlay.addEventListener('click', function () {
                document.body.removeChild(overlay);
            });
        }

        function summarizeGachaResults(results) {
            const summary = {
                cash: 0,
                premium: 0,
                rice: 0,
                items: {}
            };

            for (const result of results) {
                switch (result.type) {
                    case 'cash':
                        summary.cash += result.amount;
                        break;
                    case 'premium':
                        summary.premium += result.amount;
                        break;
                    case 'rice':
                        summary.rice += result.amount;
                        break;
                    case 'item':
                        const key = `${result.rarity}-${result.id}`;
                        if (summary.items[key]) {
                            summary.items[key].count += 1;
                        } else {
                            summary.items[key] = {
                                ...result,
                                count: 1
                            };
                        }
                        break;
                }
            }

            return summary;
        }

        function createGachaResultHTML(summary) {
            let html = '<div class="gacha-result-title">Ê≥®ÊñáÁ¥ÑÂÆö‰∏ÄË¶ß</div>';

            // ÁèæÈáëË°®Á§∫ÔºàÂ∑¶Âè≥ÂàÜÂâ≤Ôºâ
            if (summary.cash > 0) {
                html += `<div class="gacha-result-section">`;
                html += `<div class="gacha-item-list">`;
                html += `<div class="gacha-item" style="display: flex; justify-content: space-between;">`;
                html += `<span>üí¥„ÄÄÁèæÈáë</span><span>${summary.cash.toLocaleString()}ÂÜÜ</span>`;
                html += `</div></div></div>`;
            }

            // „Éó„É¨„Éü„Ç¢„É†„Ç≥„Ç§„É≥Ë°®Á§∫ÔºàÂ∑¶Âè≥ÂàÜÂâ≤Ôºâ
            if (summary.premium > 0) {
                html += `<div class="gacha-result-section">`;
                html += `<div class="gacha-item-list">`;
                html += `<div class="gacha-item" style="display: flex; justify-content: space-between;">`;
                html += `<span>ü™ô„ÄÄ„Éó„É¨„Éü„Ç¢„É†„Ç≥„Ç§„É≥</span><span>${summary.premium.toLocaleString()}Êûö</span>`;
                html += `</div></div></div>`;
            }

            // „ÅäÁ±≥Ë°®Á§∫ÔºàÂ∑¶Âè≥ÂàÜÂâ≤Ôºâ
            if (summary.rice > 0) {
                html += `<div class="gacha-result-section">`;
                html += `<div class="gacha-item-list">`;
                html += `<div class="gacha-item" style="display: flex; justify-content: space-between;">`;
                html += `<span>üçô„ÄÄ„ÅäÁ±≥</span><span>${summary.rice.toLocaleString()}kg</span>`;
                html += `</div></div></div>`;
            }

            // „Ç¢„Ç§„ÉÜ„É†Ë°®Á§∫Ôºà„É¨„Ç¢„É™„ÉÜ„Ç£Âà•„ÉªÂ∑¶Âè≥ÂàÜÂâ≤Ôºâ
            const itemsByRarity = {};
            for (const item of Object.values(summary.items)) {
                if (!itemsByRarity[item.rarity]) {
                    itemsByRarity[item.rarity] = [];
                }
                itemsByRarity[item.rarity].push(item);
            }

            // S, A, B, CÈ†Ü„ÅßË°®Á§∫
            const rarities = ['S', 'A', 'B', 'C'];
            for (const rarity of rarities) {
                if (itemsByRarity[rarity]) {
                    html += `<div class="gacha-result-section">`;
                    html += `<div class="gacha-rarity-header rarity-${rarity.toLowerCase()}">${rarity}„É©„É≥„ÇØ</div>`;
                    html += `<div class="gacha-item-list">`;

                    for (const item of itemsByRarity[rarity]) {
                        const emoji = item.emoji || 'üí≥';
                        const unit = getItemUnit(item.id);  // Âçò‰ΩçÂèñÂæó
                        html += `<div class="gacha-item" style="display: flex; justify-content: space-between;">`;
                        html += `<span>${emoji}„ÄÄ${item.name}</span><span>${item.count}${unit}</span>`;
                        html += `</div>`;
                    }

                    html += `</div></div>`;
                }
            }

            html += '<div class="gacha-close-hint">„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã</div>';
            return html;
        }

        function enterPreGachaMode() {
            debugState.isPreGacha = true;
            updateDisplay();
        }

        function exitPreGachaMode() {
            debugState.isPreGacha = false;
            updateDisplay();
        }

        function updateServerHPBar() {
            const serverHPFill = document.getElementById('server-hp-fill');
            if (!serverHPFill) return;

            // HPÂâ≤ÂêàË®àÁÆó
            const hpPercentage = (debugState.serverHP / debugState.maxServerHP) * 100;

            // „Éê„ÉºÂπÖÊõ¥Êñ∞
            serverHPFill.style.width = hpPercentage + '%';

            // Ëâ≤„ÇØ„É©„ÇπË®≠ÂÆö
            serverHPFill.className = 'server-hp-fill';
            if (hpPercentage > 50) {
                serverHPFill.classList.add('high');
            } else if (hpPercentage > 25) {
                serverHPFill.classList.add('medium');
            } else {
                serverHPFill.classList.add('low');
            }
        }

        function updateCreditMarginBar() {
            const creditMarginFill = document.getElementById('credit-margin-fill');
            const creditMarginLabel = document.getElementById('credit-margin-label');
            if (!creditMarginFill || !creditMarginLabel) return;

            // ‰ΩôÂäõË®àÁÆó: ÁèæÈáëÊÆãÈ´ò √ó 3.3 - Âª∫ÁéâÈáëÈ°ç
            const creditMargin = gameState.cash * 3.3 - debugState.positionAmount;
            const maxPositive = gameState.cash * 3.3;

            // „Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏Ë®àÁÆó
            const marginPercentage = Math.round((creditMargin / maxPositive) * 100);

            // „É©„Éô„É´Êõ¥Êñ∞
            creditMarginLabel.textContent = `‰ø°Áî®Âª∫„Å¶‰ΩôÂäõÔºö${marginPercentage}%`;

            // „Éê„ÉºË°®Á§∫Áî®„ÅÆÂÄ§„Å®„ÇØ„É©„ÇπÊ±∫ÂÆö
            let percentage;
            let className;

            if (creditMargin >= 0) {
                // „Éó„É©„ÇπÈ†òÂüü (0% ÔΩû 100%) - Ê∞¥Ëâ≤
                percentage = Math.min((creditMargin / maxPositive) * 100, 100);
                className = 'credit-margin-fill positive';
            } else {
                // „Éû„Ç§„Éä„ÇπÈ†òÂüü„ÅÆÊÆµÈöéÂà§ÂÆö
                const absPercentage = Math.abs(marginPercentage);
                const stage = Math.floor(absPercentage / 100);

                // ÂêÑÊÆµÈöéÂÜÖ„Åß„ÅÆÈÄ≤Êçó (0-100%)
                const stageProgress = absPercentage % 100;
                percentage = stageProgress;

                // ÊÆµÈöé„Å´Âøú„Åò„ÅüËâ≤Ë®≠ÂÆö
                const colorClasses = [
                    'credit-margin-fill warning',    // 0-100%: ÈªÑËâ≤
                    'credit-margin-fill orange',     // 100-200%: „Ç™„É¨„É≥„Ç∏
                    'credit-margin-fill negative',   // 200-300%: Ëµ§Ëâ≤
                    'credit-margin-fill danger',     // 300-400%: ÊøÉËµ§Ëâ≤
                    'credit-margin-fill critical'    // 400-500%+: ÈªíËâ≤
                ];

                className = colorClasses[Math.min(stage, colorClasses.length - 1)];

                // -500%Ë∂Ö„Åà„ÅÆÂ†¥Âêà„ÅØ100%Âõ∫ÂÆö
                if (absPercentage >= 500) {
                    percentage = 100;
                }
            }

            creditMarginFill.className = className;
            creditMarginFill.style.width = percentage + '%';
        }
        // ========== Ê†™‰∏ªÂÑ™ÂæÖ„Éú„Çø„É≥Âàá„ÇäÊõø„ÅàÊ©üËÉΩÔºàËøΩÂä†Ôºâ ==========
        function initUpgradeButtons() {
            document.querySelectorAll('.upgrade-button').forEach(button => {
                button.addEventListener('click', function () {
                    const contentName = this.dataset.upgradeContent;

                    // ÂÖ®„Å¶„ÅÆ„Éú„Çø„É≥„Åã„Çâactive„ÇØ„É©„Çπ„ÇíÂâäÈô§
                    document.querySelectorAll('.upgrade-button').forEach(btn => {
                        btn.classList.remove('active');
                    });

                    // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Éú„Çø„É≥„Å´active„ÇØ„É©„Çπ„ÇíËøΩÂä†
                    this.classList.add('active');

                    // ÂÖ®„Å¶„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÈùûË°®Á§∫
                    document.querySelectorAll('.upgrade-content').forEach(content => {
                        content.classList.remove('active');
                    });

                    // ÂØæÂøú„Åô„Çã„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíË°®Á§∫
                    const targetContent = document.getElementById(`upgrade-content-${contentName}`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                });
            });
        }
        // ==========„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„Ç∑„Çπ„ÉÜ„É†ÔºàËøΩÂä†Ôºâ ==========
        // „Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„Éá„Éº„Çø„ÅØupgrade.json„Å´ÁßªÂãï„Åó„Åæ„Åó„Åü
        // ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ
        let selectedUpgrade = 'bot_speed';

        // Ë©≥Á¥∞„Ç´„Éº„Éâ„ÇíÊõ¥Êñ∞
        function updateUpgradeDetailCard(upgradeId) {
            if (!upgradeJsonData || !upgradeJsonData.upgrades[upgradeId]) return;

            const data = upgradeJsonData.upgrades[upgradeId];
            const currentLevel = upgradeProgress[upgradeId] || 0;

            document.getElementById('detail-icon').textContent = data.icon;
            document.getElementById('detail-name').textContent = data.name;
            document.getElementById('detail-level').textContent = `Lv.${currentLevel} (ÊúÄÂ§ßÔºö${data.maxLevel})`;
            document.getElementById('detail-description').innerHTML = data.description.replace(/\n/g, '<br>');
            // ÂäπÊûúË™¨Êòé
            if (currentLevel < data.maxLevel) {
                document.getElementById('detail-effect').textContent = data.effects.descriptions[currentLevel];
            } else {
                document.getElementById('detail-effect').textContent = 'MAX';
            }

            // „Ç≥„Çπ„ÉàË°®Á§∫
            if (currentLevel < data.maxLevel) {
                document.getElementById('detail-cost').textContent = data.costs[currentLevel];
            } else {
                document.getElementById('detail-cost').textContent = '-';
            }

            // „Éú„Çø„É≥Áä∂ÊÖã
            const upgradeBtn = document.getElementById('upgrade-action-btn');
            if (upgradeBtn) {
                if (currentLevel >= data.maxLevel) {
                    upgradeBtn.textContent = 'MAX';
                    upgradeBtn.disabled = true;
                } else if (gameState.premiumCoin < data.costs[currentLevel]) {
                    upgradeBtn.textContent = '„Ç≥„Ç§„É≥‰∏çË∂≥';
                    upgradeBtn.disabled = true;
                } else {
                    upgradeBtn.textContent = '„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ';
                    upgradeBtn.disabled = false;
                }
            }
        }
        // „Ç∞„É™„ÉÉ„Éâ„Ç¢„Ç§„ÉÜ„É†„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
        function updateUpgradeGridItem(upgradeId) {
            const item = document.querySelector(`[data-upgrade="${upgradeId}"]`);
            if (!item) return;

            const currentLevel = upgradeProgress[upgradeId] || 0;
            const levelElement = item.querySelector('.upgrade-item-level');

            if (levelElement) {
                levelElement.textContent = `Lv.${currentLevel}`;
            }
        }
        // „Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„ÉâÂÆüË°å
        function executeUpgrade(upgradeId) {
            if (!upgradeJsonData || !upgradeJsonData.upgrades[upgradeId]) return;

            const data = upgradeJsonData.upgrades[upgradeId];
            const currentLevel = upgradeProgress[upgradeId] || 0;

            // Êù°‰ª∂„ÉÅ„Çß„ÉÉ„ÇØ
            if (currentLevel >= data.maxLevel) {
                alert('„Åô„Åß„Å´ÊúÄÂ§ß„É¨„Éô„É´„Åß„ÅôÔºÅ');
                return;
            }

            if (gameState.premiumCoin < data.costs[currentLevel]) {
                alert('„Éó„É¨„Éü„Ç¢„É†„Ç≥„Ç§„É≥„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅ');
                return;
            }

            // „Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„ÉâÂÆüË°å
            gameState.premiumCoin -= data.costs[currentLevel];
            upgradeProgress[upgradeId] = currentLevel + 1;

            // ÂÆüÈöõ„ÅÆÂäπÊûúÈÅ©Áî®ÔºàBOTÂº∑Âåñ„ÅÆÂ†¥ÂêàÔºâ
            if (upgradeId === 'bot_speed') {
                // JSONÂèÇÁÖß„ÅßBOTÈÄüÂ∫¶„ÇíË®≠ÂÆö
                if (upgradeJsonData && upgradeJsonData.upgrades.bot_speed) {
                    const newLevel = upgradeProgress.bot_speed || 0;
                    if (newLevel > 0) {
                        const speedValue = upgradeJsonData.upgrades.bot_speed.effects.values[newLevel - 1];
                        GameTimerManager.updateBotSpeed(speedValue); // ‰øÆÊ≠£
                    } else {
                        GameTimerManager.updateBotSpeed(1000); // ‰øÆÊ≠£
                    }
                }

                // BOT„ÅÆÈñìÈöî„ÇíÂÜçË®≠ÂÆö
                if (gameState.botEnabled) {
                    stopBot();
                    startBot();
                }
            }

            // Ë°®Á§∫Êõ¥Êñ∞
            updateDisplay();
            updateUpgradeDetailCard(upgradeId);
            updateUpgradeGridItem(upgradeId);

            const newLevel = upgradeProgress[upgradeId];
            showUpgradeSuccessPopup(`${data.icon} ${data.name}`, newLevel, data.effects.descriptions[newLevel - 1]);
        }

        // „Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ
        function initUpgradeSystem() {
            // „Ç∞„É™„ÉÉ„Éâ„Ç¢„Ç§„ÉÜ„É†„ÇØ„É™„ÉÉ„ÇØ
            document.querySelectorAll('.upgrade-item').forEach(item => {
                item.addEventListener('click', function () {
                    // ÂÖ®„Å¶„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
                    document.querySelectorAll('.upgrade-item').forEach(i => i.classList.remove('selected'));

                    // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Ç¢„Ç§„ÉÜ„É†„ÇíÈÅ∏Êäû
                    this.classList.add('selected');

                    // Ë©≥Á¥∞„Ç´„Éº„Éâ„ÇíÊõ¥Êñ∞
                    const upgradeId = this.dataset.upgrade;
                    selectedUpgrade = upgradeId;
                    updateUpgradeDetailCard(upgradeId);
                });
            });

            // „Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ
            const upgradeBtn = document.getElementById('upgrade-action-btn');
            if (upgradeBtn) {
                upgradeBtn.addEventListener('click', function () {
                    if (!this.disabled) {
                        executeUpgrade(selectedUpgrade);
                    }
                });
            }

            // ÂàùÊúüË°®Á§∫ÔºàJSONË™≠„ÅøËæº„ÅøÂæå„ÅÆ„ÅøÔºâ
            if (upgradeJsonData) {
                updateUpgradeDetailCard(selectedUpgrade);
            }
        }

        // Ê±éÁî®„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫Èñ¢Êï∞Ôºà„ÇØ„É™„Éº„É≥ÁâàÔºâ
        function showUniversalPopup(config) {
            // „Ç™„Éº„Éê„Éº„É¨„Ç§‰ΩúÊàê
            const overlay = document.createElement('div');
            overlay.className = 'universal-popup-overlay';

            // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó‰ΩúÊàê
            const popup = document.createElement('div');
            popup.className = `universal-popup popup-${config.type}`;

            // ÂÜÖÂÆπÁîüÊàê
            let content = `
                <div class="universal-popup-title">${config.title}</div>
            `;

            if (config.customHTML) {
                content += config.customHTML;
            } else {
                content += `
                    <div class="universal-popup-content">${config.content}</div>
                `;
            }

            // „ÇØ„É™„ÉÉ„ÇØÁÑ°ÂäπÊôÇ„ÅØ„Äå„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã„ÄçË°®Á§∫„ÇíÂ§âÊõ¥
            if (config.disableClick && config.autoClose) {
                content += '<div class="universal-popup-close-hint">Ëá™Âãï„ÅßÈñâ„Åò„Åæ„Åô</div>';
            } else {
                content += '<div class="universal-popup-close-hint">„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã</div>';
            }

            popup.innerHTML = content;
            overlay.appendChild(popup);
            document.body.appendChild(overlay);

            // „ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„ÇãÔºàÁÑ°ÂäπË®≠ÂÆö„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÔºâ
            if (!config.disableClick) {
                overlay.addEventListener('click', function () {
                    if (overlay.parentNode) {
                        document.body.removeChild(overlay);
                    }
                });
            }

            // Ëá™ÂãïÊ∂àÂéª„Çø„Ç§„Éû„ÉºÔºàË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºâ
            if (config.autoClose) {
                setTimeout(() => {
                    if (overlay.parentNode) {
                        document.body.removeChild(overlay);
                    }
                }, config.autoClose);
            }

            // ÁµµÊñáÂ≠óÂ§âÊèõ
            if (typeof convertEmojis === 'function') {
                convertEmojis(popup);
            }
        }

        // „Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„ÉâÊàêÂäü„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó
        function showUpgradeSuccessPopup(upgradeName, currentLevel, effect) {
            showUniversalPopup({
                title: "„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„ÉâÊàêÂäüÔºÅ",
                content: `
                    <div style="font-size: 24px; margin: 10px 0;">${upgradeName}</div>
                    <div style="font-size: 16px; font-weight: bold; color: #4caf50; margin: 10px 0;">
                        Lv.${currentLevel - 1} ‚Üí Lv.${currentLevel}
                    </div>
                    <div style="font-size: 14px; color: #666; margin: 10px 0;">
                        ÂäπÊûú: ${effect}
                    </div>
                `,
                type: "success"
            });
        }

        // „Çµ„Éº„Éê„ÉºÂÄíÂ£ä„Ç®„É©„Éº„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó
        function showErrorPopup(title, message) {
            showUniversalPopup({
                title: title,
                content: message,
                type: "error"
            });
        }
        // Ê®™Ëª¢Áî®„Ç®„É©„Éº„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÔºà„ÇØ„É™„ÉÉ„ÇØÁÑ°Âäπ + 2ÁßíÂº∑Âà∂Ë°®Á§∫Ôºâ
        function showRolloverPopup(title, message) {
            showUniversalPopup({
                title: title,
                content: message,
                type: "error",
                autoClose: 2000,    // 2ÁßíÂæå„Å´Ëá™Âãï„ÅßÈñâ„Åò„Çã
                disableClick: true  // „ÇØ„É™„ÉÉ„ÇØÁÑ°Âäπ
            });
        }

        // „Éü„ÉÉ„Ç∑„Éß„É≥ÂÆå‰∫Ü„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó
        function showMissionCompletePopup(missionName, reward) {
            showUniversalPopup({
                title: "„Éü„ÉÉ„Ç∑„Éß„É≥ÂÆå‰∫ÜÔºÅ",
                content: `
                    <div style="font-size: 18px; margin: 10px 0;">${missionName}</div>
                    <div style="font-size: 16px; font-weight: bold; color: #ff9800; margin: 10px 0;">
                        Â†±ÈÖ¨: ${reward}
                    </div>
                `,
                type: "warning"
            });
        }

        // ========== Ê®™Ëª¢„Ç∑„Çπ„ÉÜ„É†ÔºàËøΩÂä†Ôºâ ==========
        // Ê®™Ëª¢Âà§ÂÆö„ÉªÂá¶ÁêÜÈñ¢Êï∞
        function checkRollover() {
            // Âü∫Êú¨‰ΩôÂäõË®àÁÆó
            const basicMargin = gameState.cash * 3.3 - debugState.positionAmount;
            const maxPositive = gameState.cash * 3.3;
            const marginPercentage = (basicMargin / maxPositive) * 100;

            // Ê®™Ëª¢ÂõûÈÅø„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„É¨„Éô„É´ÂèñÂæó
            const rolloverLevel = upgradeProgress.rollover_avoid || 0;
            const rolloverThreshold = rolloverLevel * 100; // Lv1=100%, Lv2=200%...

            // Ê®™Ëª¢Êù°‰ª∂„ÉÅ„Çß„ÉÉ„ÇØ
            const shouldRollover = marginPercentage < -rolloverThreshold;

            // Ê®™Ëª¢Âá¶ÁêÜ
            if (shouldRollover && debugState.orders > 0 && !debugState.isRollover) {
                // Ê®™Ëª¢Áô∫Âãï
                triggerRollover();
            } else if (debugState.orders === 0 && debugState.isRollover) {
                // Ê≥®Êñá„Åå0„Å´„Å™„Å£„Åü„ÇâÊ®™Ëª¢„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
                debugState.isRollover = false;
            }
        }
        // Ê®™Ëª¢Âá¶ÁêÜÂÆüË°åÔºà„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóËøΩÂä†ÁâàÔºâ
        function triggerRollover() {
            // Â§±Âäπ„Åô„ÇãÊ≥®Êñá‰ª∂Êï∞„ÇíË®òÈå≤
            const lostOrders = debugState.orders;

            console.log('Ê®™Ëª¢Áô∫ÁîüÔºÅÊ≥®Êñá‰ª∂Êï∞:', lostOrders);

            // Ê®™Ëª¢„Éï„É©„Ç∞Ë®≠ÂÆö
            debugState.isRollover = true;

            // Ê≥®Êñá„ÉªÂª∫Áéâ„É™„Çª„ÉÉ„Éà
            debugState.orders = 0;
            debugState.positionAmount = 0;

            // Ê®™Ëª¢„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫
            showRolloverPopup("Ê®™Ëª¢„Åó„Åæ„Åó„ÅüÔºÅ", `${lostOrders}‰ª∂„ÅÆÊ≥®Êñá„ÅåÂ§±Âäπ„Åó„Åæ„Åó„ÅüÔºÅ`);

            // Ë°®Á§∫Êõ¥Êñ∞
            updateDisplay();
        }
        // ========== „Ç¢„Ç§„ÉÜ„É†‰∏ÄË¶ß„Ç∑„Çπ„ÉÜ„É†ÔºàËøΩÂä†Ôºâ ==========

        // „Ç¢„Ç§„ÉÜ„É†‰∏ÄË¶ß„ÅÆÂàùÊúüÂåñ
        function initItemList() {
            if (!itemData || !itemData.items) {
                console.error('„Ç¢„Ç§„ÉÜ„É†„Éá„Éº„Çø„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            // „Ç¢„Ç§„ÉÜ„É†‰∏ÄË¶ß„Çø„Éñ„ÅÆÂàùÊúüÂåñ
            setupItemListEvents();
            updateItemGrid();
        }

        // „Ç¢„Ç§„ÉÜ„É†‰∏ÄË¶ß„ÅÆ„Ç§„Éô„É≥„ÉàË®≠ÂÆö
        function setupItemListEvents() {
            // „Éï„Ç£„É´„Çø„Çø„Éñ„ÅÆ„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
            document.addEventListener('click', function (event) {
                if (event.target.classList.contains('filter-tab')) {
                    // ÂÖ®„Å¶„ÅÆ„Éï„Ç£„É´„Çø„Çø„Éñ„Åã„Çâactive„ÇíÂâäÈô§
                    document.querySelectorAll('.filter-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });

                    // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Çø„Éñ„Å´active„ÇíËøΩÂä†
                    event.target.classList.add('active');

                    // „Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®„Åó„Å¶„Ç∞„É™„ÉÉ„Éâ„ÇíÊõ¥Êñ∞
                    updateItemGrid();
                }

                // „Ç∞„É™„ÉÉ„Éâ„Ç¢„Ç§„ÉÜ„É†„ÅÆ„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
                if (event.target.closest('.grid-item')) {
                    const gridItem = event.target.closest('.grid-item');
                    const itemId = gridItem.dataset.itemId;

                    if (itemId) {
                        selectGridItem(gridItem, itemId);
                    }
                }
            });
        }

        // „Ç¢„Ç§„ÉÜ„É†„Éá„Éº„Çø„ÅÆÂá¶ÁêÜ„Å®„ÇΩ„Éº„Éà
        function getProcessedItems() {
            if (!itemData || !itemData.items) return [];

            // „Ç¢„Ç§„ÉÜ„É†„Éá„Éº„Çø„Å´ÊâÄÊåÅÊï∞„ÇíËøΩÂä†
            const processedItems = itemData.items.map(item => ({
                ...item,
                count: gameState.inventory ? (gameState.inventory[item.id] || 0) : 0
            }));

            // „ÇΩ„Éº„Éà: „É¨„Ç¢„É™„ÉÜ„Ç£È†ÜÔºàS>A>B>C>NÔºâ‚Üí IDÈ†Ü
            const rarityOrder = { 'S': 0, 'A': 1, 'B': 2, 'C': 3, 'N': 4 };

            return processedItems.sort((a, b) => {
                const rarityCompare = rarityOrder[a.rarity] - rarityOrder[b.rarity];
                if (rarityCompare !== 0) return rarityCompare;
                return a.id.localeCompare(b.id);
            });
        }

        // IDÊé•È†≠Ëæû„Åã„Çâ„Ç´„ÉÜ„Ç¥„É™„ÇíÂà§ÂÆö
        function getItemCategory(itemId) {
            if (itemId.startsWith('quo_')) return 'QUO';
            if (itemId.startsWith('yutai_')) return 'ÂÑ™ÂæÖ';
            if (itemId.startsWith('fruit_') || itemId.startsWith('food_')) return 'È£üÁ≥ß';
            if (itemId.startsWith('cosm_') || itemId.startsWith('hoge_')) return 'ÈõëÂìÅ';
            if (itemId.startsWith('story_') || itemId.startsWith('event_')) return 'Ë≤¥ÈáçÂìÅ';
            return 'ÈõëÂìÅ'; // „Éá„Éï„Ç©„É´„Éà
        }

        // ÁèæÂú®„ÅÆ„Éï„Ç£„É´„Çø„Å´Âü∫„Å•„ÅÑ„Å¶„Ç¢„Ç§„ÉÜ„É†„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function getFilteredItems() {
            const activeFilter = document.querySelector('.filter-tab.active');
            if (!activeFilter) return getProcessedItems();

            const filterText = activeFilter.textContent.trim();

            if (filterText === 'ÂÖ®„Å¶') {
                return getProcessedItems();
            }

            return getProcessedItems().filter(item => {
                return getItemCategory(item.id) === filterText;
            });
        }

        // „Ç¢„Ç§„ÉÜ„É†„Ç∞„É™„ÉÉ„Éâ„ÅÆÊõ¥Êñ∞
        function updateItemGrid() {
            const itemGrid = document.getElementById('item-grid');

            if (!itemGrid) return;

            const filteredItems = getFilteredItems();

            // „Ç∞„É™„ÉÉ„ÉâÁîüÊàê
            itemGrid.innerHTML = filteredItems.map(item => {
                const isOwned = item.count > 0;
                const isSelected = ''; // ÂàùÊúüÈÅ∏Êäû„ÅØÂæå„ÅßÂÆüË£Ö

                return `
                    <div class="grid-item rarity-${item.rarity.toLowerCase()} ${!isOwned ? 'not-owned' : ''} ${isSelected}" 
                         data-item-id="${item.id}">
                        <div class="grid-item-emoji">${item.emoji}</div>
                        <div class="grid-item-count">${item.count}</div>
                    </div>
                `;
            }).join('');

            // ÂàùÂõûË°®Á§∫ÊôÇ„ÅØ„É©„É≥„ÉÄ„É†„Å™„Ç¢„Ç§„ÉÜ„É†„ÇíÈÅ∏ÊäûÔºàÈÅä„Å≥ÂøÉÔºâ
            if (filteredItems.length > 0) {
                const randomIndex = Math.floor(Math.random() * filteredItems.length);
                const randomItem = filteredItems[randomIndex];

                setTimeout(() => {
                    const randomGridItem = itemGrid.querySelector(`[data-item-id="${randomItem.id}"]`);
                    if (randomGridItem) {
                        selectGridItem(randomGridItem, randomItem.id);
                    }
                }, 100);
            }
        }

        // „Ç∞„É™„ÉÉ„Éâ„Ç¢„Ç§„ÉÜ„É†„ÅÆÈÅ∏ÊäûÂá¶ÁêÜ
        function selectGridItem(gridItem, itemId) {
            // ÂÖ®„Å¶„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
            document.querySelectorAll('.grid-item').forEach(item => {
                item.classList.remove('selected');
            });

            // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Ç¢„Ç§„ÉÜ„É†„ÇíÈÅ∏Êäû
            gridItem.classList.add('selected');

            // Ë©≥Á¥∞„Ç´„Éº„Éâ„ÇíÊõ¥Êñ∞
            updateItemDetailCard(itemId);
        }

        // Ë©≥Á¥∞„Ç´„Éº„Éâ„ÅÆÊõ¥Êñ∞
        function updateItemDetailCard(itemId) {
            const detailCard = document.querySelector('.item-detail-card');
            if (!detailCard) return;

            const item = itemData.items.find(i => i.id === itemId);
            if (!item) return;

            const count = gameState.inventory ? (gameState.inventory[itemId] || 0) : 0;
            const glowClass = item.rarity === 'S' ? 'glow-s' : '';
            const unit = getItemUnit(itemId);

            detailCard.innerHTML = `
                <div class="item-detail-header">
                    <div class="item-detail-emoji ${glowClass}">${item.emoji}</div>
                    <div class="item-detail-info">
                        <div class="item-detail-row">
                            <div class="item-detail-name">${item.name}</div>
                            <div class="item-detail-rarity rarity-${item.rarity.toLowerCase()}">${item.rarity}„É©„É≥„ÇØ</div>
                        </div>
                        <div class="item-detail-row">
                            <div class="item-detail-value">‰æ°ÂÄ§Ôºö${item.value.toLocaleString()}ÂÜÜ</div>
                            <div class="item-detail-count">ÊâÄÊåÅÊï∞Ôºö${count}${unit}</div>
                        </div>
                    </div>
                </div>
                <div class="item-detail-memo">
                    ${item.memo || `${item.name}„ÅÆË™¨Êòé„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ`}
                </div>
            `;

            // TwemojiÂ§âÊèõ
            convertEmojis(detailCard);
        }

        // ========== „Ç¢„Éó„É™Ëµ∑Âãï ==========
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
<!-- ========== „Éñ„É≠„ÉÉ„ÇØ3 ÁµÇÁÇπ ========== -->