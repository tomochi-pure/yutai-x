<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>優待クロスで世界を救う系ゲーム</title>
    <!-- Twemoji CDN (更新版) -->
    <script src="https://cdn.jsdelivr.net/npm/twemoji@latest/dist/twemoji.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            min-height: 100vh;
        }

        /* ========== タイトル画面 ========== */
        #title-screen {
            display: block;
            min-height: 100vh;
            background-color: #f5f5f5;
        }

        .main-container {
            padding: 15px;
            max-width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
        }

        .login-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
        }

        .game-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            text-align: center;
        }

        .form-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            box-sizing: border-box;
        }

        .form-row {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .form-row:last-child {
            border-bottom: none;
        }

        .form-label {
            width: 90px;
            min-width: 90px;
            font-size: 15px;
            color: #333;
            font-weight: 500;
            white-space: nowrap;
            margin-right: 8px;
        }

        .form-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            margin-right: 8px;
            background: #f5f5f5;
            color: #666;
            min-width: 0;
            box-sizing: border-box;
        }

        .save-icon {
            font-size: 18px;
        }

        .start-btn {
            width: 100%;
            background: #4caf50;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .start-btn::after {
            content: '▶';
            font-size: 16px;
        }

        /* マシュマロリンク */
        .marshmallow-link {
            background: white;
            border: 2px solid #e91e63;
            color: #e91e63;
            padding: 15px;
            border-radius: 10px;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
            text-align: center;
            box-sizing: border-box;
        }

        .marshmallow-link:hover {
            background: #fce4ec;
        }

        /* 名前入力トグル機能 */
        .toggle-icon {
            cursor: pointer;
            user-select: none;
        }

        .toggle-icon:hover {
            transform: scale(1.1);
        }

        /* 情報タブナビゲーション */
        .info-tab-navigation {
            display: flex;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px 8px 0 0;
            margin-top: 20px;
        }

        .info-tab-button {
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: bold;
        }

        .info-tab-button.active {
            color: #2196f3;
            border-bottom-color: #2196f3;
            background: #f8f9fa;
        }

        .info-tab-button:hover {
            background: #f0f0f0;
        }

        /* 情報タブコンテンツ */
        .info-tab-content-container {
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            min-height: 400px;
        }

        .info-tab-content {
            display: none;
            padding: 20px;
        }

        .info-tab-content.active {
            display: block;
        }

        /* note埋め込み調整 */
        .note-container {
            margin-top: 0;
        }

        .note-container iframe {
            width: 100%;
            border-radius: 8px;
        }

        /* ランキング表示 */
        .ranking-container {
            text-align: center;
        }

        .ranking-title {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ranking-item {
            display: grid;
            grid-template-columns: 60px 1fr 100px;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
        }

        .ranking-item.rank-1 {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            font-weight: bold;
            color: #333;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }

        .rank {
            font-weight: bold;
            color: #666;
        }

        .rank-1 .rank {
            color: #333;
        }

        .player-name {
            text-align: left;
            font-weight: 500;
        }

        .score {
            text-align: right;
            font-weight: bold;
            color: #4caf50;
        }

        .rank-1 .score {
            color: #333;
        }

        /* ========== メインゲーム画面 ========== */
        #game-screen {
            display: none;
            min-height: 100vh;
            background-color: #f0f0f0;
            padding: 0;
            box-sizing: border-box;
        }

        .game-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f0f0f0;
        }

        /* 上部ヘッダー */
        .game-header {
            background: #f0f0f0;
            padding: 10px 15px;
            display: grid;
            grid-template-columns: 2fr 3fr;
            gap: 10px;
            align-items: center;
            color: #333;
            font-weight: bold;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
        }

        .username-display {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .user-id-display {
            font-size: 12px;
            color: #666;
            font-weight: normal;
        }

        .header-right {
            display: grid;
            grid-template-rows: 1fr 1fr 1fr;
            grid-template-columns: 1fr;
            font-size: 11px;
            line-height: 1.3;
            gap: 2px;
        }

        .header-row-1 {
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        .header-row-2,
        .header-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            align-items: center;
        }

        .cash-amount,
        .premium-coin,
        .rice-amount,
        .favo-amount,
        .follower-amount {
            color: #333;
            font-weight: bold;
            text-align: right;
        }

        /* タブナビゲーション */
        .tab-navigation {
            display: flex;
            background: white;
            border-bottom: 1px solid #ddd;
        }

        .tab-button {
            flex: 1;
            padding: 10px 5px;
            border: none;
            background: white;
            color: #666;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-button.active {
            background: #87ceeb;
            color: white;
            font-weight: bold;
        }

        .tab-button:hover:not(.active) {
            background: #f0f0f0;
        }

        /* タブコンテンツエリア */
        #tab-content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .tab-content {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .tab-content.active {
            display: flex;
        }

        /* 株注文タブ専用スタイル */
        .server-hp-container {
            background: white;
            padding: 8px 15px;
            border-bottom: 1px solid #ddd;
        }

        .server-hp-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .server-hp-bar {
            width: 100%;
            height: 15px;
            background: #e0e0e0;
            border-radius: 7px;
            overflow: hidden;
            position: relative;
        }

        .server-hp-fill {
            height: 100%;
            transition: width 0.3s ease, background 0.3s ease;
        }

        .server-hp-fill.high {
            background: linear-gradient(90deg, #4caf50, #8bc34a);
        }

        .server-hp-fill.medium {
            background: linear-gradient(90deg, #ff9800, #ffc107);
        }

        .server-hp-fill.low {
            background: linear-gradient(90deg, #f44336, #e57373);
        }

        .main-game-area {
            flex: 1;
            background: white;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .center-area {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }

        .main-order-btn {
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 20px 40px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            z-index: 1000;
            position: relative;
        }

        .main-order-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        /* ポップアップ演出 */
        .result-popup {
            position: absolute;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            pointer-events: none;
            z-index: 999;
            width: 200px !important;
            min-width: 200px !important;
            max-width: 200px !important;
            text-align: center;
            line-height: 1.3;
            opacity: 1;
            overflow: hidden;
            white-space: normal;
            animation: fadeOut ease-out forwards;
        }

        .result-popup.success {
            background: white;
            color: #2196f3;
            border: 2px solid #87ceeb;
        }

        .result-popup.failure {
            background: white;
            color: #e74c3c;
            border: 2px solid #e74c3c;
        }

        @keyframes fadeOut {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        .credit-margin-container {
            background: white;
            padding: 8px 15px;
            border-bottom: 1px solid #ddd;
        }

        .credit-margin-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .credit-margin-bar {
            width: 100%;
            height: 15px;
            background: #e0e0e0;
            border-radius: 7px;
            overflow: hidden;
            position: relative;
        }

        .credit-margin-fill {
            height: 100%;
            transition: width 0.3s ease, background 0.3s ease;
        }

        .credit-margin-fill.positive {
            background: linear-gradient(90deg, #87ceeb, #5dade2);
        }

        .credit-margin-fill.warning {
            background: linear-gradient(90deg, #f1c40f, #f39c12);
        }

        .credit-margin-fill.orange {
            background: linear-gradient(90deg, #e67e22, #d35400);
        }

        .credit-margin-fill.negative {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }

        .credit-margin-fill.danger {
            background: linear-gradient(90deg, #8b0000, #660000);
        }

        .credit-margin-fill.critical {
            background: linear-gradient(90deg, #2c3e50, #1a252f);
        }

        .bottom-tab-controls {
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 8px;
            padding: 10px 15px;
            background: white;
            border-top: 1px solid #ddd;
        }

        .bottom-tab-btn {
            padding: 12px 8px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            line-height: 1.1;
            transition: all 0.2s ease;
        }

        .bottom-tab-btn.bot-adjust {
            background: #4caf50;
            color: white;
        }

        .bottom-tab-btn.order-list {
            background: white;
            color: #2196f3;
            border: 2px solid #2196f3;
        }

        .bottom-tab-btn.active {
            opacity: 0.8;
            transform: translateY(1px);
        }

        .unified-display-area {
            padding: 10px 15px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
            font-size: 12px;
        }

        .display-content {
            display: none;
        }

        .display-content.active {
            display: block;
        }

        .performance-display {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            font-size: 11px;
        }

        .order-list-layout {
            display: grid;
            grid-template-columns: 4fr 1fr;
            gap: 10px;
            align-items: center;
        }

        .status-display {
            display: grid;
            grid-template-rows: auto auto;
            gap: 8px;
        }

        .status-row-top {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .status-row-bottom {
            display: grid;
            grid-template-columns: 1fr;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #333;
        }

        .status-label {
            color: #666;
        }

        .status-value {
            font-weight: bold;
        }

        .gacha-area {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gacha-btn-unified {
            background: #ff5722;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px 16px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            width: 100%;
            transition: background 0.3s ease;
        }

        .gacha-btn-unified.disabled {
            background: #cccccc !important;
            cursor: not-allowed !important;
        }

        .gacha-btn-unified.yellow {
            background: #ffc107 !important;
            color: #333;
        }

        .gacha-btn-unified.apology {
            background: #87ceeb !important;
            color: white;
        }

        .gacha-btn-unified.pink {
            background: #F78FA7 !important;
            color: white;
            animation: glow-pulse 1s ease-in-out infinite alternate;
        }

        @keyframes glow-pulse {
            from {
                box-shadow: 0 2px 8px rgba(247, 143, 167, 0.4);
            }
            to {
                box-shadow: 0 4px 16px rgba(247, 143, 167, 0.8);
            }
        }

        .main-order-btn.disabled {
            background: #cccccc !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
        }

        /* ガチャ結果ポップアップ */
        .gacha-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .gacha-result-popup {
            background: white;
            border-radius: 15px;
            padding: 20px;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            animation: luxuryAppear 0.6s ease forwards;
            position: relative;
        }

        @keyframes luxuryAppear {
            0% { 
                opacity: 0; 
                transform: scale(0.5) rotate(-5deg); 
            }
            50% { 
                opacity: 0.8; 
                transform: scale(1.1) rotate(2deg); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1) rotate(0deg); 
            }
        }

        .gacha-result-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: white;
            background: #87ceeb;
            margin: -20px -20px 15px -20px;
            padding: 15px 20px;
            border-radius: 15px 15px 0 0;
            position: relative;
            overflow: hidden;
        }

        .gacha-result-title::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            animation: sparkle 2s linear infinite;
        }

        .gacha-result-section {
            margin-bottom: 12px;
        }

        .gacha-rarity-header {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .rarity-a { color: #ff6b35; }
        .rarity-b { color: #4ecdc4; }
        .rarity-c { color: #95a5a6; }

        .gacha-item-list {
            margin-left: 15px;
            font-size: 13px;
            line-height: 1.4;
        }

        .gacha-item {
            color: #555;
            margin-bottom: 3px;
        }

        .gacha-close-hint {
            text-align: center;
            font-size: 11px;
            color: #999;
            margin-top: 15px;
            border-top: 1px solid #f0f0f0;
            padding-top: 10px;
        }

        @keyframes sparkle {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* インベントリ表示エリア */
        .inventory-display {
            padding: 8px 15px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            font-size: 11px;
            color: #666;
        }

        .inventory-label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }

        .inventory-list {
            line-height: 1.4;
            color: #777;
        }

        .perf-item {
            text-align: center;
        }

        .perf-icon {
            font-size: 16px;
            margin-bottom: 2px;
            display: block;
        }

        .perf-label {
            color: #666;
            margin-bottom: 2px;
        }

        .perf-value {
            font-weight: bold;
            color: #333;
        }

        .debug-controls {
            padding: 10px 15px;
            background: #f8f9fa;
            border-top: 2px solid #e74c3c;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .debug-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            color: #333;
            font-size: 11px;
            cursor: pointer;
            font-weight: bold;
        }

        .debug-btn:hover {
            background: #f0f0f0;
        }

        .debug-btn.increase {
            border-color: #e74c3c;
            color: #e74c3c;
        }

        .debug-btn.decrease {
            border-color: #27ae60;
            color: #27ae60;
        }

        .debug-btn.reset {
            border-color: #3498db;
            color: #3498db;
        }

        /* ミッションタブ専用スタイル */
        .mission-tab-content {
            padding: 15px;
            background: #f0f0f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .mission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .mission-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .refresh-btn {
            background: #87ceeb;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .refresh-btn:hover {
            background: #5dade2;
        }

        .mission-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .mission-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mission-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .mission-card-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
        }

        .mission-avatar {
            font-size: 24px;
            min-width: 40px;
            text-align: center;
        }

        .mission-info {
            flex: 1;
            min-width: 0;
        }

        .mission-user {
            display: flex;
            align-items: baseline;
            gap: 5px;
            margin-bottom: 2px;
        }

        .mission-name {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .mission-handle {
            color: #666;
            font-size: 12px;
        }

        .mission-timestamp {
            color: #666;
            font-size: 12px;
        }

        .mission-content {
            color: #333;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 10px;
            white-space: pre-line;
        }

        .mission-stats {
            display: flex;
            gap: 15px;
            color: #666;
            font-size: 12px;
        }

        .mission-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .loading-message {
            text-align: center;
            color: #666;
            font-size: 14px;
            padding: 20px;
        }

        .error-message {
            text-align: center;
            color: #e74c3c;
            font-size: 14px;
            padding: 20px;
        }

        /* ミッション4状態のスタイル */
        .mission-state-unaccepted {
            background: white;
        }

        .mission-state-progress {
            background: #e3f2fd;
        }

        .mission-state-complete {
            background: #fff3e0;
            animation: glow-pulse 2s ease-in-out infinite alternate;
        }

        @keyframes glow-pulse {
            from {
                box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
            }
            to {
                box-shadow: 0 4px 16px rgba(255, 152, 0, 0.6);
            }
        }

        .mission-state-claimed {
            background: #f5f5f5;
            opacity: 0.7;
        }

        /* ミッション詳細レイアウト */
        .mission-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin: 10px 0;
            font-size: 12px;
        }

        .mission-requirement {
            color: #666;
            font-weight: 500;
        }

        .mission-reward {
            color: #4caf50;
            font-weight: bold;
        }

        /* ミッションアクション */
        .mission-actions {
            display: grid;
            grid-template-columns: 2fr 3fr;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .mission-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mission-btn-accept {
            background: #4caf50;
            color: white;
        }

        .mission-btn-accept:hover {
            background: #45a049;
        }

        .mission-btn-claim {
            background: #ff9800;
            color: white;
        }

        .mission-btn-claim:hover {
            background: #f57c00;
        }

        .mission-btn-disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }

        .mission-time {
            background: #87ceeb;
            color: white;
            text-align: center;
            font-size: 11px;
            font-weight: 500;
            border-radius: 6px;
            padding: 8px 12px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mission-difficulty {
            color: #ff9800;
            margin-left: 5px;
        }

        /* ミッション内タブナビゲーション */
        .mission-tab-navigation {
            display: flex;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px 8px 0 0;
            margin-bottom: 0;
        }

        .mission-tab-button {
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: bold;
        }

        .mission-tab-button.active {
            color: #2196f3;
            border-bottom-color: #2196f3;
            background: #f8f9fa;
        }

        .mission-tab-button:hover {
            background: #f0f0f0;
        }

        .mission-tab-content-container {
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 15px;
        }

        /* Twemoji絵文字サイズ調整 */
        img.emoji {
            height: 1.2em;
            width: 1.2em;
            vertical-align: -0.1em;
        }

        /* PC表示対応 */
        @media (min-width: 768px) {
            body {
                display: flex;
                justify-content: center;
                background: #ddd;
                margin: 0;
                padding: 0;
                gap: 20px;
                align-items: flex-start;
            }
            
            #title-screen, #game-screen {
                max-width: 375px;
                width: 375px;
                box-shadow: 0 0 20px rgba(0,0,0,0.3);
                min-height: 100vh;
            }
        }
    </style>
</head>
<body>
    <!-- ========== タイトル画面 ========== -->
    <div id="title-screen">        
        <div class="main-container">
            <div class="login-header">
                <div class="game-title">Yutai-X simulation</div>
            </div>

            <div class="form-container">
                <div class="form-row">
                    <div class="form-label">バージョン</div>
                    <input type="text" class="form-input" value="Beta Edition ver0.20" disabled>
                    <span class="save-icon">✅</span>
                </div>

                <div class="form-row">
                    <div class="form-label">ユーザーID</div>
                    <input type="text" class="form-input" value="tomochi-fun" disabled>
                    <span class="save-icon">💾</span>
                </div>

                <div class="form-row">
                    <div class="form-label">お名前</div>
                    <input type="text" class="form-input" id="name-input" placeholder="お名前（任意）" maxlength="10">
                    <span class="save-icon toggle-icon" id="name-toggle">📝</span>
                </div>

                <button class="start-btn" id="start-button">ゲーム開始</button>
            </div>

            <div class="marshmallow-link" id="marshmallow-link">
                🩷開発者に愛のマシュマロを贈る🩷
            </div>

            <!-- タブナビゲーション -->
            <div class="info-tab-navigation">
                <button class="info-tab-button active" data-info-tab="news">お知らせ📄</button>
                <button class="info-tab-button" data-info-tab="ranking">ランキング👑</button>
            </div>

            <!-- タブコンテンツ -->
            <div class="info-tab-content-container">
                <!-- お知らせタブ -->
                <div class="info-tab-content active" id="info-tab-news">
                    <!-- note埋め込み -->
                    <div class="note-container">
                        <iframe class="note-embed" src="https://note.com/embed/notes/n824e5412f6bf" style="border: 0; display: block; max-width: 100%; width: 100%; padding: 0px; margin: 10px 0px; position: static; visibility: visible;" height="400"></iframe>
                    </div>
                </div>

                <!-- ランキングタブ -->
                <div class="info-tab-content" id="info-tab-ranking">
                    <div class="ranking-container">
                        <h3 class="ranking-title">🏆 全国ランキング</h3>
                        <div class="ranking-list">
                            <div class="ranking-item rank-1">
                                <span class="rank">1位</span>
                                <span class="player-name">あなた</span>
                                <span class="score">1,250,000,000円</span>
                            </div>
                            <div class="ranking-item">
                                <span class="rank">2位</span>
                                <span class="player-name">優待マスター</span>
                                <span class="score">980,000,000円</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== メインゲーム画面 ========== -->
    <div id="game-screen">
        <div class="game-container">
            <!-- 上部ヘッダー -->
            <div class="game-header">
                <div class="header-left">
                    <div class="username-display" id="header-username">ともちぃさん</div>
                    <div class="user-id-display" id="header-userid">tomochi-fun</div>
                </div>
                <div class="header-right">
                    <div class="header-row-1">
                        <div class="cash-amount">
                            現金💴<span id="header-cash">10,000,000</span>円
                        </div>
                    </div>
                    <div class="header-row-2">
                        <div class="rice-amount">
                            お米🍙<span id="header-rice">0</span>kg
                        </div>
                        <div class="premium-coin">
                            PTC🪙<span id="header-premium">450</span>枚
                        </div>
                    </div>
                    <div class="header-row-3">
                        <div class="favo-amount">
                            承認欲求💕<span id="header-favo">0</span>件
                        </div>
                        <div class="follower-amount">
                            フォロワー🐣<span id="header-follower">0</span>人
                        </div>
                    </div>
                </div>
            </div>

            <!-- タブナビゲーション -->
            <nav class="tab-navigation">
                <button class="tab-button active" data-tab="stocks">株注文</button>
                <button class="tab-button" data-tab="bot">bot改造</button>
                <button class="tab-button" data-tab="mission">SNS</button>
                <button class="tab-button" data-tab="yuutai">実績</button>
                <button class="tab-button" data-tab="settings">設定</button>
            </nav>

            <!-- タブコンテンツエリア -->
            <div id="tab-content-area">
                <!-- 株注文タブの内容 -->
                <div id="stocks-content" class="tab-content active">
                    <!-- サーバーHPバー -->
                    <div class="server-hp-container">
                        <div class="server-hp-label">サーバーHP</div>
                        <div class="server-hp-bar">
                            <div class="server-hp-fill" id="server-hp-fill"></div>
                        </div>
                    </div>

                    <!-- メインゲームエリア -->
                    <div class="main-game-area">
                        <!-- 中央エリア（注文ボタン + アニメーション） -->
                        <div class="center-area" id="center-area">
                            <button class="main-order-btn" id="main-order-button">注文内容を確認</button>
                        </div>
                    </div>

                    <!-- 信用建て余力バー -->
                    <div class="credit-margin-container">
                        <div class="credit-margin-label" id="credit-margin-label">信用建て余力：100%</div>
                        <div class="credit-margin-bar">
                            <div class="credit-margin-fill" id="credit-margin-fill"></div>
                        </div>
                    </div>

                    <!-- 下部タブボタンエリア -->
                    <div class="bottom-tab-controls">
                        <button class="bottom-tab-btn bot-adjust" id="bot-adjust-tab">
                            BOT調整
                        </button>
                        <button class="bottom-tab-btn order-list active" id="order-list-tab">
                            注文約定一覧
                        </button>
                    </div>

                    <!-- 統合表示エリア -->
                    <div class="unified-display-area">
                        <!-- BOT調整時のパフォーマンス指標 -->
                        <div class="display-content" id="bot-adjust-content">
                            <div class="performance-display">
                                <div class="perf-item">
                                    <span class="perf-icon">⚡</span>
                                    <div class="perf-label">Cps</div>
                                    <div class="perf-value" id="perf-cps">34回/秒</div>
                                </div>
                                <div class="perf-item">
                                    <span class="perf-icon">🎯</span>
                                    <div class="perf-label">ゲット率</div>
                                    <div class="perf-value" id="perf-get-rate">3.4倍</div>
                                </div>
                                <div class="perf-item">
                                    <span class="perf-icon">🚛</span>
                                    <div class="perf-label">積載率</div>
                                    <div class="perf-value" id="perf-load-rate">430%</div>
                                </div>
                                <div class="perf-item">
                                    <span class="perf-icon">🔥</span>
                                    <div class="perf-label">委託率</div>
                                    <div class="perf-value" id="perf-fire-rate">24%</div>
                                </div>
                            </div>
                        </div>

                        <!-- 注文約定一覧時のステータス + 現引きボタン -->
                        <div class="display-content active" id="order-list-content">
                            <div class="order-list-layout">
                                <div class="status-display">
                                    <!-- 上段：2列 -->
                                    <div class="status-row-top">
                                        <div class="status-item">
                                            <span class="status-label">注文件数</span>
                                            <span class="status-value" id="status-orders">0件</span>
                                        </div>
                                        <div class="status-item">
                                            <span class="status-label">信用建て余力</span>
                                            <span class="status-value" id="status-credit-margin">100%</span>
                                        </div>
                                    </div>
                                    <!-- 下段：1列 -->
                                    <div class="status-row-bottom">
                                        <div class="status-item">
                                            <span class="status-label">建玉金額</span>
                                            <span class="status-value" id="status-position">0円</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="gacha-area">
                                    <button class="gacha-btn-unified" id="gacha-button">
                                        現引き
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- デバッグボタンエリア -->
                    <div class="debug-controls">
                        <button class="debug-btn increase" id="debug-increase">建玉+1000万</button>
                        <button class="debug-btn decrease" id="debug-decrease">建玉-1000万</button>
                        <button class="debug-btn reset" id="debug-reset">リセット</button>
                    </div>

                    <!-- インベントリ表示エリア -->
                    <div class="inventory-display">
                        <div class="inventory-label">[デバッグ] 所持アイテム:</div>
                        <div class="inventory-list" id="inventory-list">なし</div>
                    </div>
                </div>

                <!-- BOT改造タブの内容 -->
                <div id="bot-content" class="tab-content">
                    <div class="mission-tab-content">
                        BOT改造タブ - 準備中
                    </div>
                </div>

                <!-- ミッションタブの内容 -->
                <div id="mission-content" class="tab-content">
                    <div class="mission-tab-content">
                        <!-- ミッション内タブナビゲーション -->
                        <div class="mission-tab-navigation">
                            <button class="mission-tab-button active" data-mission-tab="recommend">オススメ</button>
                            <button class="mission-tab-button" data-mission-tab="character">フォロー中</button>
                        </div>

                        <!-- ミッション内タブコンテンツ -->
                        <div class="mission-tab-content-container">
                            <div class="mission-header">
                                <div class="mission-title">いまどうしてる？</div>
                                <button class="refresh-btn" id="mission-refresh">更新</button>
                            </div>
                            <div class="mission-list" id="mission-list">
                                <div class="loading-message">ミッションを読み込み中...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 実績タブの内容 -->
                <div id="yuutai-content" class="tab-content">
                    <div class="mission-tab-content">
                        実績タブ - 準備中
                    </div>
                </div>

                <!-- 設定タブの内容 -->
                <div id="settings-content" class="tab-content">
                    <div class="mission-tab-content">
                        設定タブ - 準備中
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== ゲーム状態管理 ==========
        const gameState = {
            currentScreen: 'title',
            userName: 'ともちぃさん',
            userId: 'tomochi-fun',
            cash: 10000000,
            premiumCoin: 450,
            rice: 0,           // お米システム
            favo: 0,           // 新規追加: 承認欲求システム
            follower: 0,       // フォロワーシステム
            totalClicks: 0,
            stamina: 4
        };

        const debugState = {
            orders: 0,
            positionAmount: 0,
            initialPositionAmount: 0,
            stock: 0,
            cps: 34,
            getRate: 3.4,
            loadRate: 430,
            fireRate: 24,
            serverHP: 20,
            maxServerHP: 20,
            clickDamage: 1,
            isServerDown: false,
            isPreGacha: false
        };

        // ========== ミッションシステム ==========
        let missionData = null;
        let currentMissionTab = 'recommend';
        let missionStates = {}; // ミッション状態管理
        let serverRecoveryTimer = null; // サーバー自動回復タイマー

        // ========== アイテムシステム ==========
        let itemData = null; // items.jsonから読み込んだデータ

        // ========== ガチャシステム ==========
        let gachaData = null; // gacha.jsonから読み込んだデータ

        // ========== Twemoji 変換システム ==========
        function convertEmojis(element = document.body) {
            if (typeof twemoji !== 'undefined') {
                twemoji.parse(element, {
                    folder: 'svg',
                    ext: '.svg',
                    base: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/'
                });
            }
        }

        // ========== インベントリ表示システム ==========
        function updateInventoryDisplay() {
            const inventoryList = document.getElementById('inventory-list');
            if (!inventoryList) return;

            // インベントリが空の場合
            if (!gameState.inventory || Object.keys(gameState.inventory).length === 0) {
                inventoryList.textContent = 'なし';
                return;
            }

            // アイテムを名前付きで表示用に変換
            const displayItems = [];
            for (const [itemId, count] of Object.entries(gameState.inventory)) {
                // アイテムIDから名前を取得
                const item = findItemById(itemId);
                if (item) {
                    displayItems.push(`${item.name} x${count}枚`);
                }
            }

            // " | " で区切って表示
            inventoryList.textContent = displayItems.join(' | ');
        }

        // ========== アイテム検索ヘルパー関数 ==========
        function findItemById(itemId) {
            if (!itemData || !itemData.items) return null;
            return itemData.items.find(item => item.id === itemId);
        }

        // ========== アイテムデータ読み込み ==========
        async function loadItems() {
            try {
                const response = await fetch('./items.json');
                if (!response.ok) {
                    throw new Error(`アイテムファイルの読み込みに失敗しました (${response.status})`);
                }
                
                const data = await response.json();
                itemData = data;
                console.log('アイテムデータ読み込み完了:', itemData);
                return true;
            } catch (error) {
                console.error('重大エラー: アイテムデータの読み込みに失敗しました:', error);
                alert('ゲームの初期化に失敗しました。items.jsonファイルを確認してください。');
                return false;
            }
        }

        // ========== ガチャデータ読み込み ==========
        async function loadGacha() {
            try {
                const response = await fetch('./gacha.json');
                if (!response.ok) {
                    throw new Error(`ガチャファイルの読み込みに失敗しました (${response.status})`);
                }
                
                const data = await response.json();
                gachaData = data;
                console.log('ガチャデータ読み込み完了:', gachaData);
                return true;
            } catch (error) {
                console.error('ガチャデータの読み込みに失敗しました:', error);
                console.error('ガチャはハードコードされた設定で動作します');
                return false;
            }
        }

        // ========== サーバー自動回復システム ==========
        function startServerRecovery() {
            if (serverRecoveryTimer) return; // 重複防止
            
            serverRecoveryTimer = setInterval(() => {
                if (debugState.serverHP < debugState.maxServerHP) {
                    debugState.serverHP += 1;
                    
                    // サーバーダウン状態チェック
                    checkServerDown();
                    updateDisplay();
                }
            }, 1000); // 1秒間隔で1HP回復
        }

        // ========== 初期化 ==========
        async function init() {
            setupEventListeners();
            
            // Twemoji 初期化（シンプル版）
            if (typeof twemoji !== 'undefined') {
                // 初期変換
                convertEmojis();
                console.log('Twemoji初期化完了');
                
                // MutationObserver で動的要素監視
                const emojiObserver = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                convertEmojis(node);
                            }
                        });
                    });
                });
                
                // 監視開始
                emojiObserver.observe(document.body, { 
                    childList: true, 
                    subtree: true 
                });
                console.log('絵文字自動変換システム開始');
            } else {
                console.warn('Twemojiライブラリが読み込まれていません');
            }
            
            // アイテムデータ読み込み（必須）
            const itemsLoaded = await loadItems();
            if (!itemsLoaded) {
                console.error('ゲーム初期化中止: アイテムデータが読み込めませんでした');
                return;
            }
            
            // ガチャデータ読み込み（エラーでも続行）
            await loadGacha();
            
            updateDisplay();
            loadMissions();
            startServerRecovery(); // サーバー自動回復開始
        }

        function setupEventListeners() {
            const startButton = document.getElementById('start-button');
            const mainOrderButton = document.getElementById('main-order-button');
            const nameToggle = document.getElementById('name-toggle');
            const nameInput = document.getElementById('name-input');
            const marshmallowLink = document.getElementById('marshmallow-link');
            
            // デバッグボタン
            const debugIncrease = document.getElementById('debug-increase');
            const debugDecrease = document.getElementById('debug-decrease');
            const debugReset = document.getElementById('debug-reset');
            
            if (startButton) {
                startButton.addEventListener('click', handleGameStart);
            }
            
            if (mainOrderButton) {
                mainOrderButton.addEventListener('click', handleOrderClick);
            }

            if (nameToggle && nameInput) {
                nameToggle.addEventListener('click', toggleNameInput);
            }

            if (marshmallowLink) {
                marshmallowLink.addEventListener('click', function() {
                    window.open('https://marshmallow-qa.com/hdl55x2xyxkuz0q?t=OGltiZ&utm_medium=url_text&utm_source=promotion', '_blank');
                });
            }

            // デバッグボタンイベント
            if (debugIncrease) {
                debugIncrease.addEventListener('click', function() {
                    debugState.positionAmount += 10000000;
                    if (debugState.positionAmount < 0) {
                        debugState.positionAmount = 0;
                    }
                    updateDisplay();
                });
            }

            if (debugDecrease) {
                debugDecrease.addEventListener('click', function() {
                    debugState.positionAmount -= 10000000;
                    if (debugState.positionAmount < 0) {
                        debugState.positionAmount = 0;
                    }
                    updateDisplay();
                });
            }

            if (debugReset) {
                debugReset.addEventListener('click', function() {
                    debugState.positionAmount = debugState.initialPositionAmount;
                    debugState.serverHP = debugState.maxServerHP;
                    debugState.isServerDown = false;
                    debugState.isPreGacha = false;
                    gameState.inventory = {}; // インベントリもリセット
                    gameState.rice = 0;       // お米もリセット
                    gameState.favo = 0;       // 承認欲求もリセット
                    gameState.follower = 0;   // フォロワーもリセット
                    updateServerDownUI();
                    updateDisplay();
                    updateInventoryDisplay(); // インベントリ表示更新
                });
            }

            // 情報タブ切り替え
            document.querySelectorAll('.info-tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.dataset.infoTab;
                    switchInfoTab(tabName);
                });
            });

            // ゲームタブ切り替え
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    switchGameTab(this);
                });
            });

            // 下部タブ切り替え
            document.querySelectorAll('.bottom-tab-btn').forEach(button => {
                button.addEventListener('click', function() {
                    switchBottomTab(this);
                });
            });

            // ミッション更新ボタン
            const missionRefresh = document.getElementById('mission-refresh');
            if (missionRefresh) {
                missionRefresh.addEventListener('click', refreshMissions);
            }

            // 現引き/謝罪ボタン
            const gachaButton = document.getElementById('gacha-button');
            if (gachaButton) {
                gachaButton.addEventListener('click', function() {
                    if (debugState.isServerDown) {
                        handleApologyClick();
                    } else if (debugState.isPreGacha) {
                        // ガチャ発火処理
                        console.log('現渡ボタンクリック - ガチャ発火開始');
                        executeGacha();
                    } else if (debugState.orders > 0) {
                        // pre現渡モードに移行
                        console.log('現引きボタンクリック - pre現渡モード開始');
                        enterPreGachaMode();
                    }
                });
            }

            // イベント委譲によるミッション関連イベント処理
            document.addEventListener('click', function(event) {
                // ミッション内タブ切り替え
                if (event.target.classList.contains('mission-tab-button')) {
                    const tabName = event.target.dataset.missionTab;
                    switchMissionTab(tabName);
                }
                
                // ミッションボタンクリック処理
                if (event.target.classList.contains('mission-btn')) {
                    const missionCard = event.target.closest('.mission-card');
                    if (missionCard) {
                        const missionId = missionCard.dataset.missionId;
                        const action = event.target.textContent;
                        handleMissionAction(missionId, action);
                    }
                }
            });
        }

        // ========== クリック処理機能 ==========
        function handleOrderClick() {
            // サーバーダウン中またはpre現渡中はクリック無効
            if (debugState.isServerDown || debugState.isPreGacha) return;
            
            // 総クリック数を必ず増加
            gameState.totalClicks++;
            
            // サーバーHP減少処理
            debugState.serverHP -= debugState.clickDamage;
            if (debugState.serverHP < 0) debugState.serverHP = 0;
            
            // サーバーダウンチェック
            checkServerDown();
            
            // 25%の確率で当たり
            const isHit = Math.random() < 0.25;
            
            if (isHit) {
                // 当たり処理
                debugState.orders++;
                debugState.positionAmount += 300000; // 30万円増加
                showResultPopup(true);
            } else {
                // 外れ処理
                showResultPopup(false);
            }
            
            // 表示を即座に更新
            updateDisplay();
        }

        function showResultPopup(isSuccess) {
            const centerArea = document.getElementById('center-area');
            if (!centerArea) return;

            // ポップアップ要素を作成
            const popup = document.createElement('div');
            popup.className = `result-popup ${isSuccess ? 'success' : 'failure'}`;
            
            // メッセージ設定
            if (isSuccess) {
                popup.textContent = '新規売り注文を受け付けました';
                popup.style.animationDuration = '2s'; // 成功時2秒
            } else {
                popup.textContent = 'ご注文数量が、一般信用売建可能数量を超過しているため、受付けできません。';
                popup.style.animationDuration = '0.5s'; // 失敗時0.5秒
            }

            // 一時的に画面外に配置してサイズを取得
            popup.style.visibility = 'hidden';
            popup.style.position = 'absolute';
            centerArea.appendChild(popup);

            // ランダム位置を設定（center-area内・中心点基準）
            const areaRect = centerArea.getBoundingClientRect();
            const popupRect = popup.getBoundingClientRect();
            
            const randomX = Math.random() * areaRect.width;
            const randomY = Math.random() * areaRect.height;
            
            // 中心点基準で座標設定
            const centerX = randomX - (popupRect.width / 2);
            const centerY = randomY - (popupRect.height / 2);
            
            popup.style.left = centerX + 'px';
            popup.style.top = centerY + 'px';
            popup.style.visibility = 'visible';

            // アニメーション終了後に削除
            const duration = isSuccess ? 2000 : 500; // 成功2秒・失敗0.5秒
            setTimeout(() => {
                if (popup.parentNode) {
                    popup.parentNode.removeChild(popup);
                }
            }, duration);
        }

        // ========== サーバーダウン処理 ==========
        function checkServerDown() {
            const wasDown = debugState.isServerDown;
            const shouldBeDown = (debugState.serverHP === 0);
            const shouldRecover = (debugState.serverHP === debugState.maxServerHP);
            
            if (!wasDown && shouldBeDown) {
                enterServerDownMode();
            } else if (wasDown && shouldRecover) {
                exitServerDownMode();
            }
        }

        function enterServerDownMode() {
            debugState.isServerDown = true;
            debugState.orders = 0;
            debugState.positionAmount = 0;
            updateServerDownUI();
        }

        function exitServerDownMode() {
            debugState.isServerDown = false;
            updateServerDownUI();
        }

        function updateServerDownUI() {
            const orderButton = document.getElementById('main-order-button');
            const gachaButton = document.getElementById('gacha-button');
            const hpLabel = document.querySelector('.server-hp-label');
            
            if (debugState.isServerDown) {
                // サーバーダウン状態のUI
                if (orderButton) {
                    orderButton.classList.add('disabled');
                    orderButton.style.background = '#cccccc';
                    orderButton.style.cursor = 'not-allowed';
                }
                
                if (gachaButton) {
                    gachaButton.textContent = '謝罪';
                    gachaButton.style.background = '#87ceeb';
                    gachaButton.classList.add('apology');
                }
                
                if (hpLabel) {
                    hpLabel.textContent = 'サーバーは応答していません。現在復旧中です。';
                }
            } else if (debugState.isPreGacha) {
                // pre現渡状態のUI
                if (orderButton) {
                    orderButton.classList.add('disabled');
                    orderButton.style.background = '#cccccc';
                    orderButton.style.cursor = 'not-allowed';
                }
                // ガチャボタンはupdateGachaButtonState()で処理
            } else {
                // 通常状態のUI
                if (orderButton) {
                    orderButton.classList.remove('disabled');
                    orderButton.style.background = '#4caf50';
                    orderButton.style.cursor = 'pointer';
                }
                
                if (gachaButton) {
                    gachaButton.style.background = '#ff5722';
                    gachaButton.classList.remove('apology');
                }
                
                if (hpLabel) {
                    hpLabel.textContent = 'サーバーHP';
                }
            }
        }

        function handleApologyClick() {
            if (debugState.isServerDown) {
                debugState.serverHP += 5;
                if (debugState.serverHP > debugState.maxServerHP) {
                    debugState.serverHP = debugState.maxServerHP;
                }
                checkServerDown();
                updateDisplay();
            }
        }

        // ========== ミッション機能 ==========
        async function loadMissions() {
            const missionList = document.getElementById('mission-list');
            if (!missionList) return;

            // ローディング表示
            missionList.innerHTML = '<div class="loading-message">ミッションを読み込み中...</div>';

            try {
                const response = await fetch('./missions.json');
                if (!response.ok) {
                    throw new Error('ミッションファイルの読み込みに失敗しました');
                }
                
                const data = await response.json();
                missionData = data;
                displayCurrentTabMissions();
            } catch (error) {
                console.error('ミッション読み込みエラー:', error);
                missionList.innerHTML = '<div class="error-message">ミッションの読み込みに失敗しました<br>missions.jsonファイルを確認してください</div>';
            }
        }

        function refreshMissions() {
            if (!missionData || !missionData.characterMissions) return;

            // 未受諾 + 受取済み状態のミッションIDを取得
            const replaceableMissions = [];
            for (const missionId in missionStates) {
                if (missionStates[missionId].state === 'unaccepted' || missionStates[missionId].state === 'claimed') {
                    replaceableMissions.push(missionId);
                }
            }

            // 未受諾 + 受取済みミッションの状態をクリア
            replaceableMissions.forEach(missionId => {
                delete missionStates[missionId];
            });

            // ミッションを再表示
            displayCurrentTabMissions();
        }

        function displayCurrentTabMissions() {
            if (currentMissionTab === 'recommend') {
                displayRecommendMissions();
            } else if (currentMissionTab === 'character') {
                displayCharacterMissions();
            }
        }

        function displayRecommendMissions() {
            const missionList = document.getElementById('mission-list');
            if (!missionList) return;

            // オススメミッションはまだ未実装
            missionList.innerHTML = '<div class="loading-message">更新中...</div>';
        }

        function displayCharacterMissions() {
            const missionList = document.getElementById('mission-list');
            if (!missionList || !missionData || !missionData.characterMissions) {
                missionList.innerHTML = '<div class="error-message">ミッションが見つかりません</div>';
                return;
            }

            // 進行中・完了のミッションを保持（タイマー継続・報酬受取待ち）
            const activeMissions = [];
            for (const missionId in missionStates) {
                if (missionStates[missionId].state === 'progress' || missionStates[missionId].state === 'complete') {
                    const mission = missionData.characterMissions.find(m => m.id === missionId);
                    if (mission) {
                        activeMissions.push(mission);
                    }
                }
            }

            // 必要な新規ミッション数を計算（6個から保持分を引く）
            const neededCount = 6 - activeMissions.length;
            
            // 未選択のミッションから抽選（進行中・完了以外）
            const availableMissions = missionData.characterMissions.filter(mission => 
                !missionStates[mission.id] || 
                (missionStates[mission.id].state !== 'progress' && missionStates[mission.id].state !== 'complete')
            );
            
            const newMissions = getRandomMissions(availableMissions, neededCount);
            
            // 全ミッションを結合
            const allMissions = [...activeMissions, ...newMissions];
            
            displayMultipleMissions(allMissions);
        }

        function switchMissionTab(tabName) {
            currentMissionTab = tabName;

            // タブボタンのアクティブ状態切り替え
            document.querySelectorAll('.mission-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeButton = document.querySelector(`[data-mission-tab="${tabName}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }

            // コンテンツの表示切り替え
            displayCurrentTabMissions();
        }

        function getRandomMissions(missions, count) {
            // 配列をシャッフル
            const shuffled = [...missions].sort(() => Math.random() - 0.5);
            // 指定数だけ取得（配列の長さを超えない）
            return shuffled.slice(0, Math.min(count, shuffled.length));
        }

        function displayMultipleMissions(missions) {
            const missionList = document.getElementById('mission-list');
            if (!missionList) return;

            const missionHTML = missions.map(mission => {
                const state = missionStates[mission.id] || { state: 'unaccepted', timerId: null, remainingTime: 0 };
                const stateInfo = getMissionStateInfo(mission.id, state);
                return createMissionCard(mission, stateInfo);
            }).join('');

            missionList.innerHTML = missionHTML;
        }

        function getMissionStateInfo(missionId, state) {
            const stateInfo = {
                id: missionId,
                state: state.state,
                bgClass: `mission-state-${state.state}`
            };

            switch (state.state) {
                case 'unaccepted':
                    stateInfo.buttonText = '受諾';
                    stateInfo.buttonClass = gameState.cash >= 200000 ? 'mission-btn-accept' : 'mission-btn-disabled';
                    stateInfo.timeText = '必要時間：5秒';
                    break;
                case 'progress':
                    stateInfo.buttonText = '受諾中';
                    stateInfo.buttonClass = 'mission-btn-disabled';
                    stateInfo.timeText = `残り時間：${state.remainingTime}秒`;
                    break;
                case 'complete':
                    stateInfo.buttonText = '報酬受取';
                    stateInfo.buttonClass = 'mission-btn-claim';
                    stateInfo.timeText = '完了';
                    break;
                case 'claimed':
                    stateInfo.buttonText = '受取済';
                    stateInfo.buttonClass = 'mission-btn-disabled';
                    stateInfo.timeText = '受取済';
                    break;
            }

            return stateInfo;
        }

        function createMissionCard(mission, stateInfo) {
            return `
                <div class="mission-card ${stateInfo.bgClass}" data-mission-id="${stateInfo.id}">
                    <div class="mission-card-header">
                        <div class="mission-avatar">${mission.character.icon}</div>
                        <div class="mission-info">
                            <div class="mission-user">
                                <span class="mission-name">${mission.character.name}</span>
                                <span class="mission-handle">${mission.character.handle}</span>
                                <span class="mission-difficulty">⭐⭐</span>
                            </div>
                        </div>
                    </div>
                    <div class="mission-content">${mission.content}</div>
                    <div class="mission-details">
                        <div class="mission-requirement">達成条件：${mission.mission.materials}</div>
                        <div class="mission-reward">報酬：${mission.mission.reward}</div>
                    </div>
                    <div class="mission-actions">
                        <button class="mission-btn ${stateInfo.buttonClass}" ${stateInfo.buttonClass === 'mission-btn-disabled' ? 'disabled' : ''}>${stateInfo.buttonText}</button>
                        <div class="mission-time">${stateInfo.timeText}</div>
                    </div>
                </div>
            `;
        }

        // ========== ミッションアクション処理 ==========
        function handleMissionAction(missionId, action) {
            const state = missionStates[missionId] || { state: 'unaccepted', timerId: null, remainingTime: 0 };

            switch (action) {
                case '受諾':
                    if (gameState.cash >= 200000) {
                        acceptMission(missionId);
                    }
                    break;
                case '報酬受取':
                    claimMissionReward(missionId);
                    break;
            }
        }

        function acceptMission(missionId) {
            // 現金を消費
            gameState.cash -= 200000;
            
            // ミッション状態を進行中に変更
            missionStates[missionId] = {
                state: 'progress',
                timerId: null,
                remainingTime: 5
            };

            // タイマーを開始
            startMissionTimer(missionId);

            // 表示を更新
            updateDisplay();
            updateMissionDisplay(missionId);
        }

        function startMissionTimer(missionId) {
            const state = missionStates[missionId];
            if (!state || state.state !== 'progress') return;

            // 既存のタイマーをクリア
            if (state.timerId) {
                clearInterval(state.timerId);
            }

            // 新しいタイマーを開始
            state.timerId = setInterval(() => {
                state.remainingTime--;
                
                if (state.remainingTime <= 0) {
                    // タイマー完了
                    clearInterval(state.timerId);
                    state.timerId = null;
                    state.state = 'complete';
                    state.remainingTime = 0;
                }
                
                // 表示を更新
                updateMissionDisplay(missionId);
            }, 1000);
        }

        function claimMissionReward(missionId) {
            // プレミアムコインを獲得
            gameState.premiumCoin += 50;
            
            // ミッション状態を受取済に変更
            missionStates[missionId] = {
                state: 'claimed',
                timerId: null,
                remainingTime: 0
            };

            // 表示を更新
            updateDisplay();
            updateMissionDisplay(missionId);
        }

        function updateMissionDisplay(missionId) {
            const missionCard = document.querySelector(`[data-mission-id="${missionId}"]`);
            if (!missionCard) return;

            const state = missionStates[missionId];
            if (!state) return;

            // ミッションデータを取得
            const mission = missionData.characterMissions.find(m => m.id === missionId);
            if (!mission) return;

            // 状態情報を取得
            const stateInfo = getMissionStateInfo(missionId, state);

            // カードの内容を更新
            missionCard.className = `mission-card ${stateInfo.bgClass}`;
            missionCard.innerHTML = `
                <div class="mission-card-header">
                    <div class="mission-avatar">${mission.character.icon}</div>
                    <div class="mission-info">
                        <div class="mission-user">
                            <span class="mission-name">${mission.character.name}</span>
                            <span class="mission-handle">${mission.character.handle}</span>
                            <span class="mission-difficulty">⭐⭐</span>
                        </div>
                    </div>
                </div>
                <div class="mission-content">${mission.content}</div>
                <div class="mission-details">
                    <div class="mission-requirement">達成条件：${mission.mission.materials}</div>
                    <div class="mission-reward">報酬：${mission.mission.reward}</div>
                </div>
                <div class="mission-actions">
                    <button class="mission-btn ${stateInfo.buttonClass}" ${stateInfo.buttonClass === 'mission-btn-disabled' ? 'disabled' : ''}>${stateInfo.buttonText}</button>
                    <div class="mission-time">${stateInfo.timeText}</div>
                </div>
            `;
        }

        function switchInfoTab(tabName) {
            // タブボタンのアクティブ状態切り替え
            document.querySelectorAll('.info-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeTabButton = document.querySelector(`[data-info-tab="${tabName}"]`);
            if (activeTabButton) {
                activeTabButton.classList.add('active');
            }

            // タブコンテンツの表示切り替え
            document.querySelectorAll('.info-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const activeTabContent = document.getElementById(`info-tab-${tabName}`);
            if (activeTabContent) {
                activeTabContent.classList.add('active');
            }
        }

        function switchGameTab(clickedTab) {
            // すべてのタブボタンからactiveクラスを削除
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // クリックされたタブにactiveクラスを追加
            clickedTab.classList.add('active');

            // すべてのタブコンテンツを非表示
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // 対応するタブコンテンツを表示
            const tabName = clickedTab.dataset.tab;
            const targetContent = document.getElementById(`${tabName}-content`);
            if (targetContent) {
                targetContent.classList.add('active');
                
                // ミッションタブの場合はミッションを読み込み
                if (tabName === 'mission') {
                    loadMissions();
                }
            }
        }

        function switchBottomTab(clickedTab) {
            // すべてのタブボタンからactiveクラスを削除
            document.querySelectorAll('.bottom-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // クリックされたタブにactiveクラスを追加
            clickedTab.classList.add('active');

            // すべての表示コンテンツを非表示
            document.querySelectorAll('.display-content').forEach(content => {
                content.classList.remove('active');
            });

            // 対応するコンテンツを表示
            if (clickedTab.id === 'bot-adjust-tab') {
                document.getElementById('bot-adjust-content').classList.add('active');
            } else if (clickedTab.id === 'order-list-tab') {
                document.getElementById('order-list-content').classList.add('active');
            }
        }

        function handleGameStart() {
            const nameInput = document.getElementById('name-input');
            if (nameInput && nameInput.value.trim()) {
                gameState.userName = nameInput.value.trim();
            }
            showScreen('game');
        }

        function toggleNameInput() {
            const nameInput = document.getElementById('name-input');
            const nameToggle = document.getElementById('name-toggle');
            
            if (nameInput && nameToggle) {
                if (nameInput.disabled) {
                    // 無効 → 有効
                    nameInput.disabled = false;
                    nameInput.style.background = '#fff';
                    nameInput.style.color = '#333';
                    nameToggle.textContent = '📝';
                } else {
                    // 有効 → 無効
                    nameInput.disabled = true;
                    nameInput.style.background = '#f5f5f5';
                    nameInput.style.color = '#666';
                    nameToggle.textContent = '🔒';
                }
            }
        }

        function showScreen(screenName) {
            const titleScreen = document.getElementById('title-screen');
            const gameScreen = document.getElementById('game-screen');
            
            if (titleScreen) titleScreen.style.display = screenName === 'title' ? 'block' : 'none';
            if (gameScreen) gameScreen.style.display = screenName === 'game' ? 'block' : 'none';
            
            gameState.currentScreen = screenName;
            
            if (screenName === 'game') {
                updateDisplay();
            }
        }

        function updateDisplay() {
            // ヘッダー更新
            const headerUsername = document.getElementById('header-username');
            const headerUserid = document.getElementById('header-userid');
            const headerPremium = document.getElementById('header-premium');
            const headerCash = document.getElementById('header-cash');
            const headerRice = document.getElementById('header-rice');
            const headerFavo = document.getElementById('header-favo');
            const headerFollower = document.getElementById('header-follower');

            if (headerUsername) headerUsername.textContent = gameState.userName;
            if (headerUserid) headerUserid.textContent = gameState.userId;
            if (headerPremium) headerPremium.textContent = gameState.premiumCoin.toLocaleString();
            if (headerCash) headerCash.textContent = gameState.cash.toLocaleString();
            if (headerRice) headerRice.textContent = gameState.rice.toLocaleString();
            if (headerFavo) headerFavo.textContent = gameState.favo.toLocaleString();
            if (headerFollower) headerFollower.textContent = gameState.follower.toLocaleString();

            // ステータス更新
            const statusOrders = document.getElementById('status-orders');
            const statusPosition = document.getElementById('status-position');
            const statusCreditMargin = document.getElementById('status-credit-margin');

            if (statusOrders) statusOrders.textContent = debugState.orders + '件';
            if (statusPosition) statusPosition.textContent = debugState.positionAmount.toLocaleString() + '円';
            
            // 信用建て余力のパーセンテージ更新
            if (statusCreditMargin) {
                const creditMargin = gameState.cash * 3.3 - debugState.positionAmount;
                const maxPositive = gameState.cash * 3.3;
                const marginPercentage = Math.round((creditMargin / maxPositive) * 100);
                statusCreditMargin.textContent = marginPercentage + '%';
            }

            // パフォーマンス指標更新
            const perfCps = document.getElementById('perf-cps');
            const perfGetRate = document.getElementById('perf-get-rate');
            const perfLoadRate = document.getElementById('perf-load-rate');
            const perfFireRate = document.getElementById('perf-fire-rate');

            if (perfCps) perfCps.textContent = debugState.cps + '回/秒';
            if (perfGetRate) perfGetRate.textContent = debugState.getRate + '倍';
            if (perfLoadRate) perfLoadRate.textContent = debugState.loadRate + '%';
            if (perfFireRate) perfFireRate.textContent = debugState.fireRate + '%';

            // 信用建て余力バー更新
            updateCreditMarginBar();
            
            // サーバーHPバー更新
            updateServerHPBar();
            
            // サーバーダウンUI更新
            updateServerDownUI();
            
            // ガチャボタン状態更新
            updateGachaButtonState();
        }

        function updateGachaButtonState() {
            const gachaButton = document.getElementById('gacha-button');
            if (!gachaButton) return;

            // サーバーダウン中は謝罪ボタン優先
            if (debugState.isServerDown) {
                return; // updateServerDownUI()で処理済み
            }

            // pre現渡状態の場合
            if (debugState.isPreGacha) {
                gachaButton.textContent = '現渡';
                gachaButton.className = 'gacha-btn-unified pink';
                gachaButton.disabled = false;
                return;
            }

            // 注文件数に応じた状態切り替え
            if (debugState.orders === 0) {
                // グレーアウト状態
                gachaButton.textContent = '現引き';
                gachaButton.className = 'gacha-btn-unified disabled';
                gachaButton.disabled = true;
            } else {
                // 黄色状態（注文件数1以上）
                gachaButton.textContent = '現引き';
                gachaButton.className = 'gacha-btn-unified yellow';
                gachaButton.disabled = false;
            }
        }

        // ========== ガチャ処理機能（Phase 2: 4段階抽選エンジン） ==========
        
        // ガチャタイプ取得
        function getGachaType() {
            // 現在は"standard"固定
            return gachaData?.defaultGacha || 'standard';
        }

        // Stage 1: カテゴリ抽選
        function stage1_rollCategory(gachaType) {
            const gacha = gachaData?.gachaTypes?.[gachaType];
            if (!gacha || !gacha.stage1_categories) {
                console.error('Stage1設定が見つかりません');
                return 'item'; // デフォルト
            }

            const categories = gacha.stage1_categories;
            const totalWeight = categories.reduce((sum, cat) => sum + cat.weight, 0);
            const random = Math.random() * totalWeight;
            
            let cumulative = 0;
            for (const category of categories) {
                cumulative += category.weight;
                if (random < cumulative) {
                    console.log(`Stage1: ${category.type} (${category.description})`);
                    return category.type;
                }
            }
            
            return 'item'; // フォールバック
        }

        // Stage 2: 数量抽選（現金・PTC・お米用）
        function stage2_rollAmount(gachaType, categoryType) {
            const gacha = gachaData?.gachaTypes?.[gachaType];
            if (!gacha || !gacha.stage2_amounts || !gacha.stage2_amounts[categoryType]) {
                console.error('Stage2設定が見つかりません');
                return 100000; // デフォルト
            }

            const amounts = gacha.stage2_amounts[categoryType];
            const totalWeight = amounts.reduce((sum, amt) => sum + amt.weight, 0);
            const random = Math.random() * totalWeight;
            
            let cumulative = 0;
            for (const amount of amounts) {
                cumulative += amount.weight;
                if (random < cumulative) {
                    console.log(`Stage2: ${amount.amount}${categoryType === 'rice' ? 'kg' : '円/枚'}`);
                    return amount.amount;
                }
            }
            
            return amounts[0].amount; // フォールバック
        }

        // Stage 3: レアリティ抽選（アイテム用）
        function stage3_rollRarity(gachaType) {
            const gacha = gachaData?.gachaTypes?.[gachaType];
            if (!gacha || !gacha.stage3_rarities) {
                console.error('Stage3設定が見つかりません');
                return 'C'; // デフォルト
            }

            const rarities = gacha.stage3_rarities;
            const totalWeight = rarities.reduce((sum, rar) => sum + rar.weight, 0);
            const random = Math.random() * totalWeight;
            
            let cumulative = 0;
            for (const rarity of rarities) {
                cumulative += rarity.weight;
                if (random < cumulative) {
                    console.log(`Stage3: レアリティ ${rarity.rarity}`);
                    return rarity.rarity;
                }
            }
            
            return 'C'; // フォールバック
        }

        // Stage 4: 具体的なアイテム抽選
        function stage4_rollItem(gachaType, rarity) {
            // まず該当レアリティのアイテムを全て取得
            const rarityItems = itemData?.items?.filter(item => item.rarity === rarity) || [];
            if (rarityItems.length === 0) {
                console.error(`レアリティ${rarity}のアイテムが見つかりません`);
                return null;
            }

            // オーバーライド設定を確認
            const gacha = gachaData?.gachaTypes?.[gachaType];
            const overrides = gacha?.stage4_item_overrides?.[rarity] || [];
            
            // 各アイテムの重みを設定（デフォルト1）
            const itemWeights = {};
            rarityItems.forEach(item => {
                itemWeights[item.id] = 1; // デフォルト重み
            });
            
            // オーバーライドがあれば適用
            overrides.forEach(override => {
                if (itemWeights[override.itemId] !== undefined) {
                    itemWeights[override.itemId] = override.weight;
                }
            });
            
            // 重み付き抽選
            const totalWeight = rarityItems.reduce((sum, item) => sum + itemWeights[item.id], 0);
            const random = Math.random() * totalWeight;
            
            let cumulative = 0;
            for (const item of rarityItems) {
                cumulative += itemWeights[item.id];
                if (random < cumulative) {
                    console.log(`Stage4: ${item.id} (${item.name})`);
                    return item;
                }
            }
            
            return rarityItems[0]; // フォールバック
        }

        // 新しいrollSingleGacha関数（4段階抽選）
        function rollSingleGacha() {
            try {
                console.log('=== ガチャ抽選開始 ===');
                
                // ガチャデータチェック
                if (!gachaData) {
                    console.warn('ガチャデータが読み込まれていません。ハードコード版で動作します。');
                    // フォールバック（元のハードコード版）
                    return rollSingleGachaFallback();
                }

                // ガチャタイプ取得
                const gachaType = getGachaType();
                
                // Stage 1: カテゴリ抽選
                const category = stage1_rollCategory(gachaType);
                
                // カテゴリに応じて処理分岐
                if (category === 'cash' || category === 'premium' || category === 'rice') {
                    // Stage 2: 数量抽選
                    const amount = stage2_rollAmount(gachaType, category);
                    
                    // 結果オブジェクト作成
                    const result = {
                        type: category,
                        amount: amount,
                        name: category === 'cash' ? `現金${amount.toLocaleString()}円` :
                              category === 'premium' ? `プレミアムコイン${amount}枚` :
                              `お米${amount}kg`
                    };
                    
                    console.log('抽選結果:', result);
                    return result;
                    
                } else if (category === 'item') {
                    // Stage 3: レアリティ抽選
                    const rarity = stage3_rollRarity(gachaType);
                    
                    // Stage 4: アイテム抽選
                    const item = stage4_rollItem(gachaType, rarity);
                    
                    if (!item) {
                        console.error('アイテム抽選に失敗しました');
                        return rollSingleGachaFallback();
                    }
                    
                    // アイテムにtypeを追加
                    const result = {
                        ...item,
                        type: 'item'
                    };
                    
                    console.log('抽選結果:', result);
                    return result;
                }
                
            } catch (error) {
                console.error('ガチャ抽選エラー:', error);
                return rollSingleGachaFallback();
            }
        }

        // フォールバック用（元のハードコード版）
        function rollSingleGachaFallback() {
            if (!itemData || !itemData.items) {
                console.error('アイテムデータが読み込まれていません');
                return null;
            }

            // アイテムのみ（現金・PTC・お米は出ない）
            const items = itemData.items.filter(item => 
                item.id === 'quo_5000' || item.id === 'quo_1000' || item.id === 'quo_500'
            );
            
            // 簡易確率（A:10%, B:30%, C:60%）
            const random = Math.random();
            let selectedItem;
            
            if (random < 0.1) {
                selectedItem = items.find(item => item.id === 'quo_5000');
            } else if (random < 0.4) {
                selectedItem = items.find(item => item.id === 'quo_1000');
            } else {
                selectedItem = items.find(item => item.id === 'quo_500');
            }
            
            return {
                ...selectedItem,
                type: 'item'
            };
        }

        function executeGacha() {
            const gachaCount = debugState.orders;
            const results = [];
            
            console.log(`ガチャ発火開始 - ${gachaCount}回抽選`);
            
            // 注文件数分だけ抽選
            for (let i = 0; i < gachaCount; i++) {
                const result = rollSingleGacha();
                if (result) {
                    results.push(result);
                    console.log(`${i + 1}回目:`, result.name);
                }
            }
            
            // 結果を処理（アイテムと現金等を分離）
            processGachaResults(results);
            
            // ガチャ結果ポップアップ表示
            showGachaResult(results);
            
            // 注文件数・建玉金額をリセット・状態復帰
            debugState.orders = 0;
            debugState.positionAmount = 0; // 建玉金額もリセット
            exitPreGachaMode();
            
            return results;
        }

        // ガチャ結果の処理（新規追加）
        function processGachaResults(results) {
            for (const result of results) {
                switch (result.type) {
                    case 'cash':
                        gameState.cash += result.amount;
                        console.log(`現金 +${result.amount}円 (合計: ${gameState.cash}円)`);
                        break;
                    case 'premium':
                        gameState.premiumCoin += result.amount;
                        console.log(`PTC +${result.amount}枚 (合計: ${gameState.premiumCoin}枚)`);
                        break;
                    case 'rice':
                        gameState.rice += result.amount;
                        console.log(`お米 +${result.amount}kg (合計: ${gameState.rice}kg)`);
                        break;
                    case 'item':
                        // 既存のインベントリシステムで処理
                        if (!gameState.inventory) {
                            gameState.inventory = {};
                        }
                        if (gameState.inventory[result.id]) {
                            gameState.inventory[result.id] += 1;
                        } else {
                            gameState.inventory[result.id] = 1;
                        }
                        console.log(`アイテム +${result.name}`);
                        break;
                }
            }
            
            // 表示を更新
            updateDisplay();
            updateInventoryDisplay();
        }

        function showGachaResult(results) {
            // 結果を集計・レアリティ別ソート
            const summary = summarizeGachaResults(results);
            
            // オーバーレイ作成
            const overlay = document.createElement('div');
            overlay.className = 'gacha-overlay';
            
            // ポップアップ作成
            const popup = document.createElement('div');
            popup.className = 'gacha-result-popup';
            
            // ポップアップ内容生成
            popup.innerHTML = createGachaResultHTML(summary);
            
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
            
            // クリックで閉じる（手動のみ）
            overlay.addEventListener('click', function() {
                document.body.removeChild(overlay);
            });
        }

        function summarizeGachaResults(results) {
            const summary = {
                cash: 0,
                premium: 0,
                rice: 0,
                items: {}
            };
            
            for (const result of results) {
                switch (result.type) {
                    case 'cash':
                        summary.cash += result.amount;
                        break;
                    case 'premium':
                        summary.premium += result.amount;
                        break;
                    case 'rice':
                        summary.rice += result.amount;
                        break;
                    case 'item':
                        const key = `${result.rarity}-${result.id}`;
                        if (summary.items[key]) {
                            summary.items[key].count += 1;
                        } else {
                            summary.items[key] = {
                                ...result,
                                count: 1
                            };
                        }
                        break;
                }
            }
            
            return summary;
        }

        function createGachaResultHTML(summary) {
            let html = '<div class="gacha-result-title">注文約定一覧</div>';
            
            // 現金表示
            if (summary.cash > 0) {
                html += `<div class="gacha-result-section">`;
                html += `<div class="gacha-rarity-header" style="color: #4caf50;">💴 現金</div>`;
                html += `<div class="gacha-item-list">`;
                html += `<div class="gacha-item">${summary.cash.toLocaleString()}円</div>`;
                html += `</div></div>`;
            }
            
            // プレミアムコイン表示
            if (summary.premium > 0) {
                html += `<div class="gacha-result-section">`;
                html += `<div class="gacha-rarity-header" style="color: #ff9800;">🪙 プレミアムコイン</div>`;
                html += `<div class="gacha-item-list">`;
                html += `<div class="gacha-item">${summary.premium}枚</div>`;
                html += `</div></div>`;
            }
            
            // お米表示
            if (summary.rice > 0) {
                html += `<div class="gacha-result-section">`;
                html += `<div class="gacha-rarity-header" style="color: #8b4513;">🍙 お米</div>`;
                html += `<div class="gacha-item-list">`;
                html += `<div class="gacha-item">${summary.rice}kg</div>`;
                html += `</div></div>`;
            }
            
            // アイテム表示（レアリティ別）
            const itemsByRarity = {};
            for (const item of Object.values(summary.items)) {
                if (!itemsByRarity[item.rarity]) {
                    itemsByRarity[item.rarity] = [];
                }
                itemsByRarity[item.rarity].push(item);
            }
            
            // S, A, B, C順で表示
            const rarities = ['S', 'A', 'B', 'C'];
            for (const rarity of rarities) {
                if (itemsByRarity[rarity]) {
                    html += `<div class="gacha-result-section">`;
                    html += `<div class="gacha-rarity-header rarity-${rarity.toLowerCase()}">${rarity}ランク</div>`;
                    html += `<div class="gacha-item-list">`;
                    
                    for (const item of itemsByRarity[rarity]) {
                        const emoji = item.emoji || '💳';
                        html += `<div class="gacha-item">${emoji}${item.name}　${item.count}枚</div>`;
                    }
                    
                    html += `</div></div>`;
                }
            }
            
            html += '<div class="gacha-close-hint">クリックで閉じる</div>';
            return html;
        }

        function addItemsToInventory(items) {
            // この関数は不要になったが、互換性のため残す
            // processGachaResults()で処理されるため
        }

        function enterPreGachaMode() {
            debugState.isPreGacha = true;
            updateDisplay();
        }

        function exitPreGachaMode() {
            debugState.isPreGacha = false;
            updateDisplay();
        }

        function updateServerHPBar() {
            const serverHPFill = document.getElementById('server-hp-fill');
            if (!serverHPFill) return;

            // HP割合計算
            const hpPercentage = (debugState.serverHP / debugState.maxServerHP) * 100;
            
            // バー幅更新
            serverHPFill.style.width = hpPercentage + '%';
            
            // 色クラス設定
            serverHPFill.className = 'server-hp-fill';
            if (hpPercentage > 50) {
                serverHPFill.classList.add('high');
            } else if (hpPercentage > 25) {
                serverHPFill.classList.add('medium');
            } else {
                serverHPFill.classList.add('low');
            }
        }

        function updateCreditMarginBar() {
            const creditMarginFill = document.getElementById('credit-margin-fill');
            const creditMarginLabel = document.getElementById('credit-margin-label');
            if (!creditMarginFill || !creditMarginLabel) return;

            // 余力計算: 現金残高 × 3.3 - 建玉金額
            const creditMargin = gameState.cash * 3.3 - debugState.positionAmount;
            const maxPositive = gameState.cash * 3.3;

            // パーセンテージ計算
            const marginPercentage = Math.round((creditMargin / maxPositive) * 100);
            
            // ラベル更新
            creditMarginLabel.textContent = `信用建て余力：${marginPercentage}%`;

            // バー表示用の値とクラス決定
            let percentage;
            let className;

            if (creditMargin >= 0) {
                // プラス領域 (0% ～ 100%) - 水色
                percentage = Math.min((creditMargin / maxPositive) * 100, 100);
                className = 'credit-margin-fill positive';
            } else {
                // マイナス領域の段階判定
                const absPercentage = Math.abs(marginPercentage);
                const stage = Math.floor(absPercentage / 100);
                
                // 各段階内での進捗 (0-100%)
                const stageProgress = absPercentage % 100;
                percentage = stageProgress;

                // 段階に応じた色設定
                const colorClasses = [
                    'credit-margin-fill warning',    // 0-100%: 黄色
                    'credit-margin-fill orange',     // 100-200%: オレンジ
                    'credit-margin-fill negative',   // 200-300%: 赤色
                    'credit-margin-fill danger',     // 300-400%: 濃赤色
                    'credit-margin-fill critical'    // 400-500%+: 黒色
                ];

                className = colorClasses[Math.min(stage, colorClasses.length - 1)];
                
                // -500%超えの場合は100%固定
                if (absPercentage >= 500) {
                    percentage = 100;
                }
            }

            creditMarginFill.className = className;
            creditMarginFill.style.width = percentage + '%';
        }

        // ========== アプリ起動 ==========
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>